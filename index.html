<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arepas al Carbon </title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .pulse-hover:hover { animation: pulse 0.6s ease-in-out; }
        .float-animation { animation: float 3s ease-in-out infinite; }
        .gradient-text { background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;
        
        const SUPABASE_URL = 'https://xybyupmrtiyspxlzcaug.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5Ynl1cG1ydGl5c3B4bHpjYXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODk3MDYsImV4cCI6MjA3NTQ2NTcwNn0.EHS9tI0-2vllcfdU-W4zeCVWf7csG24CtVmUbmk7s1M';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const formatCOP = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);

        function Toast({toasts, remove}){
            return (
                <div className="fixed bottom-6 right-6 space-y-2 z-50">
                    {toasts.map(t=> (
                        <div key={t.id} className={`fade-in px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 ${t.type==='success'?'bg-gradient-to-r from-green-500 to-green-600 text-white':t.type==='error'?'bg-gradient-to-r from-red-500 to-red-600 text-white':'bg-gradient-to-r from-yellow-400 to-yellow-500 text-black'}`}>
                            <span className="text-xl">{t.icon}</span>
                            <div className="font-medium">{t.message}</div>
                            <button onClick={()=>remove(t.id)} className="ml-2 opacity-80 hover:opacity-100 text-xl">√ó</button>
                        </div>
                    ))}
                </div>
            );
        }

        function LandingPage({ onEnter }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-100 to-yellow-50 flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-10">
                        <div className="absolute top-20 left-10 text-8xl">üåΩ</div>
                        <div className="absolute bottom-20 right-10 text-8xl">üî•</div>
                        <div className="absolute top-40 right-20 text-6xl">üåæ</div>
                        <div className="absolute bottom-40 left-20 text-6xl">üß°</div>
                    </div>
                    
                    <div className="fade-in text-center relative z-10">
                        <div className="float-animation mb-8">
                            <img src="Arepas.png" alt="Arepas al Carb√≥n" className="w-80 h-80 mx-auto drop-shadow-2xl" />
                        </div>
                        
                        <h1 className="text-5xl md:text-6xl font-bold gradient-text mb-6">Arepas al Carbon</h1>
                        
                        <p className="text-2xl md:text-3xl text-gray-700 font-semibold mb-4 px-4">
                            "Nada m√°s colombiano que una arepa al carb√≥n
                        </p>
                        <p className="text-2xl md:text-3xl text-gray-700 font-semibold mb-12 px-4">
                            hecha con amor del campo"
                        </p>
                        
                        <button 
                            onClick={onEnter}
                            className="bg-gradient-to-r from-amber-600 to-orange-600 text-white px-12 py-5 rounded-full font-bold text-xl hover:from-amber-700 hover:to-orange-700 transition shadow-2xl pulse-hover">
                            üöÄ Entrar pa'voltear la Arepa
                        </button>
                    </div>
                </div>
            );
        }

        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    setError('Credenciales incorrectas');
                    setLoading(false);
                } else {
                    onLogin(data.user);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-100 via-orange-50 to-yellow-100 flex items-center justify-center p-4">
                    <div className="fade-in bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md border-t-8 border-orange-600">
                        <div className="text-center mb-8">
                            <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-5 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center shadow-lg pulse-hover">
                                <span className="text-6xl">üî•</span>
                            </div>
                            <h1 className="text-4xl font-bold gradient-text mb-3">Arepas al Carbon</h1>
                            <p className="text-gray-600 text-lg">Sistema de Gesti√≥n</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">üìß Correo electr√≥nico</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition" placeholder="tu@email.com" required />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">üîí Contrase√±a</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                            </div>

                            {error && (
                                <div className="fade-in bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm flex items-center gap-2">
                                    <span>‚ö†Ô∏è</span> {error}
                                </div>
                            )}

                            <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white p-4 rounded-xl font-bold text-lg hover:from-amber-700 hover:to-orange-700 transition disabled:opacity-50 shadow-lg pulse-hover">
                                {loading ? 'üîÑ Iniciando sesi√≥n...' : 'üöÄ Iniciar Sesi√≥n'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function HistorialCompras({ clientes, ventas, pushToast, loadData, supabaseClient, formatCOP, darkMode }) {
            const [selectedCliente, setSelectedCliente] = useState(null);
            const [abonoTotal, setAbonoTotal] = useState('');

          const calcularDeudaPorCliente = () => {
    const deudas = {};
    
    clientes.filter(c => c.activo !== false).forEach(cliente => {
        const ventasCliente = ventas.filter(v => v.cliente_id === cliente.id && v.estado_pago === 'Pendiente');
        
        if (ventasCliente.length > 0) {
            const fechas = {};
            ventasCliente.forEach(v => {
                let fecha = 'Sin fecha';
                if (v.fecha) {
                    const fechaObj = new Date(v.fecha);
                    const year = fechaObj.getUTCFullYear();
                    const month = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(fechaObj.getUTCDate()).padStart(2, '0');
                    fecha = `${day}/${month}/${year}`;
                }
                
                const deuda = (parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0);
                
                if (!fechas[fecha]) {
                    fechas[fecha] = { fecha, deuda: 0, ventas: [] };
                }
                fechas[fecha].deuda += deuda;
                fechas[fecha].ventas.push(v);
            });
            
            const fechasArray = Object.values(fechas).sort((a, b) => {
                if (a.fecha === 'Sin fecha') return 1;
                if (b.fecha === 'Sin fecha') return -1;
                return new Date(a.ventas[0].fecha) - new Date(b.ventas[0].fecha);
            });
            const totalDeuda = fechasArray.reduce((sum, f) => sum + f.deuda, 0);
            
            if (totalDeuda > 0) {
                deudas[cliente.id] = {
                    cliente,
                    fechas: fechasArray,
                    totalDeuda,
                    cantidadFechas: fechasArray.length
                };
            }
        }
    });
    
    return deudas;
};

           const handleAbonoTotal = async () => {
    if (!selectedCliente || !abonoTotal) {
        pushToast('Ingresa un monto v√°lido', 'error');
        return;
    }

    const monto = parseFloat(abonoTotal);
    if (isNaN(monto) || monto <= 0) {
        pushToast('Ingresa un monto v√°lido', 'error');
        return;
    }

    const deudaInfo = deudas[selectedCliente];
    if (monto > deudaInfo.totalDeuda) {
        pushToast('El abono no puede ser mayor a la deuda total', 'error');
        return;
    }

    let montoRestante = monto;
    const ventasActualizadas = [];
    
    try {
        for (const fechaInfo of deudaInfo.fechas) {
            if (montoRestante <= 0) break;
            
            for (const venta of fechaInfo.ventas) {
                if (montoRestante <= 0) break;
                
                const deudaVenta = (parseFloat(venta.total) || 0) - (parseFloat(venta.abono) || 0);
                const abonoVenta = Math.min(montoRestante, deudaVenta);
                const nuevoAbono = (parseFloat(venta.abono) || 0) + abonoVenta;
                const nuevoEstado = nuevoAbono >= parseFloat(venta.total) ? 'Pagado' : 'Pendiente';
                
                // Actualizar la venta
                const { error: errorVenta } = await supabaseClient.from('ventas').update({
                    abono: nuevoAbono,
                    estado_pago: nuevoEstado
                }).eq('id', venta.id);
                
                if (errorVenta) {
                    console.error('Error actualizando venta:', errorVenta);
                    pushToast('Error al actualizar venta', 'error');
                    continue;
                }
                
                // Registrar el ingreso
                const { data: ingresoData, error: errorIngreso } = await supabaseClient.from('ingresos').insert({
                    concepto: `Abono - ${deudaInfo.cliente.nombre} [ID:${venta.id}]`,
                    monto: abonoVenta,
                    categoria: 'Abono',
                    fecha: new Date().toISOString(),
                    notas: `venta_id:${venta.id}`
                }).select();
                
                if (errorIngreso) {
                    console.error('Error registrando ingreso:', errorIngreso);
                    pushToast('Error al registrar ingreso: ' + errorIngreso.message, 'error');
                } else {
                    console.log('‚úÖ Ingreso registrado:', ingresoData);
                    ventasActualizadas.push({id: venta.id, monto: abonoVenta});
                }
                
                montoRestante -= abonoVenta;
            }
        }

        if (ventasActualizadas.length > 0) {
            pushToast(`‚úÖ Abono de ${formatCOP(monto)} aplicado a ${ventasActualizadas.length} venta(s)`);
        } else {
            pushToast('No se pudieron aplicar los abonos', 'error');
        }
        
        setAbonoTotal('');
        setSelectedCliente(null);
        await loadData();
        
    } catch (err) {
        console.error('Error en handleAbonoTotal:', err);
        pushToast('Error al procesar el abono', 'error');
    }
};
            const deudas = calcularDeudaPorCliente();
            const clientesConDeuda = Object.values(deudas).sort((a, b) => 
             a.cliente.nombre.localeCompare(b.cliente.nombre, 'es', { sensitivity: 'base' })
);
            return (
                <div className="space-y-6 fade-in">
                   <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-purple-500`}>
                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                            <span>üìã</span> Historial de Compras y Deudas por Fecha
                        </h2>
                        
                        {clientesConDeuda.length === 0 ? (
                            <div className="text-center py-12">
                                <span className="text-6xl mb-4 block">‚úÖ</span>
                                <p className="text-xl text-gray-600 font-semibold">¬°No hay deudas pendientes!</p>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {clientesConDeuda.map(deudaInfo => (
                                   <div key={deudaInfo.cliente.id} className={`border-2 ${darkMode ? 'border-gray-600 bg-gray-750' : 'border-gray-200 bg-white'} rounded-xl p-6 hover:border-orange-300 transition`}>
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{deudaInfo.cliente.nombre}</h3>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Debe en {deudaInfo.cantidadFechas} fecha(s)</p>
                                            </div>
                                            <div className="text-right">
                                               <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'} mb-1`}>Total Deuda</p>
                                                <p className="text-3xl font-bold text-red-600">{formatCOP(deudaInfo.totalDeuda)}</p>
                                            </div>
                                        </div>

                                        <div className="space-y-3 mb-4">
                                            {deudaInfo.fechas.map((fechaInfo, idx) => (
                                               <div key={idx} className={`${darkMode ? 'bg-red-900/30' : 'bg-red-50'} p-4 rounded-lg border-l-4 border-red-500`}>
                                                    <div className="flex justify-between items-center mb-2">
                                                       <span className={`font-semibold ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>üìÖ {fechaInfo.fecha}</span>
                                                        <span className="font-bold text-red-600">{formatCOP(fechaInfo.deuda)}</span>
                                                    </div>
                                                    <div className="space-y-2 mt-3">
                                                        {fechaInfo.ventas.map((venta, vIdx) => (
                                                            <div key={vIdx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 rounded-lg text-sm`}>
                                                                <div className="flex justify-between items-center">
                                                                    <div>
                                                                       <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Semana: </span>
                                                                       <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{venta.semana || 'N/A'}</span>
                                                                        <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} ml-3`}>Cantidad: </span>
                                                                       <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{venta.cantidad} {venta.tipo_cantidad}</span>
                                                                    </div>
                                                                    <div className="text-right">
                                                                     <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Total: {formatCOP(venta.total)}</p>
                                                                        <p className="text-xs text-blue-600">Abonado: {formatCOP(venta.abono || 0)}</p>
                                                                        <p className="text-xs text-red-600 font-bold">Debe: {formatCOP((parseFloat(venta.total) || 0) - (parseFloat(venta.abono) || 0))}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {selectedCliente === deudaInfo.cliente.id ? (
                                            <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-300">
                                                <label className="block text-sm font-semibold text-blue-700 mb-2">
                                                    üí∞ Monto a abonar (se aplicar√° desde la fecha m√°s antigua)
                                                </label>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="number"
                                                        value={abonoTotal}
                                                        onChange={(e) => setAbonoTotal(e.target.value)}
                                                        placeholder="Ingresa el monto"
                                                        className="flex-1 p-3 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <button
                                                        onClick={handleAbonoTotal}
                                                        className="px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">
                                                        ‚úÖ Aplicar
                                                    </button>
                                                    <button
                                                        onClick={() => {setSelectedCliente(null); setAbonoTotal('');}}
                                                        className="px-6 py-3 bg-gray-400 text-white rounded-lg font-bold hover:bg-gray-500 transition">
                                                        ‚ùå
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={() => setSelectedCliente(deudaInfo.cliente.id)}
                                                className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg font-bold hover:from-blue-600 hover:to-blue-700 transition">
                                                üí∞ Abonar a la deuda total
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function App(){
            const [showLanding, setShowLanding] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [clientes, setClientes] = useState([]);
            const [ventas, setVentas] = useState([]);
            const [ingresos, setIngresos] = useState([]);
            const [egresos, setEgresos] = useState([]);
            const [toasts, setToasts] = useState([]);

            const [clienteForm, setClienteForm] = useState({nombre:'',direccion:'',tipo_cliente:'Individual',dia_entrega:'',precio_especial:'',notas:''});
            const [ventaForm, setVentaForm] = useState({cliente_id:'',semana:'',tipo_venta:'Individual',cantidad:'',tipo_cantidad:'Unidades',precio_unitario:'',precio_sugerido:'',total:'',estado_pago:'Pendiente',fecha:'',payment_type:'Total',abono:'',notas:''});
            const [ingresoForm, setIngresoForm] = useState({concepto:'',monto:'',categoria:'',fecha:''});
            const [egresoForm, setEgresoForm] = useState({concepto:'',monto:'',categoria:'',fecha:''});
            const [filterDate, setFilterDate] = useState('');
            const [filterEstado, setFilterEstado] = useState('Todos');
            const [notaModal, setNotaModal] = useState(null);
            const [pedidosProgramados, setPedidosProgramados] = useState([]);
            const [pedidoForm, setPedidoForm] = useState({fecha:'',cliente_id:'',cantidad:'',tipo_cantidad:'Unidades',notas:''});
            const [fechaSeleccionadaPedidos, setFechaSeleccionadaPedidos] = useState('');
            const [ordenAlfabetico, set0rdenAlfabetico] = useState(false);
            const [ordenAlfabeticoClientes, setOrdenAlfabeticoClientes] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [clienteSeleccionado, setClienteSeleccionado] = useState(null);
            const [mostrarPerfilCliente, setMostrarPerfilCliente] = useState(false);
            const [resDesde, setResDesde] = useState('');
            const [resHasta, setResHasta] = useState('');

            const pushToast = (msg, type='success')=>{ const id = Date.now()+Math.random(); const icon = type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ö†Ô∏è'; setToasts(t=>[...t,{id,message:msg,type,icon}]); setTimeout(()=>setToasts(t=>t.filter(x=>x.id!==id)),5000); };
            const removeToast = (id)=> setToasts(t=>t.filter(x=>x.id!==id));

            useEffect(()=>{ checkUserAndLoad(); }, []);

            const checkUserAndLoad = async ()=>{
                setLoading(true);
                const { data:{ session } } = await supabaseClient.auth.getSession();
                setUser(session?.user || null);
                if(session?.user) await loadData();
                setLoading(false);
            };

            const loadData = async ()=>{
                try{
                    const { data: cl } = await supabaseClient.from('clientes').select('*').order('created_at',{ascending:false});
                    const { data: vs } = await supabaseClient.from('ventas').select('*, clientes(nombre)').order('fecha',{ascending:false});
                    const { data: ing } = await supabaseClient.from('ingresos').select('*').order('fecha',{ascending:false});
                    const { data: egr } = await supabaseClient.from('egresos').select('*').order('fecha',{ascending:false});
                    const { data: ped } = await supabaseClient.from('pedidos_programados').select('*, clientes(nombre)').order('fecha',{ascending:true});
                    setPedidosProgramados(ped||[]);
                    setClientes(cl||[]);
                    setVentas(vs||[]);
                    setIngresos(ing||[]);
                    setEgresos(egr||[]);
                }catch(err){ console.error(err); pushToast('Error cargando datos','error'); }
            };

            const handleLogout = async () => { await supabaseClient.auth.signOut(); setUser(null); setShowLanding(true); pushToast('Sesi√≥n cerrada'); };

            const addCliente = async (e)=>{ 
                e.preventDefault(); 
                const payload = {
                    nombre: clienteForm.nombre,
                    direccion: clienteForm.direccion || null,
                    tipo_cliente: clienteForm.tipo_cliente,
                    dia_entrega: clienteForm.dia_entrega || null,
                    precio_especial: clienteForm.precio_especial ? parseFloat(clienteForm.precio_especial) : null,
                    notas: clienteForm.notas || null,
                    activo: true
                };
                const { data, error } = await supabaseClient.from('clientes').insert(payload).select();
                if(error) { 
                    console.error('ERROR CLIENTE:', error);
                    pushToast('Error: ' + error.message,'error'); 
                } else { 
                    pushToast('‚úÖ Cliente agregado'); 
                    setClienteForm({nombre:'',direccion:'',tipo_cliente:'Individual',dia_entrega:'',precio_especial:'',notas:''}); 
                    loadData(); 
                } 
            };

            const updateTipoCliente = async (id, tipo) => { 
                const { error } = await supabaseClient.from('clientes').update({tipo_cliente:tipo}).eq('id', id);
                if(error) {
                    console.error('ERROR UPDATE:', error);
                    pushToast('Error al actualizar','error');
                } else {
                    setClientes(cs=>cs.map(c=>c.id===id?{...c,tipo_cliente:tipo}:c)); 
                    pushToast('Tipo actualizado');
                }
            };

            const deleteCliente = async (id)=>{ 
                if(!confirm('¬øEliminar cliente?')) return; 
                const { error } = await supabaseClient.from('clientes').update({activo:false}).eq('id',id); 
                if(error) {
                    console.error('ERROR DELETE:', error);
                    pushToast('Error al eliminar','error');
                } else {
                    pushToast('Cliente eliminado','error'); 
                    loadData();
                }
            };

            useEffect(()=>{
                if(ventaForm.cantidad && ventaForm.tipo_cantidad){
                    const cantidad = parseInt(ventaForm.cantidad)||0;
                    const sugerido = ventaForm.tipo_cantidad==='Unidades' ? cantidad * 600 : cantidad * 6000;
                    setVentaForm(v=>({...v,precio_unitario:ventaForm.tipo_cantidad==='Unidades'?600:6000,precio_sugerido:sugerido}));
                }
            },[ventaForm.cantidad, ventaForm.tipo_cantidad]);

            const addVenta = async (e)=>{ 
                e.preventDefault(); 
                const total = parseFloat(ventaForm.total)||0; 
                const abono = parseFloat(ventaForm.abono)||0; 
                const fechaISO = ventaForm.fecha ? new Date(ventaForm.fecha).toISOString() : new Date().toISOString(); 
                const payload = { 
                    cliente_id: parseInt(ventaForm.cliente_id), 
                    semana: ventaForm.semana || null, 
                    tipo_venta: ventaForm.tipo_venta, 
                    cantidad: parseInt(ventaForm.cantidad)||0, 
                    tipo_cantidad: ventaForm.tipo_cantidad, 
                    precio_unitario: parseFloat(ventaForm.precio_unitario)||0, 
                    total: total, 
                    estado_pago: ventaForm.estado_pago, 
                    fecha: fechaISO, 
                    payment_type: ventaForm.payment_type, 
                    abono: abono, 
                    notas: ventaForm.notas || null, 
                    usuario_id: user?.id 
                }; 
                const { data: ventaCreada, error } = await supabaseClient.from('ventas').insert(payload).select();
if(error){ 
    console.error('ERROR VENTA:', error);
    pushToast('Error: ' + error.message,'error'); 
    return; 
}

// Obtener el ID de la venta reci√©n creada
const ventaId = ventaCreada?.[0]?.id;

// Registrar ingreso si est√° pagado completamente
if(ventaForm.estado_pago==='Pagado' && ventaId){ 
    await supabaseClient.from('ingresos').insert({
        concepto:`Venta - ${clienteDisplay(ventaForm.cliente_id)} [ID:${ventaId}]`,
        monto:total,
        categoria:'Venta',
        fecha:fechaISO,
        notas: `venta_id:${ventaId}`
    }).select(); 
} 
// Registrar ingreso por abono parcial
else if(abono>0 && ventaId){ 
    await supabaseClient.from('ingresos').insert({
        concepto:`Abono - ${clienteDisplay(ventaForm.cliente_id)} [ID:${ventaId}]`,
        monto:abono,
        categoria:'Abono',
        fecha:fechaISO,
        notas: `venta_id:${ventaId}`
    }).select(); 
}

pushToast('‚úÖ Venta registrada'); 
setVentaForm({cliente_id:'',semana:'',tipo_venta:'Individual',cantidad:'',tipo_cantidad:'Unidades',precio_unitario:'',precio_sugerido:'',total:'',estado_pago:'Pendiente',fecha:'',payment_type:'Total',abono:'',notas:''}); 
loadData();
            };

            const deleteVenta = async (id)=>{ 
                if(!confirm('¬øEliminar venta?')) return; 
                const { error } = await supabaseClient.from('ventas').delete().eq('id',id); 
                if(error) {
                    console.error('ERROR DELETE VENTA:', error);
                    pushToast('Error al eliminar','error');
                } else {
                    pushToast('Venta eliminada','error'); 
                    loadData();
                }
            };

            const setPagoVenta = async (v, action, abonoMonto=0)=>{ 
                const total = parseFloat(v.total)||0; 
                const actualAbono = parseFloat(v.abono)||0; 
                if(action==='Pagado'){ 
                    const { error } = await supabaseClient.from('ventas').update({estado_pago:'Pagado',abono:total}).eq('id',v.id); 
                    if(error) { 
                        console.error('Error al actualizar:', error);
                        pushToast('Error: ' + error.message,'error'); 
                        return;
                    }
                   await supabaseClient.from('ingresos').insert({
    concepto:`Venta - ${v.clientes?.nombre} [ID:${v.id}]`,
    monto:total-actualAbono,
    categoria:'Venta',
    fecha:new Date().toISOString(),
    notas: `venta_id:${v.id}`
}).select(); 
                    pushToast('‚úÖ Marcado como pagado'); 
                } else if(action==='Abono'){ 
                    const nuevoAbono = actualAbono + (parseFloat(abonoMonto)||0); 
                    const nuevoEstado = (total - nuevoAbono) <= 0 ? 'Pagado' : 'Pendiente'; 
                    const { error } = await supabaseClient.from('ventas').update({abono:nuevoAbono,estado_pago:nuevoEstado}).eq('id',v.id); 
                    if(error) { 
                        console.error('Error al actualizar abono:', error);
                        pushToast('Error: ' + error.message,'error'); 
                        return;
                    }
                    await supabaseClient.from('ingresos').insert({
    concepto:`Abono - ${v.clientes?.nombre} [ID:${v.id}]`,
    monto:parseFloat(abonoMonto)||0,
    categoria:'Abono',
    fecha:new Date().toISOString(),
    notas: `venta_id:${v.id}`
}).select();
                    pushToast('üí∞ Abono registrado'); 
                } else { 
                    const { error } = await supabaseClient.from('ventas').update({estado_pago:'Pendiente',abono:0}).eq('id',v.id); 
                    if(error) { 
                        console.error('Error:', error);
                        pushToast('Error: ' + error.message,'error'); 
                        return;
                    }
                    pushToast('‚è≥ Marcado pendiente'); 
                } 
                await loadData(); 
            };

            const updateFechaVenta = async (id, fecha) => { 
                const fechaISO = fecha ? new Date(fecha).toISOString() : null; 
                const { error } = await supabaseClient.from('ventas').update({ fecha: fechaISO }).eq('id', id); 
                if(error) {
                    console.error('ERROR UPDATE FECHA:', error);
                    pushToast('Error al actualizar','error');
                } else {
                    pushToast('Fecha actualizada'); 
                    loadData();
                }
            };

            const addIngreso = async (e)=>{ 
                e.preventDefault(); 
                const fechaISO = ingresoForm.fecha ? new Date(ingresoForm.fecha).toISOString() : new Date().toISOString(); 
                const payload = { concepto: ingresoForm.concepto, monto: parseFloat(ingresoForm.monto)||0, categoria: ingresoForm.categoria || null, fecha: fechaISO };
                const { error } = await supabaseClient.from('ingresos').insert(payload).select(); 
                if(error){ 
                    console.error('ERROR INGRESO:', error);
                    pushToast('Error: ' + error.message,'error'); 
                } else { 
                    pushToast('‚úÖ Ingreso agregado'); 
                    setIngresoForm({concepto:'',monto:'',categoria:'',fecha:''}); 
                    loadData(); 
                } 
            };

            const addEgreso = async (e)=>{ 
                e.preventDefault(); 
                const fechaISO = egresoForm.fecha ? new Date(egresoForm.fecha).toISOString() : new Date().toISOString(); 
                const payload = { concepto: egresoForm.concepto, monto: parseFloat(egresoForm.monto)||0, categoria: egresoForm.categoria || null, fecha: fechaISO };
                const { error } = await supabaseClient.from('egresos').insert(payload).select(); 
                if(error){ 
                    console.error('ERROR EGRESO:', error);
                    pushToast('Error: ' + error.message,'error'); 
                } else { 
                    pushToast('‚úÖ Egreso agregado'); 
                    setEgresoForm({concepto:'',monto:'',categoria:'',fecha:''}); 
                    loadData(); 
                } 
            };
            const deleteIngreso = async (id)=>{ 
    if(!confirm('¬øEliminar? Si es un abono, se descontar√° de la venta correspondiente.')) return; 
    
    // Obtener el ingreso
    const { data: ingreso, error: errorGet } = await supabaseClient
        .from('ingresos')
        .select('*')
        .eq('id', id)
        .single();
    
    if(errorGet) {
        console.error('ERROR AL OBTENER INGRESO:', errorGet);
        pushToast('Error al obtener datos', 'error');
        return;
    }
    
    // Si es un abono o venta, intentar actualizar la venta correspondiente
    if(ingreso && (ingreso.categoria === 'Abono' || ingreso.categoria === 'Venta')) {
        let ventaId = null;
        
        // M√©todo 1: Buscar en las notas
        if(ingreso.notas && ingreso.notas.includes('venta_id:')) {
            ventaId = parseInt(ingreso.notas.split('venta_id:')[1]);
        }
        // M√©todo 2: Buscar en el concepto (formato [ID:123])
if(!ventaId && ingreso.concepto && ingreso.concepto.includes('[ID:')) {
    const match = ingreso.concepto.match(/\[ID:(\d+)\]/);
    if(match) ventaId = parseInt(match[1]);
}

// M√©todo 3: Buscar formato antiguo "Venta ID:"
if(!ventaId && ingreso.concepto && ingreso.concepto.includes('Venta ID:')) {
    const match = ingreso.concepto.match(/Venta ID:\s*(\d+)/);
    if(match) ventaId = parseInt(match[1]);
}
       
        
        if(ventaId) {
            // Obtener la venta
            const { data: venta } = await supabaseClient
                .from('ventas')
                .select('*')
                .eq('id', ventaId)
                .single();
            
            if(venta) {
                const montoADescontar = parseFloat(ingreso.monto) || 0;
                const abonoActual = parseFloat(venta.abono) || 0;
                const totalVenta = parseFloat(venta.total) || 0;
                const nuevoAbono = Math.max(0, abonoActual - montoADescontar);
                const nuevoEstado = nuevoAbono >= totalVenta ? 'Pagado' : 'Pendiente';
                
                const { error: errorUpdate } = await supabaseClient
                    .from('ventas')
                    .update({
                        abono: nuevoAbono,
                        estado_pago: nuevoEstado
                    })
                    .eq('id', ventaId);
                
                if(!errorUpdate) {
                    console.log(`‚úÖ Abono actualizado en venta ${ventaId}: $${abonoActual} -> $${nuevoAbono}`);
                } else {
                    console.error('Error al actualizar venta:', errorUpdate);
                }
            }
        } else {
            console.log('‚ö†Ô∏è No se encontr√≥ ID de venta asociada a este ingreso');
        }
    }
    
    // Eliminar el ingreso
    const { error } = await supabaseClient.from('ingresos').delete().eq('id', id); 
    
    if(error) {
        console.error('ERROR DELETE INGRESO:', error);
        pushToast('Error al eliminar', 'error');
    } else {
        pushToast('‚úÖ Eliminado correctamente', 'success'); 
        await loadData();
    }
};
           

            const deleteEgreso = async (id)=>{ 
                if(!confirm('¬øEliminar?')) return; 
                const { error } = await supabaseClient.from('egresos').delete().eq('id',id); 
                if(error) {
                    console.error('ERROR DELETE EGRESO:', error);
                    pushToast('Error','error');
                } else {
                    pushToast('Eliminado','error'); 
                    loadData();
                }
            };
            const addPedido = async (e) => {
    e.preventDefault();
    const payload = {
        fecha: new Date(pedidoForm.fecha).toISOString(),
        cliente_id: parseInt(pedidoForm.cliente_id),
        cantidad: parseInt(pedidoForm.cantidad),
        tipo_cantidad: pedidoForm.tipo_cantidad,
        notas: pedidoForm.notas || null,
        procesado: false
    };
    const { error } = await supabaseClient.from('pedidos_programados').insert(payload).select();
    if(error) {
        console.error('ERROR PEDIDO:', error);
        pushToast('Error: ' + error.message, 'error');
    } else {
        pushToast('‚úÖ Pedido agregado');
        setPedidoForm({fecha:'',cliente_id:'',cantidad:'',tipo_cantidad:'Unidades',notas:''});
        loadData();
    }
};

const deletePedido = async (id) => {
    if(!confirm('¬øEliminar pedido?')) return;
    const { error } = await supabaseClient.from('pedidos_programados').delete().eq('id', id);
    if(error) {
        console.error('ERROR DELETE PEDIDO:', error);
        pushToast('Error', 'error');
    } else {
        pushToast('Pedido eliminado', 'error');
        loadData();
    }
};

const procesarPedidosFecha = async (fecha) => {
    if(!confirm(`¬øConvertir todos los pedidos del ${fecha} en ventas?`)) return;
    
    const pedidosFecha = pedidosProgramados.filter(p => 
        p.fecha && p.fecha.slice(0,10) === fecha && !p.procesado
    );
    
    if(pedidosFecha.length === 0) {
        pushToast('No hay pedidos para procesar', 'warning');
        return;
    }
    
    try {
        for(const pedido of pedidosFecha) {
            const precioUnitario = pedido.tipo_cantidad === 'Unidades' ? 600 : 6000;
            const total = pedido.cantidad * precioUnitario;
            
            // Crear venta
            const ventaPayload = {
                cliente_id: pedido.cliente_id,
                cantidad: pedido.cantidad,
                tipo_cantidad: pedido.tipo_cantidad,
                precio_unitario: precioUnitario,
                total: total,
                estado_pago: 'Pendiente',
                fecha: new Date(pedido.fecha).toISOString(),
                abono: 0,
                notas: pedido.notas ? `[Pedido programado] ${pedido.notas}` : '[Pedido programado]',
                usuario_id: user?.id
            };
            
            await supabaseClient.from('ventas').insert(ventaPayload).select();
            
            // Marcar pedido como procesado
            await supabaseClient.from('pedidos_programados').update({procesado: true}).eq('id', pedido.id);
        }
        
        pushToast(`‚úÖ ${pedidosFecha.length} pedido(s) convertidos en ventas`);
        loadData();
    } catch(err) {
        console.error('Error procesando pedidos:', err);
        pushToast('Error al procesar pedidos', 'error');
    }
};

const limpiarListaFecha = async (fecha) => {
    if(!confirm(`¬øEliminar TODOS los pedidos del ${fecha}?`)) return;
    
    const pedidosFecha = pedidosProgramados.filter(p => 
        p.fecha && p.fecha.slice(0,10) === fecha
    );
    
    try {
        for(const pedido of pedidosFecha) {
            await supabaseClient.from('pedidos_programados').delete().eq('id', pedido.id);
        }
        pushToast(`‚úÖ Lista del ${fecha} eliminada`);
        setFechaSeleccionadaPedidos('');
        loadData();
    } catch(err) {
        console.error('Error:', err);
        pushToast('Error al limpiar lista', 'error');
    }
};
const abrirPerfilCliente = (cliente) => {
    setClienteSeleccionado(cliente);
    setMostrarPerfilCliente(true);
};

            const clienteDisplay = (id)=>{ const c = clientes.find(x=>x.id===parseInt(id)); return c?.nombre||'Cliente'; };
            const ventasFiltradas = ventas.filter(v=>{ 
    if(filterDate){ 
        if(!v.fecha) return false; 
        if(v.fecha.slice(0,10)!==filterDate) return false; 
    } 
    if(filterEstado==='Pagadas') return v.estado_pago==='Pagado'; 
    if(filterEstado==='Pendientes') return v.estado_pago==='Pendiente'; 
    return true; 
}).sort((a, b) => {
    if(ordenAlfabetico) {
        return (a.clientes?.nombre || '').localeCompare(b.clientes?.nombre || '', 'es', { sensitivity: 'base' });
    }
    return 0;
});

            const calcularResumen = () => {
                const desde = resDesde ? new Date(resDesde) : new Date('2000-01-01');
                const hasta = resHasta ? new Date(resHasta) : new Date();
                const filtrarFecha = (f) => { const fecha = new Date(f); return fecha >= desde && fecha <= hasta; };
                const ventasFil = ventas.filter(v=>v.fecha && filtrarFecha(v.fecha));
                const ingFil = ingresos.filter(i=>i.fecha && filtrarFecha(i.fecha));
                const egrFil = egresos.filter(e=>e.fecha && filtrarFecha(e.fecha));
                const totalVentas = ventasFil.reduce((s,v)=>(s + (parseFloat(v.total)||0)),0);
                const totalAbonos = ventasFil.reduce((s,v)=>(s + (parseFloat(v.abono)||0)),0);
                const totalSaldo = totalVentas - totalAbonos;
                const totalIngresos = ingFil.reduce((s,i)=>(s + (parseFloat(i.monto)||0)),0);
                const totalEgresos = egrFil.reduce((s,e)=>(s + (parseFloat(e.monto)||0)),0);
                return { totalVentas, totalAbonos, totalSaldo, totalIngresos, totalEgresos };
            };

            const resumen = calcularResumen();
            const totalIngresosGlobal = ingresos.reduce((s,i)=>s+(parseFloat(i.monto)||0),0);
            const totalEgresosGlobal = egresos.reduce((s,e)=>s+(parseFloat(e.monto)||0),0);
            const balanceGlobal = totalIngresosGlobal - totalEgresosGlobal;
            const ventasPendientes = ventas.filter(v=>v.estado_pago==='Pendiente').reduce((s,v)=>s+(parseFloat(v.total)||0)-(parseFloat(v.abono)||0),0);

            if(showLanding) return <LandingPage onEnter={() => setShowLanding(false)} />;
            if(loading) return <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-amber-100 to-orange-100"><div className="text-center"><div className="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-orange-600"></div><p className="mt-4 text-xl font-semibold text-gray-700">Cargando...</p></div></div>;
            if(!user) return <LoginPage onLogin={setUser} />;

            return (
                    <div className={`min-h-screen transition-colors duration-300 ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50'}`}>
                    <div className="bg-gradient-to-r from-amber-700 via-orange-600 to-yellow-600 text-white p-4 shadow-2xl sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-white/20 backdrop-blur-sm p-3 rounded-full shadow-lg pulse-hover">
                                    <span className="text-4xl">ü´ì</span>
                                </div>
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold">Arepas al Carbon üåΩü´ì</h1>
                                    <p className="text-amber-100 text-sm">Aqui to`cuadra... menos la dieta  üòÇ   Facturamos en brasa, compae </p>
                                </div>
                            </div>
                          <div className="flex gap-3">
    <button 
        onClick={() => setDarkMode(!darkMode)} 
        className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium transition backdrop-blur-sm">
        {darkMode ? 'üî• Calent√° la arepa, ve' : '‚ò†Ô∏è Ya, que huele a quemao'}
    </button>
    <button onClick={handleLogout} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium transition backdrop-blur-sm">üö™ Salir</button>
</div>
                        </div>
                    </div>

                    <div className="flex border-b bg-white shadow-lg sticky top-16 z-10 overflow-x-auto">
                        {[
                            {id:'dashboard',label:'Inicio',icon:'üìä'},
                            {id:'clientes',label:'Clientes',icon:'üë•'},
                            {id:'ventas',label:'Ventas',icon:'üõí'},
                            {id:'historial',label:'Historial Compras',icon:'üìã'},
                            {id:'pedidos',label:'Pedidos Programados',icon:'üìÖ'},
                            {id:'contabilidad',label:'Contabilidad',icon:'üí∞'},
                            {id:'resumen',label:'Resumen',icon:'üìà'}
                        ].map(tab => (
                            <button key={tab.id} onClick={()=>{setActiveTab(tab.id);setFilterDate('');setFilterEstado('Todos');}} className={`flex items-center gap-2 px-6 py-4 font-semibold transition-all whitespace-nowrap ${activeTab===tab.id?'border-b-4 border-orange-600 text-orange-600 bg-orange-50':'text-gray-600 hover:text-orange-600 hover:bg-amber-50'}`}>
                                <span className="text-xl">{tab.icon}</span>{tab.label}
                            </button>
                        ))}
                    </div>

                    <div className={`max-w-7xl mx-auto p-4 md:p-6 ${darkMode ? 'text-white' : ''}`}>
                        {activeTab==='dashboard' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition pulse-hover">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <p className="text-blue-100 text-sm font-medium">Clientes Activos</p>
                                                <p className="text-4xl font-bold mt-2">{clientes.filter(c=>c.activo!==false).length}</p>
                                            </div>
                                            <span className="text-5xl opacity-80">üë•</span>
                                        </div>
                                        <div className="text-xs text-blue-100">{clientes.filter(c=>c.tipo_cliente==='Contrato').length} contratos</div>
                                    </div>

                                    <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition pulse-hover">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <p className="text-green-100 text-sm font-medium">Ingresos</p>
                                                <p className="text-2xl font-bold mt-2">{formatCOP(totalIngresosGlobal)}</p>
                                            </div>
                                            <span className="text-5xl opacity-80">üíµ</span>
                                        </div>
                                        <div className="text-xs text-green-100">{ingresos.length} registros</div>
                                    </div>

                                    <div className="bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition pulse-hover">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <p className="text-amber-100 text-sm font-medium">Balance</p>
                                                <p className="text-2xl font-bold mt-2">{formatCOP(balanceGlobal)}</p>
                                            </div>
                                            <span className="text-5xl opacity-80">üí∞</span>
                                        </div>
                                        <div className="text-xs text-amber-100">Total neto</div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-2xl shadow-xl border-l-8 border-orange-500">
                                       <h3 className={`text-xl font-bold mb-4 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}><span>üìä</span> Resumen de Ventas</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between p-4 bg-orange-50 rounded-xl">
                                           <span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-900'}`}>Total Ventas</span>
                                                <span className="font-bold text-orange-600">{formatCOP(ventas.reduce((s,v)=>s+(parseFloat(v.total)||0),0))}</span>
                                            </div>
                                            <div className="flex justify-between p-4 bg-green-50 rounded-xl">
                                               <span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-900'}`}>Pagadas</span>
                                                <span className="font-bold text-green-600">{formatCOP(ventas.filter(v=>v.estado_pago==='Pagado').reduce((s,v)=>s+(parseFloat(v.total)||0),0))}</span>
                                            </div>
                                            <div className="flex justify-between p-4 bg-red-50 rounded-xl">
                                                    <span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-900'}`}>Pendientes</span>
                                                <span className="font-bold text-red-600">{formatCOP(ventasPendientes)}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-2xl shadow-xl border-l-8 border-blue-500">
                                      <h3 className={`text-xl font-bold mb-4 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}><span>‚è≥</span> Pagos Pendientes</h3>
                                        <div className="space-y-2 max-h-64 overflow-y-auto">
                                            {ventas.filter(v=>v.estado_pago==='Pendiente').slice(0,6).map(v=>(
                                                <div key={v.id} className="flex justify-between items-center p-3 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition">
                                                    <div>
                                                       <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{v.clientes?.nombre}</p>
                                                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{v.cantidad} {v.tipo_cantidad}</p>
                                                    </div>
                                                    <span className="font-bold text-red-600">{formatCOP((parseFloat(v.total)||0)-(parseFloat(v.abono)||0))}</span>
                                                </div>
                                            ))}
                                            {ventas.filter(v=>v.estado_pago==='Pendiente').length===0 && <p className="text-center py-8 text-gray-400">‚úÖ Todo al d√≠a</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab==='clientes' && (
                            <div className="space-y-6 fade-in">
                              <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-green-500`}>
                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>‚ûï</span> Agregar Cliente</h2>
                                    <form onSubmit={addCliente} className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <input value={clienteForm.nombre} onChange={(e)=>setClienteForm({...clienteForm,nombre:e.target.value})} placeholder="Nombre completo *" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
                                        <input value={clienteForm.direccion} onChange={(e)=>setClienteForm({...clienteForm,direccion:e.target.value})} placeholder="Direcci√≥n" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                        <select value={clienteForm.tipo_cliente} onChange={(e)=>setClienteForm({...clienteForm,tipo_cliente:e.target.value})} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                            <option value="Individual">Individual</option>
                                            <option value="Contrato">Contrato</option>
                                        </select>
                                        <select value={clienteForm.dia_entrega} onChange={(e)=>setClienteForm({...clienteForm,dia_entrega:e.target.value})} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                            <option value="">D√≠a de entrega</option>
                                            <option value="Lunes">Lunes</option>
                                            <option value="Martes">Martes</option>
                                            <option value="Mi√©rcoles">Mi√©rcoles</option>
                                            <option value="Jueves">Jueves</option>
                                            <option value="Viernes">Viernes</option>
                                            <option value="S√°bado">S√°bado</option>
                                            <option value="Domingo">Domingo</option>
                                        </select>
                                        <input value={clienteForm.precio_especial} onChange={(e)=>setClienteForm({...clienteForm,precio_especial:e.target.value})} placeholder="Precio especial" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                        <input value={clienteForm.notas} onChange={(e)=>setClienteForm({...clienteForm,notas:e.target.value})} placeholder="Notas adicionales" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                        <button type="submit" className="md:col-span-3 bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl font-bold text-lg hover:from-green-600 hover:to-green-700 transition shadow-lg pulse-hover">‚úÖ Agregar Cliente</button>
                                    </form>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                  <div className="flex justify-between items-center mb-6">
    <h2 className="text-2xl font-bold">Lista de Clientes ({clientes.filter(c=>c.activo!==false).length})</h2>
    <button 
        onClick={() => setOrdenAlfabeticoClientes(!ordenAlfabeticoClientes)}
        className={`px-4 py-2 rounded-lg transition font-medium ${ordenAlfabeticoClientes ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}>
        üî§ {ordenAlfabeticoClientes ? 'Orden original' : 'Ordenar A-Z'}
    </button>
</div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                          <thead><tr className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Nombre</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Tipo</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>D√≠a</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Acciones</th></tr></thead>
                                            <tbody>
                                               {clientes.filter(c=>c.activo!==false).sort((a, b) => {
    if(ordenAlfabeticoClientes) {
        return a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' });
    }
    return 0;
}).map(c=>(
                                                 <tr key={c.id} className={`border-t ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition`}> 
                                                     <td className={`p-4 font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{c.nombre}</td>
                                                        <td className="p-4">
                                                          <select value={c.tipo_cliente||'Individual'} onChange={(e)=>updateTipoCliente(c.id,e.target.value)} className={`px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900'}`}>
                                                                <option value="Individual">Individual</option>
                                                                <option value="Contrato">Contrato</option>
                                                            </select>
                                                        </td>
                                                     <td className={`p-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{c.dia_entrega||'-'}</td>
                                                        <td className="p-4">
                                                          <div className="flex gap-2">
    <button onClick={()=>abrirPerfilCliente(c)} className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium">üë§ Ver Perfil</button>
    <button onClick={()=>deleteCliente(c.id)} className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium">üóëÔ∏è Eliminar</button>
</div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                            {activeTab==='historial' && (
    <HistorialCompras 
        clientes={clientes} 
        ventas={ventas} 
        pushToast={pushToast} 
        loadData={loadData}
        supabaseClient={supabaseClient}
        formatCOP={formatCOP}
        darkMode={darkMode}
    />
)}
                        {activeTab==='pedidos' && (
    <div className="space-y-6 fade-in">
        <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-indigo-500`}>
            <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                <span>üìÖ</span> Programar Pedido
            </h2>
            <form onSubmit={addPedido} className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input 
                        type="date" 
                        value={pedidoForm.fecha} 
                        onChange={(e)=>setPedidoForm({...pedidoForm,fecha:e.target.value})} 
                        className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500" 
                        required 
                    />
                    <select 
                        value={pedidoForm.cliente_id} 
                        onChange={(e)=>setPedidoForm({...pedidoForm,cliente_id:e.target.value})} 
                        className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500" 
                        required
                    >
                        <option value="">Seleccionar Cliente *</option>
                        {clientes.filter(c=>c.activo!==false).sort((a, b) => 
                            a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' })
                        ).map(c=>(<option key={c.id} value={c.id}>{c.nombre}</option>))}
                    </select>
                    <select 
                        value={pedidoForm.tipo_cantidad} 
                        onChange={(e)=>setPedidoForm({...pedidoForm,tipo_cantidad:e.target.value})} 
                        className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="Unidades">üåΩ Unidades</option>
                        <option value="Paquetes">üì¶ Paquetes</option>
                    </select>
                    <input 
                        type="number" 
                        min="1" 
                        value={pedidoForm.cantidad} 
                        onChange={(e)=>setPedidoForm({...pedidoForm,cantidad:e.target.value})} 
                        placeholder="Cantidad *" 
                        className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500" 
                        required 
                    />
                </div>
                <input 
                    value={pedidoForm.notas} 
                    onChange={(e)=>setPedidoForm({...pedidoForm,notas:e.target.value})} 
                    placeholder="Notas (opcional)" 
                    className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                />
                <button 
                    type="submit" 
                    className="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white p-5 rounded-xl font-bold text-lg hover:from-indigo-600 hover:to-indigo-700 transition shadow-lg pulse-hover"
                >
                    ‚úÖ Agregar a Lista
                </button>
            </form>
        </div>

        <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
            <h2 className="text-2xl font-bold mb-6">üìã Ver Lista por Fecha</h2>
            <div className="flex gap-4 mb-6">
                <input 
                    type="date" 
                    value={fechaSeleccionadaPedidos} 
                    onChange={(e)=>setFechaSeleccionadaPedidos(e.target.value)} 
                    className="flex-1 p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                />
                <button 
                    onClick={()=>setFechaSeleccionadaPedidos('')} 
                    className="px-6 py-4 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition"
                >
                    üîÑ Ver Todas
                </button>
            </div>

            {fechaSeleccionadaPedidos && (
                <div className="mb-6 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-300">
                    {(()=>{
                        const pedidosFecha = pedidosProgramados.filter(p => 
                            p.fecha && p.fecha.slice(0,10) === fechaSeleccionadaPedidos && !p.procesado
                        );
                        const totalUnidades = pedidosFecha.reduce((sum, p) => {
                            if(p.tipo_cantidad === 'Paquetes') return sum + (p.cantidad * 10);
                            return sum + p.cantidad;
                        }, 0);
                        const totalPaquetes = Math.floor(totalUnidades / 10);
                        const unidadesSueltas = totalUnidades % 10;
                        
                        return (
                            <div>
                                <h3 className="text-xl font-bold text-indigo-700 mb-4">
                                    üìÖ Producci√≥n para {fechaSeleccionadaPedidos}
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div className="bg-white p-4 rounded-xl shadow">
                                        <p className="text-sm text-gray-600">Total Unidades</p>
                                        <p className="text-3xl font-bold text-blue-600">{totalUnidades}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow">
                                        <p className="text-sm text-gray-600">Paquetes Completos</p>
                                        <p className="text-3xl font-bold text-purple-600">{totalPaquetes}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow">
                                        <p className="text-sm text-gray-600">Unidades Sueltas</p>
                                        <p className="text-3xl font-bold text-orange-600">{unidadesSueltas}</p>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3">
                                    <button 
                                        onClick={()=>procesarPedidosFecha(fechaSeleccionadaPedidos)}
                                        className="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition shadow-lg"
                                        disabled={pedidosFecha.length === 0}
                                    >
                                        ‚úÖ Convertir en Ventas ({pedidosFecha.length})
                                    </button>
                                    <button 
                                        onClick={()=>limpiarListaFecha(fechaSeleccionadaPedidos)}
                                        className="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-xl font-bold hover:from-red-600 hover:to-red-700 transition shadow-lg"
                                    >
                                        üóëÔ∏è Limpiar Lista
                                    </button>
                                </div>
                            </div>
                        );
                    })()}
                </div>
            )}

            <h3 className="text-xl font-bold mb-4">
                Pedidos Programados ({pedidosProgramados.filter(p=>!p.procesado).length})
            </h3>
            <div className="overflow-x-auto">
                <table className="w-full">
                    <thead>
                        <tr className="bg-gray-50">
                            <th className="p-4 text-left font-semibold">Fecha</th>
                            <th className="p-4 text-left font-semibold">Cliente</th>
                            <th className="p-4 text-left font-semibold">Cantidad</th>
                            <th className="p-4 text-left font-semibold">Estado</th>
                            <th className="p-4 text-left font-semibold">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {pedidosProgramados
                            .filter(p => fechaSeleccionadaPedidos ? p.fecha?.slice(0,10) === fechaSeleccionadaPedidos : true)
                            .map(p => (
                          <tr key={p.id} className={`border-t ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition ${p.procesado ? 'opacity-50' : ''}`}>
                                <td className={`p-4 font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                    {p.fecha ? new Date(p.fecha).toLocaleDateString('es-CO') : 'Sin fecha'}
                                </td>
                            <td className={`p-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{p.clientes?.nombre || 'N/A'}</td>
                                <td className="p-4">
                                    <span className="font-bold">{p.cantidad}</span> {p.tipo_cantidad}
                                    {p.tipo_cantidad === 'Paquetes' && (
                                       <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}> ({p.cantidad * 10} unidades)</span>
                                    )}
                                </td>
                                <td className="p-4">
                                    {p.procesado ? (
                                        <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                            ‚úÖ Procesado
                                        </span>
                                    ) : (
                                        <span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">
                                            ‚è≥ Pendiente
                                        </span>
                                    )}
                                </td>
                                <td className="p-4">
                                    <div className="flex gap-2">
                                        {!p.procesado && (
                                            <button 
                                                onClick={()=>deletePedido(p.id)} 
                                                className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium"
                                            >
                                                üóëÔ∏è Eliminar
                                            </button>
                                        )}
                                        {p.notas && (
                                            <button 
                                                onClick={()=>setNotaModal(p.notas)} 
                                                className="px-3 py-2 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 transition text-sm"
                                            >
                                                üìù Ver
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
)}

                        {activeTab==='ventas' && (
                            <div className="space-y-6 fade-in">
                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-orange-500`}>
                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>üõí</span> Registrar Venta</h2>
                                    <form onSubmit={addVenta} className="space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                          <select value={ventaForm.cliente_id} onChange={(e)=>setVentaForm({...ventaForm,cliente_id:e.target.value})} required className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                            <option value="" className={darkMode ? 'bg-gray-700 text-white' : ''}>Seleccionar Cliente *</option>
                                            {clientes.filter(c=>c.activo!==false).sort((a, b) => 
                                                 a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' })
                                                    ).map(c=>(<option key={c.id} value={c.id} className={darkMode ? 'bg-gray-700 text-white' : ''}>{c.nombre} ({c.tipo_cliente})</option>))}
                                            </select>
                                           <select value={ventaForm.tipo_cantidad} onChange={(e)=>setVentaForm({...ventaForm,tipo_cantidad:e.target.value,cantidad:'',total:''})} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                                <option value="Unidades">üåΩ Unidades ($600 c/u)</option>
                                                <option value="Paquetes">üì¶ Paquetes ($6,000 c/u)</option>
                                            </select>
                                            <input type="number" min="1" value={ventaForm.cantidad} onChange={(e)=>setVentaForm({...ventaForm,cantidad:e.target.value})} placeholder="Cantidad *" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" required />
                                        </div>

                                        {ventaForm.precio_sugerido>0 && (
                                            <div className="p-6 bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <p className="text-sm text-blue-700 font-medium mb-1">üí° Precio Sugerido</p>
                                                        <p className="text-3xl font-bold text-blue-600">{formatCOP(ventaForm.precio_sugerido)}</p>
                                                    </div>
                                                    <button type="button" onClick={()=>setVentaForm({...ventaForm,total:ventaForm.precio_sugerido})} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg pulse-hover">‚ú® Usar</button>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input type="number" placeholder="Total *" value={ventaForm.total} onChange={(e)=>setVentaForm({...ventaForm,total:e.target.value})} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" required />
                                            <input type="number" placeholder="Abono (opcional)" value={ventaForm.abono} onChange={(e)=>setVentaForm({...ventaForm,abono:e.target.value})} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                          <select value={ventaForm.estado_pago} onChange={(e)=>setVentaForm({...ventaForm,estado_pago:e.target.value})} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                                <option value="Pendiente">‚è≥ Pendiente</option>
                                                <option value="Pagado">‚úÖ Pagado</option>
                                            </select>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input value={ventaForm.semana} onChange={(e)=>setVentaForm({...ventaForm,semana:e.target.value})} placeholder="Semana (ej: Semana 42)" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                          <input type="date" value={ventaForm.fecha} onChange={(e)=>setVentaForm({...ventaForm,fecha:e.target.value})} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                            <input value={ventaForm.notas} onChange={(e)=>setVentaForm({...ventaForm,notas:e.target.value})} placeholder="Notas" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                        </div>

                                        <button type="submit" className="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white p-5 rounded-xl font-bold text-lg hover:from-orange-600 hover:to-orange-700 transition shadow-lg pulse-hover">üöÄ Registrar Venta</button>
                                    </form>
                                </div>

                               <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-indigo-500`}>
                                    <h2 className="text-2xl font-bold mb-6">Filtros y B√∫squeda</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                       <input type="date" value={filterDate} onChange={(e)=>setFilterDate(e.target.value)} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                      <select value={filterEstado} onChange={(e)=>setFilterEstado(e.target.value)} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                            <option value="Todos">Todas</option>
                                            <option value="Pagadas">‚úÖ Pagadas</option>
                                            <option value="Pendientes">‚è≥ Pendientes</option>
                                        </select>
                                        <button onClick={()=>{setFilterDate('');setFilterEstado('Todos');}} className="px-6 py-4 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition">üîÑ Limpiar</button>
                                    </div>

                                    {filterDate && (
                                        <div className="mb-6 p-6 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border-2 border-orange-300">
                                            {(()=>{
                                                const ventasPorFecha=ventas.filter(v=>v.fecha&&v.fecha.slice(0,10)===filterDate);
                                                const total=ventasPorFecha.reduce((s,v)=>s+(parseFloat(v.total)||0),0);
                                                const unidades=ventasPorFecha.reduce((s,v)=>{if(v.tipo_cantidad==='Paquetes')return s+((parseInt(v.cantidad)||0)*10);return s+(parseInt(v.cantidad)||0);},0);
                                                return (<div>
                                                    <p className="text-lg font-bold text-orange-700 mb-3">üìÖ Ventas del {filterDate}</p>
                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                                        <div className="bg-white p-4 rounded-xl shadow">
                                                            <p className="text-sm text-gray-600">Unidades</p>
                                                            <p className="text-2xl font-bold text-blue-600">{unidades}</p>
                                                        </div>
                                                        <div className="bg-white p-4 rounded-xl shadow">
                                                            <p className="text-sm text-gray-600">Paquetes</p>
                                                            <p className="text-2xl font-bold text-purple-600">{Math.floor(unidades/10)}+{unidades%10}</p>
                                                        </div>
                                                    </div>
                                                </div>);
                                            })()}
                                        </div>
                                    )}

                                   <div className="flex justify-between items-center mb-4">
                                    <div className="flex justify-between items-center mb-4">
   <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Historial ({ventasFiltradas.length})</h3>
    <button 
        onClick={() => setOrdenAlfabetico(!ordenAlfabetico)}
        className={`px-4 py-2 rounded-lg transition font-medium ${ordenAlfabetico ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}>
        üî§ {ordenAlfabetico ? 'Orden por fecha' : 'Ordenar A-Z'}
    </button>
</div>
    <button 
        onClick={() => {
            const sorted = [...ventasFiltradas].sort((a, b) => 
                (a.clientes?.nombre || '').localeCompare(b.clientes?.nombre || '', 'es', { sensitivity: 'base' })
            );
            setVentas(sorted);
        }}
        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium">
        üî§ Ordenar A-Z
    </button>
</div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                          <thead><tr className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Cliente</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Cantidad</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Total</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Abono</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Saldo</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Estado</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Fecha</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Acciones</th></tr></thead>
                                            <tbody>
                                                {ventasFiltradas.map(v=>{
                                                    const total=parseFloat(v.total)||0;
                                                    const abono=parseFloat(v.abono)||0;
                                                    const saldo=total-abono;
                                                   return (<tr key={v.id} className={`border-t ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition`}>
                                                        <td className={`p-4 font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{v.clientes?.nombre||'N/A'}</td>
                                                         <td className="p-4">
    <input 
        type="number" 
        defaultValue={v.cantidad} 
        onBlur={async (e) => {
            const nuevaCantidad = parseInt(e.target.value);
            if(nuevaCantidad && nuevaCantidad > 0) {
                const precioUnitario = parseFloat(v.precio_unitario) || (v.tipo_cantidad === 'Unidades' ? 600 : 6000);
                const nuevoTotal = nuevaCantidad * precioUnitario;
                const abonoActual = parseFloat(v.abono) || 0;
                const nuevoEstado = abonoActual >= nuevoTotal ? 'Pagado' : 'Pendiente';
                
                const { error } = await supabaseClient.from('ventas').update({ 
                    cantidad: nuevaCantidad,
                    total: nuevoTotal,
                    estado_pago: nuevoEstado
                }).eq('id', v.id);
                
                if(error) {
                    pushToast('Error al actualizar', 'error');
                } else {
                    pushToast('‚úÖ Cantidad y total actualizados');
                    loadData();
                }
            }
        }}
       className={`w-20 p-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}
    />
   <span className={`ml-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{v.tipo_cantidad}</span>
</td>   
                                                        <td className="p-4 font-bold text-green-600">{formatCOP(total)}</td>
                                                        <td className="p-4"><span className={`font-bold ${abono>0?'text-blue-600':'text-gray-400'}`}>{formatCOP(abono)}</span></td>
                                                        <td className="p-4"><span className={`font-bold ${saldo>0?'text-red-600':'text-green-600'}`}>{formatCOP(saldo)}</span></td>
                                                        <td className="p-4">
                                                            <button onClick={()=>{if(v.estado_pago==='Pagado'){if(confirm('¬øMarcar como pendiente?'))setPagoVenta(v,'Pendiente');}else{if(confirm('¬øMarcar como pagado completamente?'))setPagoVenta(v,'Pagado');}}} className={`px-4 py-2 rounded-xl font-medium transition ${v.estado_pago==='Pagado'?'bg-green-100 text-green-700 hover:bg-green-200':'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'}`}>
                                                                {v.estado_pago==='Pagado'?'‚úÖ Pagado':'‚è≥ Pendiente'}
                                                            </button>
                                                        </td>
                                                        <td className="p-4"></td>
                                                        <td className="p-4"><input type="date" defaultValue={v.fecha?v.fecha.slice(0,10):''} onBlur={(e)=>updateFechaVenta(v.id,e.target.value)} className={`p-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                                            <div className="flex gap-2 flex-wrap">
                                                                <button onClick={()=>{const ab=prompt(`Agregar abono (Saldo: ${formatCOP(saldo)}):`);if(!ab||ab==='')return;const monto=parseFloat(ab);if(isNaN(monto)||monto<=0){alert('Ingresa un monto v√°lido');return;}if(monto>saldo){alert('El abono no puede ser mayor al saldo');return;}setPagoVenta(v,'Abono',monto);}} className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium text-sm">üí∞ Abonar</button>
                                                                <button onClick={()=>deleteVenta(v.id)} className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium text-sm">üóëÔ∏è</button>
                                                                    {v.notas&&<button onClick={()=>setNotaModal(v.notas)} className="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs hover:bg-amber-200 transition">üìù Ver</button>}
                                                            </div>
                                                        </td>
                                                    </tr>);
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab==='contabilidad' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-green-500`}>
                                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>üìà</span> Agregar Ingreso</h2>
                                        <form onSubmit={addIngreso} className="space-y-4">
                                            <input value={ingresoForm.concepto} onChange={(e)=>setIngresoForm({...ingresoForm,concepto:e.target.value})} placeholder="Concepto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
                                            <input type="number" step="100" value={ingresoForm.monto} onChange={(e)=>setIngresoForm({...ingresoForm,monto:e.target.value})} placeholder="Monto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
                                          <input type="date" value={ingresoForm.fecha} onChange={(e)=>setIngresoForm({...ingresoForm,fecha:e.target.value})} className={`w-full p-4 border-2 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                            <button type="submit" className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition shadow-lg pulse-hover">‚úÖ Agregar</button>
                                        </form>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-red-500`}>
                                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>üìâ</span> Agregar Egreso</h2>
                                        <form onSubmit={addEgreso} className="space-y-4">
                                            <input value={egresoForm.concepto} onChange={(e)=>setEgresoForm({...egresoForm,concepto:e.target.value})} placeholder="Concepto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent" required />
                                            <input type="number" step="100" value={egresoForm.monto} onChange={(e)=>setEgresoForm({...egresoForm,monto:e.target.value})} placeholder="Monto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent" required />
                                          <input type="date" value={egresoForm.fecha} onChange={(e)=>setEgresoForm({...egresoForm,fecha:e.target.value})} className={`w-full p-4 border-2 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                            <button type="submit" className="w-full bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-xl font-bold hover:from-red-600 hover:to-red-700 transition shadow-lg pulse-hover">‚úÖ Agregar</button>
                                        </form>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                        <h3 className="text-xl font-bold mb-6 text-green-600 flex items-center gap-2"><span>üíµ</span> Ingresos ({ingresos.length})</h3>
                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {ingresos.map(ing=>(<div key={ing.id} className="flex justify-between items-center p-4 bg-green-50 rounded-xl hover:bg-green-100 transition border-l-4 border-green-500">
                                                <div className="flex-1">
                                                 <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{ing.concepto}</p>
                                                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{ing.fecha?new Date(ing.fecha).toLocaleDateString('es-CO'):''}</p>
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <span className="font-bold text-green-600 text-lg">{formatCOP(ing.monto)}</span>
                                                    <button onClick={()=>deleteIngreso(ing.id)} className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium">üóëÔ∏è</button>
                                                </div>
                                            </div>))}
                                            {ingresos.length===0&&<p className="text-center py-8 text-gray-400">Sin registros</p>}
                                        </div>
                                    </div>

                                   <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                        <h3 className="text-xl font-bold mb-6 text-red-600 flex items-center gap-2"><span>üí∏</span> Egresos ({egresos.length})</h3>
                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {egresos.map(egr=>(<div key={egr.id} className="flex justify-between items-center p-4 bg-red-50 rounded-xl hover:bg-red-100 transition border-l-4 border-red-500">
                                                <div className="flex-1">
                                              <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{egr.concepto}</p>
                                                   <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{egr.fecha?new Date(egr.fecha).toLocaleDateString('es-CO'):''}</p>
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <span className="font-bold text-red-600 text-lg">{formatCOP(egr.monto)}</span>
                                                    <button onClick={()=>deleteEgreso(egr.id)} className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium">üóëÔ∏è</button>
                                                </div>
                                            </div>))}
                                            {egresos.length===0&&<p className="text-center py-8 text-gray-400">Sin registros</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab==='resumen' && (
                            <div className="space-y-6 fade-in">
                          <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-purple-500`}>
                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>üìä</span> Resumen General</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Desde</label>
                                         <input type="date" value={resDesde} onChange={(e)=>setResDesde(e.target.value)} className={`w-full p-4 border-2 rounded-xl focus:ring-2 focus:ring-purple-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Hasta</label>
                                       <input type="date" value={resHasta} onChange={(e)=>setResHasta(e.target.value)} className={`w-full p-4 border-2 rounded-xl focus:ring-2 focus:ring-purple-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                        </div>
                                        <div className="flex items-end">
                                            <button onClick={()=>{setResDesde('');setResHasta('');}} className="w-full px-6 py-4 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition">üîÑ Limpiar</button>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-amber-100 text-sm font-medium mb-2">Total Ventas</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalVentas)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-green-100 text-sm font-medium mb-2">Total Abonos</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalAbonos)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-red-100 text-sm font-medium mb-2">Saldo Pendiente</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalSaldo)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-blue-100 text-sm font-medium mb-2">Ingresos</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalIngresos)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-purple-100 text-sm font-medium mb-2">Egresos</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalEgresos)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-gray-700 to-gray-800 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-gray-300 text-sm font-medium mb-2">Balance Final</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalIngresos-resumen.totalEgresos)}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                    <h3 className="text-xl font-bold mb-6 flex items-center gap-2"><span>üìã</span> Detalles del Per√≠odo</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border-2 border-blue-300">
                                            <p className="text-sm text-blue-700 font-semibold mb-2">Ventas Totales</p>
                                            <p className="text-4xl font-bold text-blue-600 mb-4">{formatCOP(resumen.totalVentas)}</p>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-blue-700">Abonado:</span>
                                                    <span className="font-bold text-green-600">{formatCOP(resumen.totalAbonos)}</span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-blue-700">Por cobrar:</span>
                                                    <span className="font-bold text-red-600">{formatCOP(resumen.totalSaldo)}</span>
                                                </div>
                                                <div className="pt-2 border-t-2 border-blue-300">
                                                    <div className="flex justify-between">
                                                        <span className="font-bold text-blue-800">Efectivo real:</span>
                                                        <span className="font-bold text-blue-800 text-lg">{formatCOP(resumen.totalAbonos)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border-2 border-purple-300">
                                            <p className="text-sm text-purple-700 font-semibold mb-2">Balance Neto</p>
                                            <p className="text-4xl font-bold text-purple-600 mb-4">{formatCOP(resumen.totalIngresos-resumen.totalEgresos)}</p>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-purple-700">Total ingresos:</span>
                                                    <span className="font-bold text-green-600">{formatCOP(resumen.totalIngresos)}</span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-purple-700">Total egresos:</span>
                                                    <span className="font-bold text-red-600">{formatCOP(resumen.totalEgresos)}</span>
                                                </div>
                                                <div className="pt-2 border-t-2 border-purple-300">
                                                    <div className="flex justify-between">
                                                        <span className="font-bold text-purple-800">Utilidad:</span>
                                                        <span className={`font-bold text-lg ${(resumen.totalIngresos-resumen.totalEgresos)>=0?'text-green-600':'text-red-600'}`}>
                                                            {formatCOP(resumen.totalIngresos-resumen.totalEgresos)}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-r from-amber-100 to-orange-100 p-8 rounded-2xl shadow-xl border-2 border-orange-300">
                                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-orange-800">
                                        <span>üí°</span> An√°lisis R√°pido
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-white p-4 rounded-xl shadow">
                                            <p className="text-sm text-gray-600 mb-1">Tasa de cobro</p>
                                            <p className="text-2xl font-bold text-blue-600">
                                                {resumen.totalVentas>0?Math.round((resumen.totalAbonos/resumen.totalVentas)*100):0}%
                                            </p>
                                        </div>
                                        <div className="bg-white p-4 rounded-xl shadow">
                                            <p className="text-sm text-gray-600 mb-1">Clientes activos</p>
                                            <p className="text-2xl font-bold text-green-600">{clientes.filter(c=>c.activo!==false).length}</p>
                                        </div>
                                        <div className="bg-white p-4 rounded-xl shadow">
                                            <p className="text-sm text-gray-600 mb-1">Ventas registradas</p>
                                            <p className="text-2xl font-bold text-orange-600">{ventas.length}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    {notaModal && (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={()=>setNotaModal(null)}>
        <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full" onClick={(e)=>e.stopPropagation()}>
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üìù</span> Notas de la venta
            </h3>
            <p className="text-gray-700 whitespace-pre-wrap mb-6">{notaModal}</p>
            <button onClick={()=>setNotaModal(null)} className="w-full bg-amber-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-amber-600 transition">
                Cerrar
            </button>
        </div>
    </div>
)}
{mostrarPerfilCliente && clienteSeleccionado && (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={()=>setMostrarPerfilCliente(false)}>
        <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e)=>e.stopPropagation()}>
            {(()=>{
                const ventasCliente = ventas.filter(v => v.cliente_id === clienteSeleccionado.id);
                const totalVentas = ventasCliente.reduce((s,v)=>s+(parseFloat(v.total)||0),0);
                const totalAbonado = ventasCliente.reduce((s,v)=>s+(parseFloat(v.abono)||0),0);
                const saldoPendiente = totalVentas - totalAbonado;
                const ventasPendientes = ventasCliente.filter(v=>v.estado_pago==='Pendiente');
                const promedioMensual = ventasCliente.length > 0 ? totalVentas / ventasCliente.length : 0;
                
                return (
                    <>
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-3xl font-bold mb-2">üë§ {clienteSeleccionado.nombre}</h2>
                                <div className="flex gap-2">
                                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${clienteSeleccionado.tipo_cliente==='Contrato'?'bg-purple-100 text-purple-700':'bg-blue-100 text-blue-700'}`}>
                                        {clienteSeleccionado.tipo_cliente}
                                    </span>
                                    {clienteSeleccionado.dia_entrega && (
                                        <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">
                                            üìÖ {clienteSeleccionado.dia_entrega}
                                        </span>
                                    )}
                                </div>
                            </div>
                            <button onClick={()=>setMostrarPerfilCliente(false)} className="text-3xl hover:text-red-500 transition">√ó</button>
                        </div>

                        {/* Informaci√≥n b√°sica */}
                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-6 rounded-xl mb-6`}>
                            <h3 className="text-lg font-bold mb-3">üìã Informaci√≥n</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {clienteSeleccionado.direccion && (
                                    <div>
                                        <p className="text-sm text-gray-500">Direcci√≥n</p>
                                        <p className="font-semibold">{clienteSeleccionado.direccion}</p>
                                    </div>
                                )}
                                {clienteSeleccionado.precio_especial && (
                                    <div>
                                        <p className="text-sm text-gray-500">Precio Especial</p>
                                        <p className="font-semibold text-green-600">{formatCOP(clienteSeleccionado.precio_especial)}</p>
                                    </div>
                                )}
                                {clienteSeleccionado.notas && (
                                    <div className="md:col-span-2">
                                        <p className="text-sm text-gray-500">Notas</p>
                                        <p className="font-semibold">{clienteSeleccionado.notas}</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Estad√≠sticas */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-xl">
                                <p className="text-sm opacity-80">Total Ventas</p>
                                <p className="text-2xl font-bold">{ventasCliente.length}</p>
                            </div>
                            <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-xl">
                                <p className="text-sm opacity-80">Total Facturado</p>
                                <p className="text-lg font-bold">{formatCOP(totalVentas)}</p>
                            </div>
                            <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-xl">
                                <p className="text-sm opacity-80">Abonado</p>
                                <p className="text-lg font-bold">{formatCOP(totalAbonado)}</p>
                            </div>
                            <div className="bg-gradient-to-br from-red-500 to-red-600 text-white p-4 rounded-xl">
                                <p className="text-sm opacity-80">Saldo</p>
                                <p className="text-lg font-bold">{formatCOP(saldoPendiente)}</p>
                            </div>
                        </div>

                        {/* Ventas pendientes */}
                        {ventasPendientes.length > 0 && (
                            <div className={`${darkMode ? 'bg-red-900/30' : 'bg-red-50'} p-6 rounded-xl mb-6 border-2 border-red-300`}>
                                <h3 className="text-lg font-bold mb-3 text-red-700">‚ö†Ô∏è Pagos Pendientes ({ventasPendientes.length})</h3>
                                <div className="space-y-2">
                                    {ventasPendientes.slice(0, 5).map(v => (
                                        <div key={v.id} className={`${darkMode ? 'bg-gray-700' : 'bg-white'} p-3 rounded-lg flex justify-between items-center`}>
                                            <div>
                                                <p className="font-semibold">{v.cantidad} {v.tipo_cantidad}</p>
                                                <p className="text-sm text-gray-500">{v.fecha ? new Date(v.fecha).toLocaleDateString('es-CO') : 'Sin fecha'}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-sm text-gray-500">Total: {formatCOP(v.total)}</p>
                                                <p className="font-bold text-red-600">Debe: {formatCOP((parseFloat(v.total)||0)-(parseFloat(v.abono)||0))}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Historial completo */}
                        <div>
                            <h3 className="text-lg font-bold mb-3">üìú Historial de Compras</h3>
                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                {ventasCliente.length === 0 ? (
                                    <p className="text-center py-8 text-gray-400">Sin ventas registradas</p>
                                ) : (
                                    ventasCliente.map(v => (
                                        <div key={v.id} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg hover:shadow-md transition`}>
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-semibold">{v.cantidad} {v.tipo_cantidad}</p>
                                                    <p className="text-sm text-gray-500">
                                                        {v.fecha ? new Date(v.fecha).toLocaleDateString('es-CO') : 'Sin fecha'}
                                                        {v.semana && ` ‚Ä¢ ${v.semana}`}
                                                    </p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-bold text-lg">{formatCOP(v.total)}</p>
                                                    <span className={`px-2 py-1 rounded text-xs font-medium ${v.estado_pago==='Pagado'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>
                                                        {v.estado_pago}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        <button onClick={()=>setMostrarPerfilCliente(false)} className="w-full mt-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-xl font-bold hover:from-orange-600 hover:to-orange-700 transition">
                            Cerrar Perfil
                        </button>
                    </>
                );
            })()}
        </div>
    </div>
)}

                    <Toast toasts={toasts} remove={removeToast} />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>