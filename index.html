<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arepas al Fuego - Sistema de Gesti√≥n</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;
        
        const supabaseClient = createClient(
            'https://xybyupmrtiyspxlzcaug.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5Ynl1cG1ydGl5c3B4bHpjYXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODk3MDYsImV4cCI6MjA3NTQ2NTcwNn0.EHS9tI0-2vllcfdU-W4zeCVWf7csG24CtVmUbmk7s1M'
        );

        const formatPeso = (amount) => `$${Math.round(amount || 0).toLocaleString('es-CO')}`;

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [clientes, setClientes] = useState([]);
            const [ventas, setVentas] = useState([]);
            const [ingresos, setIngresos] = useState([]);
            const [egresos, setEgresos] = useState([]);
            const [filterDesde, setFilterDesde] = useState('');
            const [filterHasta, setFilterHasta] = useState('');

            useEffect(()=>{init();},[]);

            const init = async () => {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) { setUser('anon'); return; }
                setUser(session.user);
                const { data: cl } = await supabaseClient.from('clientes').select('*');
                const { data: vs } = await supabaseClient.from('ventas').select('*,clientes(nombre,tipo_cliente)').order('fecha',{ascending:false});
                const { data: ing } = await supabaseClient.from('ingresos').select('*');
                const { data: egr } = await supabaseClient.from('egresos').select('*');
                setClientes(cl||[]);
                setVentas(vs||[]);
                setIngresos(ing||[]);
                setEgresos(egr||[]);
            };

            const updateTipoCliente = async (id, tipo) => {
                await supabaseClient.from('clientes').update({tipo_cliente:tipo}).eq('id', id);
                setClientes(clientes.map(c=>c.id===id?{...c,tipo_cliente:tipo}:c));
            };

            const updateEstadoPago = async (v, estado, abono) => {
                const total = parseFloat(v.total)||0;
                const abActual = parseFloat(v.abono)||0;
                const abNuevo = abActual + (parseFloat(abono)||0);
                const saldo = total - abNuevo;
                let nuevoEstado = estado;
                if(estado==='Abono' && saldo<=0) nuevoEstado='Pagado';

                await supabaseClient.from('ventas').update({estado_pago:nuevoEstado, abono:abNuevo}).eq('id',v.id);
                if(estado==='Abono' && abono>0){
                    await supabaseClient.from('ingresos').insert([{concepto:`Abono - ${v.clientes?.nombre}`,monto:parseFloat(abono),categoria:'Abono',fecha:new Date().toISOString()}]);
                }
                if(estado==='Pagado'){
                    await supabaseClient.from('ingresos').insert([{concepto:`Venta - ${v.clientes?.nombre}`,monto:total,categoria:'Venta',fecha:new Date().toISOString()}]);
                }
                setVentas(ventas.map(x=>x.id===v.id?{...x,estado_pago:nuevoEstado,abono:abNuevo}:x));
            };

            const calcularResumen = () => {
                const desde = filterDesde ? new Date(filterDesde) : new Date('2000-01-01');
                const hasta = filterHasta ? new Date(filterHasta) : new Date();

                const filtrarFecha = (f) => {
                    const fecha = new Date(f);
                    return fecha >= desde && fecha <= hasta;
                };

                const ventasFiltradas = ventas.filter(v => v.fecha && filtrarFecha(v.fecha));
                const ingresosFiltrados = ingresos.filter(i => i.fecha && filtrarFecha(i.fecha));
                const egresosFiltrados = egresos.filter(e => e.fecha && filtrarFecha(e.fecha));

                const totalVentas = ventasFiltradas.reduce((s,v)=>s+(parseFloat(v.total)||0),0);
                const totalAbonos = ventasFiltradas.reduce((s,v)=>s+(parseFloat(v.abono)||0),0);
                const totalSaldo = totalVentas - totalAbonos;
                const totalIngresos = ingresosFiltrados.reduce((s,i)=>s+(parseFloat(i.monto)||0),0);
                const totalEgresos = egresosFiltrados.reduce((s,e)=>s+(parseFloat(e.monto)||0),0);

                return {totalVentas,totalAbonos,totalSaldo,totalIngresos,totalEgresos};
            };

            const resumen = calcularResumen();

            return (
                <div className="min-h-screen bg-amber-50">
                    <div className="bg-gradient-to-r from-amber-700 via-orange-600 to-yellow-700 text-white p-6">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-bold">Arepas al Fuego - Sistema</h1>
                        </div>
                    </div>

                    <div className="flex border-b bg-white shadow-sm sticky top-0 z-10 overflow-x-auto">
                        {[{id:'dashboard',label:'Inicio'},{id:'clientes',label:'Clientes'},{id:'ventas',label:'Ventas'},{id:'contabilidad',label:'Contabilidad'},{id:'resumen',label:'Resumen'}].map(tab=>(
                            <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`px-6 py-4 ${activeTab===tab.id?'border-b-2 border-orange-600 text-orange-600':'text-gray-600'}`}>{tab.label}</button>
                        ))}
                    </div>

                    <div className="max-w-7xl mx-auto p-4">
                        {activeTab==='clientes' && (
                            <div className="bg-white p-6 rounded shadow">
                                <h2 className="font-bold">Clientes</h2>
                                <table className="w-full mt-3">
                                    <thead><tr><th>Nombre</th><th>Tipo</th><th>Cambiar</th></tr></thead>
                                    <tbody>
                                        {clientes.map(c=>(
                                            <tr key={c.id} className="border-t"><td>{c.nombre}</td><td>{c.tipo_cliente}</td><td>
                                                <select value={c.tipo_cliente} onChange={e=>updateTipoCliente(c.id,e.target.value)} className="p-1 border rounded">
                                                    <option>Individual</option><option>Contrato</option>
                                                </select>
                                            </td></tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {activeTab==='resumen' && (
                            <div className="bg-white p-6 rounded shadow space-y-4">
                                <h2 className="font-bold text-xl">Resumen General</h2>
                                <div className="flex gap-2">
                                    <div>
                                        <label>Desde:</label>
                                        <input type="date" value={filterDesde} onChange={e=>setFilterDesde(e.target.value)} className="border p-2 rounded ml-1" />
                                    </div>
                                    <div>
                                        <label>Hasta:</label>
                                        <input type="date" value={filterHasta} onChange={e=>setFilterHasta(e.target.value)} className="border p-2 rounded ml-1" />
                                    </div>
                                    <button onClick={()=>{setFilterDesde('');setFilterHasta('');}} className="px-3 py-1 border rounded">Limpiar</button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div className="bg-amber-50 p-4 rounded shadow">
                                        <p className="font-bold">Total Ventas</p>
                                        <p>{formatPeso(resumen.totalVentas)}</p>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded shadow">
                                        <p className="font-bold">Total Abonos</p>
                                        <p>{formatPeso(resumen.totalAbonos)}</p>
                                    </div>
                                    <div className="bg-yellow-50 p-4 rounded shadow">
                                        <p className="font-bold">Saldo Pendiente</p>
                                        <p>{formatPeso(resumen.totalSaldo)}</p>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded shadow">
                                        <p className="font-bold">Ingresos</p>
                                        <p>{formatPeso(resumen.totalIngresos)}</p>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded shadow">
                                        <p className="font-bold">Egresos</p>
                                        <p>{formatPeso(resumen.totalEgresos)}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>