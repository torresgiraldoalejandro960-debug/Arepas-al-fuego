<!DOCTYPE html>
<html lang="es">

<head>
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="Arepas.png">
    <link rel="apple-touch-icon" href="Arepas.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arepas al Carbon </title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .pulse-hover:hover {
            animation: pulse 0.6s ease-in-out;
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        .gradient-text {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Animaciones nuevas */
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-hide {
                display: none;
            }

            .mobile-full {
                width: 100% !important;
            }

            .mobile-stack {
                flex-direction: column;
            }

            /* Botones solo iconos en mÃ³vil */
            .btn-text-mobile {
                font-size: 0;
            }

            /* Reducir tamaÃ±os */
            .p-8 {
                padding: 1rem !important;
            }

            .p-6 {
                padding: 0.75rem !important;
            }

            .text-2xl {
                font-size: 1.25rem !important;
            }

            .text-3xl {
                font-size: 1.5rem !important;
            }

            /* Calendario mÃ¡s compacto */
            .calendar-day {
                min-height: 60px !important;
                padding: 0.25rem !important;
                font-size: 0.75rem !important;
            }
        }

        /* Ocultar scrollbar pero mantener funcionalidad */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Mejorar tÃ¡ctil en mÃ³vil */
        @media (max-width: 768px) {

            button,
            input,
            select {
                touch-action: manipulation;
            }
        }

        /* Tablas responsivas */
        @media (max-width: 768px) {
            table {
                font-size: 0.875rem;
            }

            table th,
            table td {
                padding: 0.5rem !important;
            }

            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Mejoras modo nocturno */
        .dark-mode-improved {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        /* Inputs en modo oscuro */
        @media (prefers-color-scheme: dark) {

            input:not([type="date"]):not([type="number"]),
            textarea,
            select {
                color-scheme: dark;
            }
        }
    </style>

</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        const SUPABASE_URL = 'https://xybyupmrtiyspxlzcaug.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5Ynl1cG1ydGl5c3B4bHpjYXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODk3MDYsImV4cCI6MjA3NTQ2NTcwNn0.EHS9tI0-2vllcfdU-W4zeCVWf7csG24CtVmUbmk7s1M';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const formatCOP = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);

        function Toast({ toasts, remove }) {
            return (
                <div className="fixed bottom-6 right-6 space-y-2 z-50">
                    {toasts.map(t => (
                        <div key={t.id} className={`fade-in px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 ${t.type === 'success' ? 'bg-gradient-to-r from-green-500 to-green-600 text-white' : t.type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600 text-white' : 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-black'}`}>
                            <span className="text-xl">{t.icon}</span>
                            <div className="font-medium">{t.message}</div>
                            <button onClick={() => remove(t.id)} className="ml-2 opacity-80 hover:opacity-100 text-xl">Ã—</button>
                        </div>
                    ))}
                </div>
            );
        }

        function LandingPage({ onEnter }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-100 to-yellow-50 flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-10">
                        <div className="absolute top-20 left-10 text-8xl">ğŸŒ½</div>
                        <div className="absolute bottom-20 right-10 text-8xl">ğŸ”¥</div>
                        <div className="absolute top-40 right-20 text-6xl">ğŸŒ¾</div>
                        <div className="absolute bottom-40 left-20 text-6xl">ğŸ§¡</div>
                    </div>

                    <div className="fade-in text-center relative z-10">
                        <div className="float-animation mb-8">
                            <img src="Arepas.png" alt="Arepas al CarbÃ³n" className="w-80 h-80 mx-auto drop-shadow-2xl" />
                        </div>

                        <h1 className="text-5xl md:text-6xl font-bold gradient-text mb-6">Arepas al Carbon</h1>

                        <p className="text-2xl md:text-3xl text-gray-700 font-semibold mb-4 px-4">
                            "Nada mÃ¡s colombiano que una arepa al carbÃ³n
                        </p>
                        <p className="text-2xl md:text-3xl text-gray-700 font-semibold mb-12 px-4">
                            hecha con amor del campo"
                        </p>

                        <button
                            onClick={onEnter}
                            className="bg-gradient-to-r from-amber-600 to-orange-600 text-white px-12 py-5 rounded-full font-bold text-xl hover:from-amber-700 hover:to-orange-700 transition shadow-2xl pulse-hover">
                            ğŸš€ Entrar pa'voltear la Arepa
                        </button>
                    </div>
                </div>
            );
        }

        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    setError('Credenciales incorrectas');
                    setLoading(false);
                } else {
                    onLogin(data.user);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-100 via-orange-50 to-yellow-100 flex items-center justify-center p-4">
                    <div className="fade-in bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md border-t-8 border-orange-600">
                        <div className="text-center mb-8">
                            <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-5 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center shadow-lg pulse-hover">
                                <span className="text-6xl">ğŸ”¥</span>
                            </div>
                            <h1 className="text-4xl font-bold gradient-text mb-3">Arepas al Carbon</h1>
                            <p className="text-gray-600 text-lg">Sistema de GestiÃ³n</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">ğŸ“§ Correo electrÃ³nico</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition" placeholder="tu@email.com" required />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">ğŸ”’ ContraseÃ±a</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
                            </div>

                            {error && (
                                <div className="fade-in bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm flex items-center gap-2">
                                    <span>âš ï¸</span> {error}
                                </div>
                            )}

                            <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white p-4 rounded-xl font-bold text-lg hover:from-amber-700 hover:to-orange-700 transition disabled:opacity-50 shadow-lg pulse-hover">
                                {loading ? 'ğŸ”„ Iniciando sesiÃ³n...' : 'ğŸš€ Iniciar SesiÃ³n'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function HistorialCompras({ clientes, ventas, pushToast, loadData, supabaseClient, formatCOP, darkMode, enviarWhatsApp }) {
            const [selectedCliente, setSelectedCliente] = useState(null);
            const [abonoTotal, setAbonoTotal] = useState('');

            const calcularDeudaPorCliente = () => {
                const deudas = {};

                clientes.filter(c => c.activo !== false).forEach(cliente => {
                    const ventasCliente = ventas.filter(v => v.cliente_id === cliente.id && v.estado_pago === 'Pendiente');

                    if (ventasCliente.length > 0) {
                        const fechas = {};
                        ventasCliente.forEach(v => {
                            let fecha = 'Sin fecha';
                            if (v.fecha) {
                                const fechaObj = new Date(v.fecha);
                                const year = fechaObj.getUTCFullYear();
                                const month = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(fechaObj.getUTCDate()).padStart(2, '0');
                                fecha = `${day}/${month}/${year}`;
                            }

                            const deuda = (parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0);

                            if (!fechas[fecha]) {
                                fechas[fecha] = { fecha, deuda: 0, ventas: [] };
                            }
                            fechas[fecha].deuda += deuda;
                            fechas[fecha].ventas.push(v);
                        });

                        const fechasArray = Object.values(fechas).sort((a, b) => {
                            if (a.fecha === 'Sin fecha') return 1;
                            if (b.fecha === 'Sin fecha') return -1;
                            return new Date(a.ventas[0].fecha) - new Date(b.ventas[0].fecha);
                        });
                        const totalDeuda = fechasArray.reduce((sum, f) => sum + f.deuda, 0);

                        if (totalDeuda > 0) {
                            deudas[cliente.id] = {
                                cliente,
                                fechas: fechasArray,
                                totalDeuda,
                                cantidadFechas: fechasArray.length
                            };
                        }
                    }
                });

                return deudas;
            };

            const handleAbonoTotal = async () => {
                if (!selectedCliente || !abonoTotal) {
                    pushToast('Ingresa un monto vÃ¡lido', 'error');
                    return;
                }

                const monto = parseFloat(abonoTotal);
                if (isNaN(monto) || monto <= 0) {
                    pushToast('Ingresa un monto vÃ¡lido', 'error');
                    return;
                }

                const deudaInfo = deudas[selectedCliente];
                if (monto > deudaInfo.totalDeuda) {
                    pushToast('El abono no puede ser mayor a la deuda total', 'error');
                    return;
                }

                let montoRestante = monto;
                const ventasActualizadas = [];

                try {
                    for (const fechaInfo of deudaInfo.fechas) {
                        if (montoRestante <= 0) break;

                        for (const venta of fechaInfo.ventas) {
                            if (montoRestante <= 0) break;

                            const deudaVenta = (parseFloat(venta.total) || 0) - (parseFloat(venta.abono) || 0);
                            const abonoVenta = Math.min(montoRestante, deudaVenta);
                            const nuevoAbono = (parseFloat(venta.abono) || 0) + abonoVenta;
                            const nuevoEstado = nuevoAbono >= parseFloat(venta.total) ? 'Pagado' : 'Pendiente';

                            // Actualizar la venta
                            const { error: errorVenta } = await supabaseClient.from('ventas').update({
                                abono: nuevoAbono,
                                estado_pago: nuevoEstado
                            }).eq('id', venta.id);

                            if (errorVenta) {
                                console.error('Error actualizando venta:', errorVenta);
                                pushToast('Error al actualizar venta', 'error');
                                continue;
                            }

                            // Registrar el ingreso
                            const { data: ingresoData, error: errorIngreso } = await supabaseClient.from('ingresos').insert({
                                concepto: `Abono - ${deudaInfo.cliente.nombre} [ID:${venta.id}]`,
                                monto: abonoVenta,
                                categoria: 'Abono',
                                fecha: new Date().toISOString(),
                                notas: `venta_id:${venta.id}`
                            }).select();

                            if (errorIngreso) {
                                console.error('Error registrando ingreso:', errorIngreso);
                                pushToast('Error al registrar ingreso: ' + errorIngreso.message, 'error');
                            } else {
                                console.log('âœ… Ingreso registrado:', ingresoData);
                                ventasActualizadas.push({ id: venta.id, monto: abonoVenta });
                            }

                            montoRestante -= abonoVenta;
                        }
                    }

                    if (ventasActualizadas.length > 0) {
                        pushToast(`âœ… Abono de ${formatCOP(monto)} aplicado a ${ventasActualizadas.length} venta(s)`);
                    } else {
                        pushToast('No se pudieron aplicar los abonos', 'error');
                    }

                    setAbonoTotal('');
                    setSelectedCliente(null);
                    await loadData();

                } catch (err) {
                    console.error('Error en handleAbonoTotal:', err);
                    pushToast('Error al procesar el abono', 'error');
                }
            };
            const deudas = calcularDeudaPorCliente();
            const clientesConDeuda = Object.values(deudas).sort((a, b) =>
                a.cliente.nombre.localeCompare(b.cliente.nombre, 'es', { sensitivity: 'base' })
            );
            return (
                <div className="space-y-6 fade-in">
                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-purple-500`}>
                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                            <span>ğŸ“‹</span> Historial de Compras y Deudas por Fecha
                        </h2>

                        {clientesConDeuda.length === 0 ? (
                            <div className="text-center py-12">
                                <span className="text-6xl mb-4 block">âœ…</span>
                                <p className="text-xl text-gray-600 font-semibold">Â¡No hay deudas pendientes!</p>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {clientesConDeuda.map(deudaInfo => (
                                    <div key={deudaInfo.cliente.id} className={`border-2 ${darkMode ? 'border-gray-600 bg-gray-750' : 'border-gray-200 bg-white'} rounded-xl p-6 hover:border-orange-300 transition`}>
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{deudaInfo.cliente.nombre}</h3>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Debe en {deudaInfo.cantidadFechas} fecha(s)</p>
                                            </div>
                                            <div className="text-right">
                                                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'} mb-1`}>Total Deuda</p>
                                                <p className="text-3xl font-bold text-red-600">{formatCOP(deudaInfo.totalDeuda)}</p>
                                            </div>
                                        </div>

                                        <div className="space-y-3 mb-4">
                                            {deudaInfo.fechas.map((fechaInfo, idx) => (
                                                <div key={idx} className={`${darkMode ? 'bg-red-900/30' : 'bg-red-50'} p-4 rounded-lg border-l-4 border-red-500`}>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className={`font-semibold ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>ğŸ“… {fechaInfo.fecha}</span>
                                                        <span className="font-bold text-red-600">{formatCOP(fechaInfo.deuda)}</span>
                                                    </div>
                                                    <div className="space-y-2 mt-3">
                                                        {fechaInfo.ventas.map((venta, vIdx) => (
                                                            <div key={vIdx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 rounded-lg text-sm`}>
                                                                <div className="flex justify-between items-center">
                                                                    <div>
                                                                        <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Semana: </span>
                                                                        <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{venta.semana || 'N/A'}</span>
                                                                        <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} ml-3`}>Cantidad: </span>
                                                                        <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{venta.cantidad} {venta.tipo_cantidad}</span>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Total: {formatCOP(venta.total)}</p>
                                                                        <p className="text-xs text-blue-600">Abonado: {formatCOP(venta.abono || 0)}</p>
                                                                        <p className="text-xs text-red-600 font-bold">Debe: {formatCOP((parseFloat(venta.total) || 0) - (parseFloat(venta.abono) || 0))}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {selectedCliente === deudaInfo.cliente.id ? (
                                            <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-300">
                                                <label className="block text-sm font-semibold text-blue-700 mb-2">
                                                    ğŸ’° Monto a abonar (se aplicarÃ¡ desde la fecha mÃ¡s antigua)
                                                </label>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="number"
                                                        value={abonoTotal}
                                                        onChange={(e) => setAbonoTotal(e.target.value)}
                                                        placeholder="Ingresa el monto"
                                                        className="flex-1 p-3 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <button
                                                        onClick={handleAbonoTotal}
                                                        className="px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">
                                                        âœ… Aplicar
                                                    </button>
                                                    <button
                                                        onClick={() => { setSelectedCliente(null); setAbonoTotal(''); }}
                                                        className="px-6 py-3 bg-gray-400 text-white rounded-lg font-bold hover:bg-gray-500 transition">
                                                        âŒ
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                <button
                                                    onClick={() => setSelectedCliente(deudaInfo.cliente.id)}
                                                    className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg font-bold hover:from-blue-600 hover:to-blue-700 transition">
                                                    ğŸ’° Abonar
                                                </button>
                                                <button
                                                    onClick={async () => {
                                                        try {
                                                            // Preparar el mensaje detallado
                                                            let mensaje = `Hola ${deudaInfo.cliente.nombre}! ğŸ«“ğŸŒ½ \n\n`;
                                                            mensaje += `Te enviamos el detalle de tu saldo pendiente:\n\n`;

                                                            // Agregar detalle por fecha
                                                            deudaInfo.fechas.forEach(fechaInfo => {
                                                                mensaje += ` ğŸ“… *${fechaInfo.fecha}*\n`;
                                                                fechaInfo.ventas.forEach(v => {
                                                                    const deuda = (parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0);
                                                                    mensaje += `  â€¢ ${v.cantidad} ${v.tipo_cantidad} - Debe: ${formatCOP(deuda)}\n`;
                                                                });
                                                                mensaje += `\n`;
                                                            });

                                                            mensaje += `ğŸ’°  *TOTAL ADEUDADO: ${formatCOP(deudaInfo.totalDeuda)}*\n\n`;
                                                            mensaje += `Â¿CuÃ¡ndo podrÃ­amos coordinar el pago? Estamos a tu disposiciÃ³n. Â¡Gracias! ğŸ˜Š \n\n`;
                                                            mensaje += `ATT: Arepas al Carbon ğŸ«“ğŸŒ½ `;

                                                            // Llamar a la funciÃ³n
                                                            await enviarWhatsApp(deudaInfo.cliente, mensaje);
                                                        } catch (error) {
                                                            console.error('Error al enviar WhatsApp:', error);
                                                            pushToast('Error al abrir WhatsApp', 'error');
                                                        }
                                                    }}
                                                    className="bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-lg font-bold hover:from-green-600 hover:to-green-700 transition">
                                                    ğŸ“± WhatsApp
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function App() {

            const [showLanding, setShowLanding] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [clientes, setClientes] = useState([]);
            const [ventas, setVentas] = useState([]);
            const [ingresos, setIngresos] = useState([]);
            const [egresos, setEgresos] = useState([]);
            const [toasts, setToasts] = useState([]);

            const [clienteForm, setClienteForm] = useState({ nombre: '', direccion: '', tipo_cliente: 'Individual', dia_entrega: '', precio_especial: '', telefono: '', notas: '' });
            const [ventaForm, setVentaForm] = useState({ cliente_id: '', semana: '', tipo_venta: 'Individual', cantidad: '', tipo_cantidad: 'Unidades', precio_unitario: '', precio_sugerido: '', total: '', estado_pago: 'Pendiente', fecha: '', payment_type: 'Total', abono: '', notas: '' });
            const [ingresoForm, setIngresoForm] = useState({ concepto: '', monto: '', categoria: '', fecha: '' });
            const [egresoForm, setEgresoForm] = useState({ concepto: '', monto: '', categoria: '', fecha: '' });
            const [filterDate, setFilterDate] = useState('');
            const [filterEstado, setFilterEstado] = useState('Todos');
            const [notaModal, setNotaModal] = useState(null);
            const [pedidosProgramados, setPedidosProgramados] = useState([]);
            const [pedidoForm, setPedidoForm] = useState({ fecha: '', cliente_id: '', cantidad: '', tipo_cantidad: 'Unidades', notas: '' });
            const [fechaSeleccionadaPedidos, setFechaSeleccionadaPedidos] = useState('');
            const [ordenAlfabetico, set0rdenAlfabetico] = useState(false);
            const [ordenAlfabeticoClientes, setOrdenAlfabeticoClientes] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [clienteSeleccionado, setClienteSeleccionado] = useState(null);
            const [mostrarPerfilCliente, setMostrarPerfilCliente] = useState(false);
            const [resDesde, setResDesde] = useState('');
            const [resHasta, setResHasta] = useState('');
            // Estados nuevos
            const [searchCliente, setSearchCliente] = useState('');
            const [showCalculadora, setShowCalculadora] = useState(false);
            const [calcUnidades, setCalcUnidades] = useState('');
            const [modoCalculadora, setModoCalculadora] = useState('conversion'); // 'conversion', 'inversa', 'normal'
            const [calcInput1, setCalcInput1] = useState('');
            const [calcInput2, setCalcInput2] = useState('');
            const [calcOperacion, setCalcOperacion] = useState('+');
            const [calcResultado, setCalcResultado] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [showKeyboardShortcuts, setShowKeyboardShortcuts] = useState(false);
            const [showMenu, setShowMenu] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [modalConfig, setModalConfig] = useState({ type: 'confirm', title: '', message: '', onConfirm: null, onCancel: null, inputValue: '', placeholder: '' });
            // Estados para calendario
            const [notasCalendario, setNotasCalendario] = useState([]);
            const [mesActual, setMesActual] = useState(new Date());
            const [notaSeleccionada, setNotaSeleccionada] = useState(null);

            const [formularioNota, setFormularioNota] = useState({ fecha: '', titulo: '', descripcion: '', color: 'blue' });
            // Precios personalizables
            const [precioUnidad, setPrecioUnidad] = useState(600);
            const [precioPaquete, setPrecioPaquete] = useState(6000);
            const [mostrarConfigPrecios, setMostrarConfigPrecios] = useState(false);
            // Estados para exportar Excel
            const [mostrarModalExcel, setMostrarModalExcel] = useState(false);
            const [fechaDesdeExcel, setFechaDesdeExcel] = useState('');
            const [fechaHastaExcel, setFechaHastaExcel] = useState('');
            // Estados para compras de materia prima
            const [compras, setCompras] = useState([]);
            const [compraForm, setCompraForm] = useState({
                concepto: '',
                cantidad: '',
                unidad: 'Kg',
                precio_unitario: '',
                total: '',
                proveedor: '',
                fecha: '',
                notas: ''
            });
            // Estados para historial de resÃºmenes
            const [fechaUltimoReinicio, setFechaUltimoReinicio] = useState(null);
            const [historialResumenes, setHistorialResumenes] = useState([]);
            const [mostrarHistorial, setMostrarHistorial] = useState(false);

            const pushToast = (msg, type = 'success') => { const id = Date.now() + Math.random(); const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'; setToasts(t => [...t, { id, message: msg, type, icon }]); setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), 5000); };
            // Funciones para modales personalizados
            const showConfirm = (title, message, onConfirm, onCancel) => {
                setModalConfig({
                    type: 'confirm',
                    title,
                    message,
                    onConfirm,
                    onCancel,
                    inputValue: '',
                    placeholder: ''
                });
                setShowModal(true);
            };

            const showPrompt = (title, message, placeholder, onConfirm, onCancel) => {
                setModalConfig({
                    type: 'prompt',
                    title,
                    message,
                    onConfirm,
                    onCancel,
                    inputValue: '',
                    placeholder
                });
                setShowModal(true);
            };

            const showInfo = (title, message) => {
                setModalConfig({
                    type: 'info',
                    title,
                    message,
                    onConfirm: null,
                    onCancel: null,
                    inputValue: '',
                    placeholder: ''
                });
                setShowModal(true);
            };
            // FunciÃ³n para lanzar confeti
            const lanzarConfeti = () => {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 }
                    });
                }, 250);
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 }
                    });
                }, 400);
            };
            // FunciÃ³n para abrir WhatsApp
            const enviarWhatsApp = async (cliente, mensaje) => {
                try {
                    let telefono = cliente.telefono;

                    // Si no hay telÃ©fono, pedir al usuario
                    if (!telefono) {
                        showPrompt(
                            'ğŸ“± TelÃ©fono de WhatsApp',
                            `Ingresa el telÃ©fono de ${cliente.nombre}`,
                            '573001234567',
                            async (tel) => {
                                if (!tel) {
                                    pushToast('âŒ Se cancelÃ³ el envÃ­o', 'error');
                                    return;
                                }
                                telefono = tel;

                                // Guardar el telÃ©fono
                                showConfirm(
                                    'ğŸ’¾ Guardar telÃ©fono',
                                    'Â¿Deseas guardar este telÃ©fono en el perfil del cliente?',
                                    async () => {
                                        const { error } = await supabaseClient.from('clientes').update({ telefono }).eq('id', cliente.id);
                                        if (!error) {
                                            pushToast('âœ… TelÃ©fono guardado');
                                            setClientes(prev => prev.map(c => c.id === cliente.id ? { ...c, telefono } : c));
                                        } else {
                                            console.error('Error guardando telÃ©fono:', error);
                                        }
                                    }
                                );

                                // Continuar con WhatsApp
                                telefono = telefono.replace(/[\s\-\(\)]/g, '');
                                if (!telefono.startsWith('+')) {
                                    telefono = '+' + telefono;
                                }
                                const mensajeEncoded = encodeURIComponent(mensaje);
                                const url = `https://wa.me/${telefono.replace('+', '')}?text=${mensajeEncoded}`;
                                window.open(url, '_blank');
                                pushToast('âœ… Abriendo WhatsApp...', 'success');
                            },
                            () => {
                                pushToast('âŒ Se cancelÃ³ el envÃ­o', 'error');
                            }
                        );
                        return;
                    }

                    // Limpiar el nÃºmero (quitar espacios, guiones, etc.)
                    telefono = telefono.replace(/[\s\-\(\)]/g, '');

                    // Si no empieza con +, agregarlo
                    if (!telefono.startsWith('+')) {
                        telefono = '+' + telefono;
                    }

                    // Codificar el mensaje para URL
                    const mensajeEncoded = encodeURIComponent(mensaje);

                    // Crear URL de WhatsApp
                    const url = `https://wa.me/${telefono.replace('+', '')}?text=${mensajeEncoded}`;

                    console.log('ğŸ“± Abriendo WhatsApp con:', url); // Para debug

                    // Abrir WhatsApp
                    window.open(url, '_blank');

                    pushToast('âœ… Abriendo WhatsApp...', 'success');
                } catch (error) {
                    console.error('âŒ Error en WhatsApp:', error);
                    pushToast('Error al abrir WhatsApp: ' + error.message, 'error');
                }
            };

            // FunciÃ³n para generar reporte PDF
            const generarReportePDF = async () => {
                setIsLoading(true);
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // TÃ­tulo
                    doc.setFontSize(20);
                    doc.setTextColor(255, 140, 0);
                    doc.text('Arepas al CarbÃ³n ğŸŒ½', 20, 20);

                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Reporte de Ventas', 20, 30);

                    // Fecha del reporte
                    doc.setFontSize(10);
                    doc.text(`Generado: ${new Date().toLocaleDateString('es-CO')}`, 20, 40);

                    let y = 50;

                    // Resumen general
                    doc.setFontSize(14);
                    doc.text('Resumen General', 20, y);
                    y += 10;

                    doc.setFontSize(10);
                    doc.text(`Total Ventas: ${formatCOP(ventas.reduce((s, v) => s + (parseFloat(v.total) || 0), 0))}`, 20, y);
                    y += 7;
                    doc.text(`Total Abonado: ${formatCOP(ventas.reduce((s, v) => s + (parseFloat(v.abono) || 0), 0))}`, 20, y);
                    y += 7;
                    doc.text(`Deudas Pendientes: ${formatCOP(ventasPendientes)}`, 20, y);
                    y += 7;
                    doc.text(`Balance: ${formatCOP(balanceGlobal)}`, 20, y);
                    y += 15;

                    // Top clientes
                    doc.setFontSize(14);
                    doc.text('Top 5 Clientes', 20, y);
                    y += 10;

                    const topClientes = calcularTopClientes().slice(0, 5);
                    doc.setFontSize(9);
                    topClientes.forEach((cliente, idx) => {
                        doc.text(`${idx + 1}. ${cliente.nombre} - ${formatCOP(cliente.totalCompras)}`, 20, y);
                        y += 6;
                    });

                    doc.save('reporte-arepas.pdf');
                    pushToast('ğŸ“„ Reporte descargado');
                } catch (error) {
                    console.error('Error generando PDF:', error);
                    pushToast('Error al generar reporte', 'error');
                } finally {
                    setIsLoading(false);
                }
            };
            // Generar reporte Excel con comparaciÃ³n
            const generarReporteExcel = async () => {
                if (!fechaDesdeExcel || !fechaHastaExcel) {
                    pushToast('Selecciona ambas fechas', 'error');
                    return;
                }

                setIsLoading(true);
                setMostrarModalExcel(false);

                try {
                    const desde = new Date(fechaDesdeExcel);
                    const hasta = new Date(fechaHastaExcel);

                    // Calcular mes anterior para comparaciÃ³n
                    const mesAnteriorDesde = new Date(desde);
                    mesAnteriorDesde.setMonth(mesAnteriorDesde.getMonth() - 1);
                    const mesAnteriorHasta = new Date(hasta);
                    mesAnteriorHasta.setMonth(mesAnteriorHasta.getMonth() - 1);

                    const filtrarFecha = (fecha, inicio, fin) => {
                        const f = new Date(fecha);
                        return f >= inicio && f <= fin;
                    };

                    // Datos perÃ­odo actual
                    const ventasActual = ventas.filter(v => v.fecha && filtrarFecha(v.fecha, desde, hasta));
                    const ingresosActual = ingresos.filter(i => i.fecha && filtrarFecha(i.fecha, desde, hasta));
                    const egresosActual = egresos.filter(e => e.fecha && filtrarFecha(e.fecha, desde, hasta));

                    // Datos mes anterior
                    const ventasAnterior = ventas.filter(v => v.fecha && filtrarFecha(v.fecha, mesAnteriorDesde, mesAnteriorHasta));
                    const ingresosAnterior = ingresos.filter(i => i.fecha && filtrarFecha(i.fecha, mesAnteriorDesde, mesAnteriorHasta));
                    const egresosAnterior = egresos.filter(e => e.fecha && filtrarFecha(e.fecha, mesAnteriorDesde, mesAnteriorHasta));

                    // Calcular totales actuales
                    const totalVentasActual = ventasActual.reduce((s, v) => s + (parseFloat(v.total) || 0), 0);
                    const totalAbonosActual = ventasActual.reduce((s, v) => s + (parseFloat(v.abono) || 0), 0);
                    const totalIngresosActual = ingresosActual.reduce((s, i) => s + (parseFloat(i.monto) || 0), 0);
                    const totalEgresosActual = egresosActual.reduce((s, e) => s + (parseFloat(e.monto) || 0), 0);
                    const balanceActual = totalIngresosActual - totalEgresosActual;

                    // Calcular totales anteriores
                    const totalVentasAnterior = ventasAnterior.reduce((s, v) => s + (parseFloat(v.total) || 0), 0);
                    const totalAbonosAnterior = ventasAnterior.reduce((s, v) => s + (parseFloat(v.abono) || 0), 0);
                    const totalIngresosAnterior = ingresosAnterior.reduce((s, i) => s + (parseFloat(i.monto) || 0), 0);
                    const totalEgresosAnterior = egresosAnterior.reduce((s, e) => s + (parseFloat(e.monto) || 0), 0);
                    const balanceAnterior = totalIngresosAnterior - totalEgresosAnterior;

                    // Calcular variaciones
                    const varVentas = totalVentasAnterior > 0 ? ((totalVentasActual - totalVentasAnterior) / totalVentasAnterior * 100).toFixed(2) : 0;
                    const varIngresos = totalIngresosAnterior > 0 ? ((totalIngresosActual - totalIngresosAnterior) / totalIngresosAnterior * 100).toFixed(2) : 0;
                    const varEgresos = totalEgresosAnterior > 0 ? ((totalEgresosActual - totalEgresosAnterior) / totalEgresosAnterior * 100).toFixed(2) : 0;
                    const varBalance = balanceAnterior > 0 ? ((balanceActual - balanceAnterior) / balanceAnterior * 100).toFixed(2) : 0;

                    // Crear libro de Excel
                    const wb = XLSX.utils.book_new();
                    // HOJA 1: RESUMEN COMPARATIVO
                    const resumenData = [
                        ['ğŸ«“ AREPAS AL CARBÃ“N ğŸŒ½'],
                        ['REPORTE FINANCIERO COMPARATIVO'],
                        [''],
                        ['Generado:', new Date().toLocaleString('es-CO')],
                        [''],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [''],
                        ['ğŸ“Š PERÃODO ACTUAL:', `${desde.toLocaleDateString('es-CO')} al ${hasta.toLocaleDateString('es-CO')}`],
                        ['ğŸ“… PERÃODO ANTERIOR:', `${mesAnteriorDesde.toLocaleDateString('es-CO')} al ${mesAnteriorHasta.toLocaleDateString('es-CO')}`],
                        [''],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [''],
                        ['CONCEPTO', 'PERÃODO ACTUAL', 'PERÃODO ANTERIOR', 'DIFERENCIA', '% CAMBIO'],
                        ['â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'],
                    ];

                    const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                    wsResumen['!cols'] = [{ wch: 20 }, { wch: 18 }, { wch: 18 }, { wch: 15 }, { wch: 12 }];
                    // Estilo para la hoja (ancho de columnas)
                    wsResumen['!cols'] = [
                        { wch: 25 }, // Concepto
                        { wch: 20 }, // PerÃ­odo Actual
                        { wch: 20 }, // PerÃ­odo Anterior
                        { wch: 18 }, // Diferencia
                        { wch: 15 }  // % Cambio
                    ];

                    // Combinar celdas del tÃ­tulo
                    wsResumen['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }, // TÃ­tulo principal
                        { s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }  // SubtÃ­tulo
                    ];
                    XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen Comparativo');

                    // HOJA 2: DETALLE VENTAS
                    const ventasDetalle = [
                        ['DETALLE DE VENTAS - PERÃODO ACTUAL'],
                        [''],
                        ['Fecha', 'Cliente', 'Cantidad', 'Tipo', 'Total', 'Abono', 'Saldo', 'Estado']
                    ];

                    ventasActual.forEach(v => {
                        ventasDetalle.push([
                            v.fecha ? new Date(v.fecha).toLocaleDateString('es-CO') : '',
                            v.clientes?.nombre || '',
                            v.cantidad,
                            v.tipo_cantidad,
                            parseFloat(v.total) || 0,
                            parseFloat(v.abono) || 0,
                            (parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0),
                            v.estado_pago
                        ]);
                    });

                    const wsVentas = XLSX.utils.aoa_to_sheet(ventasDetalle);
                    wsVentas['!cols'] = [{ wch: 12 }, { wch: 20 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, wsVentas, 'Detalle Ventas');

                    // HOJA 3: TOP CLIENTES
                    const topClientes = calcularTopClientes().slice(0, 10);
                    const topClientesData = [
                        ['TOP 10 CLIENTES'],
                        [''],
                        ['Ranking', 'Cliente', 'Total Comprado', 'Cantidad Compras', 'Ãšltima Compra']
                    ];

                    topClientes.forEach((cliente, idx) => {
                        topClientesData.push([
                            idx + 1,
                            cliente.nombre,
                            cliente.totalCompras,
                            cliente.cantidadCompras,
                            cliente.ultimaCompra ? cliente.ultimaCompra.toLocaleDateString('es-CO') : 'N/A'
                        ]);
                    });

                    const wsTop = XLSX.utils.aoa_to_sheet(topClientesData);
                    wsTop['!cols'] = [{ wch: 10 }, { wch: 25 }, { wch: 18 }, { wch: 18 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, wsTop, 'Top Clientes');

                    // HOJA 4: INGRESOS
                    const ingresosDetalle = [
                        ['DETALLE DE INGRESOS'],
                        [''],
                        ['Fecha', 'Concepto', 'CategorÃ­a', 'Monto']
                    ];

                    ingresosActual.forEach(i => {
                        ingresosDetalle.push([
                            i.fecha ? new Date(i.fecha).toLocaleDateString('es-CO') : '',
                            i.concepto,
                            i.categoria || '',
                            parseFloat(i.monto) || 0
                        ]);
                    });

                    const wsIngresos = XLSX.utils.aoa_to_sheet(ingresosDetalle);
                    wsIngresos['!cols'] = [{ wch: 12 }, { wch: 40 }, { wch: 15 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, wsIngresos, 'Ingresos');

                    // HOJA 5: EGRESOS
                    const egresosDetalle = [
                        ['DETALLE DE EGRESOS'],
                        [''],
                        ['Fecha', 'Concepto', 'CategorÃ­a', 'Monto']
                    ];

                    egresosActual.forEach(e => {
                        egresosDetalle.push([
                            e.fecha ? new Date(e.fecha).toLocaleDateString('es-CO') : '',
                            e.concepto,
                            e.categoria || '',
                            parseFloat(e.monto) || 0
                        ]);
                    });

                    const wsEgresos = XLSX.utils.aoa_to_sheet(egresosDetalle);
                    wsEgresos['!cols'] = [{ wch: 12 }, { wch: 40 }, { wch: 15 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, wsEgresos, 'Egresos');

                    // Descargar archivo
                    const nombreArchivo = `Reporte_Arepas_${desde.toISOString().split('T')[0]}_a_${hasta.toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, nombreArchivo);

                    pushToast('ğŸ“Š Reporte Excel descargado con Ã©xito');

                } catch (error) {
                    console.error('Error generando Excel:', error);
                    pushToast('Error al generar reporte', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            // Calcular top clientes
            const calcularTopClientes = () => {
                const clientesData = clientes.filter(c => c.activo !== false).map(cliente => {
                    const ventasCliente = ventas.filter(v => v.cliente_id === cliente.id);
                    const totalCompras = ventasCliente.reduce((s, v) => s + (parseFloat(v.total) || 0), 0);
                    const ultimaCompra = ventasCliente.length > 0
                        ? new Date(Math.max(...ventasCliente.map(v => new Date(v.fecha || 0))))
                        : null;
                    const cantidadCompras = ventasCliente.length;

                    return {
                        ...cliente,
                        totalCompras,
                        ultimaCompra,
                        cantidadCompras,
                        diasSinComprar: ultimaCompra ? Math.floor((new Date() - ultimaCompra) / (1000 * 60 * 60 * 24)) : 9999
                    };
                });

                return clientesData.sort((a, b) => b.totalCompras - a.totalCompras);
            };

            // Calcular clientes inactivos (mÃ¡s de 30 dÃ­as sin comprar)
            const calcularClientesInactivos = () => {
                return calcularTopClientes().filter(c => c.diasSinComprar > 30 && c.cantidadCompras > 0);
            };

            // Cliente del mes
            const calcularClienteDelMes = () => {
                const inicioMes = new Date();
                inicioMes.setDate(1);
                inicioMes.setHours(0, 0, 0, 0);

                const ventasMes = ventas.filter(v => new Date(v.fecha) >= inicioMes);

                const clientesMes = {};
                ventasMes.forEach(v => {
                    if (!clientesMes[v.cliente_id]) {
                        clientesMes[v.cliente_id] = {
                            total: 0,
                            cantidad: 0,
                            cliente: clientes.find(c => c.id === v.cliente_id)
                        };
                    }
                    clientesMes[v.cliente_id].total += parseFloat(v.total) || 0;
                    clientesMes[v.cliente_id].cantidad += 1;
                });

                const topDelMes = Object.values(clientesMes).sort((a, b) => b.total - a.total)[0];
                return topDelMes || null;
            };
            const removeToast = (id) => setToasts(t => t.filter(x => x.id !== id));

            useEffect(() => { checkUserAndLoad(); }, []);
            // Atajos de teclado
            useEffect(() => {
                const handleKeyboard = (e) => {
                    // Alt + V = Nueva venta (V de venta)
                    if (e.altKey && e.key === 'v') {
                        e.preventDefault();
                        setActiveTab('ventas');
                        pushToast('ğŸ“ PestaÃ±a Ventas', 'success');
                    }

                    // Alt + C = Nuevo cliente
                    if (e.altKey && e.key === 'c') {
                        e.preventDefault();
                        setActiveTab('clientes');
                        pushToast('ğŸ“ PestaÃ±a Clientes', 'success');
                    }

                    // Alt + K = Calculadora
                    if (e.altKey && e.key === 'k') {
                        e.preventDefault();
                        setShowCalculadora(true);
                    }

                    // Alt + D = Dashboard
                    if (e.altKey && e.key === 'd') {
                        e.preventDefault();
                        setActiveTab('dashboard');
                        pushToast('ğŸ“ Dashboard', 'success');
                    }

                    // Alt + R = Resumen
                    if (e.altKey && e.key === 'r') {
                        e.preventDefault();
                        setActiveTab('resumen');
                        pushToast('ğŸ“ Resumen', 'success');
                    }

                    // Alt + E = Generar Excel
                    if (e.altKey && e.key === 'e') {
                        e.preventDefault();
                        setMostrarModalExcel(true);
                    }

                    // Esc = Cerrar modales
                    if (e.key === 'Escape') {
                        setNotaModal(null);
                        setMostrarPerfilCliente(false);
                        setShowCalculadora(false);
                        setShowKeyboardShortcuts(false);
                    }

                    // ? = Mostrar atajos (Shift + /)
                    if (e.shiftKey && e.key === '?') {
                        e.preventDefault();
                        setShowKeyboardShortcuts(true);
                    }

                    // / = Buscar cliente (solo si no estÃ¡ en un input)
                    if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                        e.preventDefault();
                        const searchInput = document.querySelector('[data-search-clientes]');
                        if (searchInput) {
                            searchInput.focus();
                            pushToast('ğŸ” Buscador activado', 'success');
                        }
                    }
                };

                if (user) {
                    window.addEventListener('keydown', handleKeyboard);
                    return () => window.removeEventListener('keydown', handleKeyboard);
                }
            }, [user]);
            const checkUserAndLoad = async () => {
                setLoading(true);
                const { data: { session } } = await supabaseClient.auth.getSession();
                setUser(session?.user || null);
                if (session?.user) await loadData();
                setLoading(false);
            };

            const loadData = async () => {
                setIsLoading(true);
                try {
                    const { data: cl } = await supabaseClient.from('clientes').select('*').order('created_at', { ascending: false });
                    const { data: vs, error: errorVentas } = await supabaseClient.from('ventas').select('*, clientes(nombre)').order('fecha', { ascending: false });
                    if (errorVentas) {
                        console.error('Error cargando ventas:', errorVentas);
                        pushToast('Error al cargar ventas', 'error');
                    }
                    const { data: ing } = await supabaseClient.from('ingresos').select('*').order('fecha', { ascending: false });
                    const { data: egr } = await supabaseClient.from('egresos').select('*').order('fecha', { ascending: false });
                    const { data: notas } = await supabaseClient.from('notas_calendario').select('*').order('fecha', { ascending: true });
                    console.log('ğŸ“… Notas cargadas:', notas); // TEMPORAL para debug
                    setNotasCalendario(notas || []);
                    const { data: comp } = await supabaseClient.from('compras_materia_prima').select('*').order('fecha', { ascending: false });
                    setCompras(comp || []);
                    setClientes(cl || []);
                    setVentas(vs || []);
                    setIngresos(ing || []);
                    setEgresos(egr || []);
                    // Cargar fecha del Ãºltimo reinicio
                    const { data: config } = await supabaseClient
                        .from('configuracion_sistema')
                        .select('*')
                        .eq('clave', 'fecha_ultimo_reinicio')
                        .single();

                    if (config && config.valor) {
                        setFechaUltimoReinicio(config.valor);
                    }

                    // Cargar historial de resÃºmenes
                    const { data: hist } = await supabaseClient
                        .from('historial_resumenes')
                        .select('*')
                        .order('created_at', { ascending: false });
                    setHistorialResumenes(hist || []);
                } catch (err) {
                    console.error(err);
                    pushToast('Error cargando datos', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleLogout = async () => { await supabaseClient.auth.signOut(); setUser(null); setShowLanding(true); pushToast('SesiÃ³n cerrada'); };

            const addCliente = async (e) => {
                e.preventDefault();
                const payload = {
                    nombre: clienteForm.nombre,
                    direccion: clienteForm.direccion || null,
                    tipo_cliente: clienteForm.tipo_cliente,
                    dia_entrega: clienteForm.dia_entrega || null,
                    precio_especial: clienteForm.precio_especial ? parseFloat(clienteForm.precio_especial) : null,
                    telefono: clienteForm.telefono || null,
                    notas: clienteForm.notas || null,
                    activo: true
                };
                const { data, error } = await supabaseClient.from('clientes').insert(payload).select();
                if (error) {
                    console.error('ERROR CLIENTE:', error);
                    pushToast('Error: ' + error.message, 'error');
                } else {
                    pushToast('âœ… Cliente agregado');
                    setClienteForm({ nombre: '', direccion: '', tipo_cliente: 'Individual', dia_entrega: '', precio_especial: '', telefono: '', notas: '' });
                    loadData();
                }
            };

            const updateTipoCliente = async (id, tipo) => {
                const { error } = await supabaseClient.from('clientes').update({ tipo_cliente: tipo }).eq('id', id);
                if (error) {
                    console.error('ERROR UPDATE:', error);
                    pushToast('Error al actualizar', 'error');
                } else {
                    setClientes(cs => cs.map(c => c.id === id ? { ...c, tipo_cliente: tipo } : c));
                    pushToast('Tipo actualizado');
                }
            };

            const deleteCliente = async (id) => {
                showConfirm(
                    'ğŸ—‘ï¸ Eliminar Cliente',
                    'Â¿EstÃ¡s seguro de eliminar este cliente?\n\nEsta acciÃ³n no se puede deshacer.',
                    async () => {
                        const { error } = await supabaseClient.from('clientes').update({ activo: false }).eq('id', id);
                        if (error) {
                            console.error('ERROR DELETE:', error);
                            pushToast('Error al eliminar', 'error');
                        } else {
                            pushToast('Cliente eliminado', 'success');
                            loadData();
                        }
                    }
                );
            };
            useEffect(() => {
                if (ventaForm.cantidad && ventaForm.tipo_cantidad) {
                    const cantidad = parseInt(ventaForm.cantidad) || 0;
                    const precioUnitario = ventaForm.tipo_cantidad === 'Unidades' ? precioUnidad : precioPaquete;
                    const sugerido = cantidad * precioUnitario;
                    setVentaForm(v => ({ ...v, precio_unitario: precioUnitario, precio_sugerido: sugerido }));
                }
            }, [ventaForm.cantidad, ventaForm.tipo_cantidad, precioUnidad, precioPaquete]);

            const addVenta = async (e) => {
                e.preventDefault();
                setIsLoading(true);

                // AnimaciÃ³n de shake en el botÃ³n
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.classList.add('shake');

                try {
                    const total = parseFloat(ventaForm.total) || 0;
                    const abono = parseFloat(ventaForm.abono) || 0;
                    const fechaISO = ventaForm.fecha ? new Date(ventaForm.fecha).toISOString() : new Date().toISOString();

                    const payload = {
                        cliente_id: parseInt(ventaForm.cliente_id),
                        semana: ventaForm.semana || null,
                        tipo_venta: ventaForm.tipo_venta,
                        cantidad: parseInt(ventaForm.cantidad) || 0,
                        tipo_cantidad: ventaForm.tipo_cantidad,
                        precio_unitario: parseFloat(ventaForm.precio_unitario) || 0,
                        total: total,
                        estado_pago: ventaForm.estado_pago,
                        fecha: fechaISO,
                        payment_type: ventaForm.payment_type,
                        abono: abono,
                        notas: ventaForm.notas || null,
                        usuario_id: user?.id
                    };

                    const { data: ventaCreada, error } = await supabaseClient.from('ventas').insert(payload).select();

                    if (error) {
                        console.error('ERROR VENTA:', error);
                        pushToast('Error: ' + error.message, 'error');
                        return;
                    }

                    const ventaId = ventaCreada?.[0]?.id;

                    // Registrar ingreso si estÃ¡ pagado completamente
                    if (ventaForm.estado_pago === 'Pagado' && ventaId) {
                        await supabaseClient.from('ingresos').insert({
                            concepto: `Venta - ${clienteDisplay(ventaForm.cliente_id)} [ID:${ventaId}]`,
                            monto: total,
                            categoria: 'Venta',
                            fecha: fechaISO,
                            notas: `venta_id:${ventaId}`
                        }).select();

                        // ğŸ‰ CONFETI si estÃ¡ pagado!
                        lanzarConfeti();
                    }
                    // Registrar ingreso por abono parcial
                    else if (abono > 0 && ventaId) {
                        await supabaseClient.from('ingresos').insert({
                            concepto: `Abono - ${clienteDisplay(ventaForm.cliente_id)} [ID:${ventaId}]`,
                            monto: abono,
                            categoria: 'Abono',
                            fecha: fechaISO,
                            notas: `venta_id:${ventaId}`
                        }).select();
                    }

                    pushToast('âœ… Venta registrada');
                    setVentaForm({
                        cliente_id: '', semana: '', tipo_venta: 'Individual', cantidad: '',
                        tipo_cantidad: 'Unidades', precio_unitario: '', precio_sugerido: '',
                        total: '', estado_pago: 'Pendiente', fecha: '', payment_type: 'Total',
                        abono: '', notas: ''
                    });

                    await loadData();

                } catch (err) {
                    console.error('Error:', err);
                    pushToast('Error al registrar venta', 'error');
                } finally {
                    setIsLoading(false);
                    if (submitBtn) submitBtn.classList.remove('shake');
                }
            };

            const deleteVenta = async (id) => {
                showConfirm(
                    'ğŸ—‘ï¸ Eliminar Venta',
                    'Â¿EstÃ¡s seguro de eliminar esta venta?',
                    async () => {
                        const { error } = await supabaseClient.from('ventas').delete().eq('id', id);
                        if (error) {
                            console.error('ERROR DELETE VENTA:', error);
                            pushToast('Error al eliminar', 'error');
                        } else {
                            pushToast('Venta eliminada', 'success');
                            loadData();
                        }
                    }
                );
            };

            const setPagoVenta = async (v, action, abonoMonto = 0) => {
                const total = parseFloat(v.total) || 0;
                const actualAbono = parseFloat(v.abono) || 0;

                if (action === 'Pagado') {
                    const { error } = await supabaseClient.from('ventas').update({
                        estado_pago: 'Pagado',
                        abono: total
                    }).eq('id', v.id);

                    if (error) {
                        console.error('Error al actualizar:', error);
                        pushToast('Error: ' + error.message, 'error');
                        return;
                    }

                    await supabaseClient.from('ingresos').insert({
                        concepto: `Venta - ${v.clientes?.nombre} [ID:${v.id}]`,
                        monto: total - actualAbono,
                        categoria: 'Venta',
                        fecha: new Date().toISOString(),
                        notas: `venta_id:${v.id}`
                    }).select();

                    // ğŸ‰ CONFETI!
                    lanzarConfeti();
                    pushToast('âœ… Marcado como pagado');

                } else if (action === 'Abono') {
                    const nuevoAbono = actualAbono + (parseFloat(abonoMonto) || 0);
                    const nuevoEstado = (total - nuevoAbono) <= 0 ? 'Pagado' : 'Pendiente';

                    const { error } = await supabaseClient.from('ventas').update({
                        abono: nuevoAbono,
                        estado_pago: nuevoEstado
                    }).eq('id', v.id);

                    if (error) {
                        console.error('Error al actualizar abono:', error);
                        pushToast('Error: ' + error.message, 'error');
                        return;
                    }

                    await supabaseClient.from('ingresos').insert({
                        concepto: `Abono - ${v.clientes?.nombre} [ID:${v.id}]`,
                        monto: parseFloat(abonoMonto) || 0,
                        categoria: 'Abono',
                        fecha: new Date().toISOString(),
                        notas: `venta_id:${v.id}`
                    }).select();

                    // ğŸ‰ CONFETI si completÃ³ el pago!
                    if (nuevoEstado === 'Pagado') {
                        lanzarConfeti();
                    }

                    pushToast('ğŸ’° Abono registrado');

                } else {
                    const { error } = await supabaseClient.from('ventas').update({
                        estado_pago: 'Pendiente',
                        abono: 0
                    }).eq('id', v.id);

                    if (error) {
                        console.error('Error:', error);
                        pushToast('Error: ' + error.message, 'error');
                        return;
                    }

                    pushToast('â³ Marcado pendiente');
                }

                await loadData();
            };

            const updateFechaVenta = async (id, fecha) => {
                const fechaISO = fecha ? new Date(fecha).toISOString() : null;
                const { error } = await supabaseClient.from('ventas').update({ fecha: fechaISO }).eq('id', id);
                if (error) {
                    console.error('ERROR UPDATE FECHA:', error);
                    pushToast('Error al actualizar', 'error');
                } else {
                    pushToast('Fecha actualizada');
                    loadData();
                }
            };

            const addIngreso = async (e) => {
                e.preventDefault();
                const fechaISO = ingresoForm.fecha ? new Date(ingresoForm.fecha).toISOString() : new Date().toISOString();
                const payload = { concepto: ingresoForm.concepto, monto: parseFloat(ingresoForm.monto) || 0, categoria: ingresoForm.categoria || null, fecha: fechaISO };
                const { error } = await supabaseClient.from('ingresos').insert(payload).select();
                if (error) {
                    console.error('ERROR INGRESO:', error);
                    pushToast('Error: ' + error.message, 'error');
                } else {
                    pushToast('âœ… Ingreso agregado');
                    setIngresoForm({ concepto: '', monto: '', categoria: '', fecha: '' });
                    loadData();
                }
            };

            const addEgreso = async (e) => {
                e.preventDefault();
                const fechaISO = egresoForm.fecha ? new Date(egresoForm.fecha).toISOString() : new Date().toISOString();
                const payload = { concepto: egresoForm.concepto, monto: parseFloat(egresoForm.monto) || 0, categoria: egresoForm.categoria || null, fecha: fechaISO };
                const { error } = await supabaseClient.from('egresos').insert(payload).select();
                if (error) {
                    console.error('ERROR EGRESO:', error);
                    pushToast('Error: ' + error.message, 'error');
                } else {
                    pushToast('âœ… Egreso agregado');
                    setEgresoForm({ concepto: '', monto: '', categoria: '', fecha: '' });
                    loadData();
                }
            };
            const deleteIngreso = async (id) => {
                if (!confirm('Â¿Eliminar? Si es un abono, se descontarÃ¡ de la venta correspondiente.')) return;

                // Obtener el ingreso
                const { data: ingreso, error: errorGet } = await supabaseClient
                    .from('ingresos')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (errorGet) {
                    console.error('ERROR AL OBTENER INGRESO:', errorGet);
                    pushToast('Error al obtener datos', 'error');
                    return;
                }

                // Si es un abono o venta, intentar actualizar la venta correspondiente
                if (ingreso && (ingreso.categoria === 'Abono' || ingreso.categoria === 'Venta')) {
                    let ventaId = null;

                    // MÃ©todo 1: Buscar en las notas
                    if (ingreso.notas && ingreso.notas.includes('venta_id:')) {
                        ventaId = parseInt(ingreso.notas.split('venta_id:')[1]);
                    }
                    // MÃ©todo 2: Buscar en el concepto (formato [ID:123])
                    if (!ventaId && ingreso.concepto && ingreso.concepto.includes('[ID:')) {
                        const match = ingreso.concepto.match(/\[ID:(\d+)\]/);
                        if (match) ventaId = parseInt(match[1]);
                    }

                    // MÃ©todo 3: Buscar formato antiguo "Venta ID:"
                    if (!ventaId && ingreso.concepto && ingreso.concepto.includes('Venta ID:')) {
                        const match = ingreso.concepto.match(/Venta ID:\s*(\d+)/);
                        if (match) ventaId = parseInt(match[1]);
                    }


                    if (ventaId) {
                        // Obtener la venta
                        const { data: venta } = await supabaseClient
                            .from('ventas')
                            .select('*')
                            .eq('id', ventaId)
                            .single();

                        if (venta) {
                            const montoADescontar = parseFloat(ingreso.monto) || 0;
                            const abonoActual = parseFloat(venta.abono) || 0;
                            const totalVenta = parseFloat(venta.total) || 0;
                            const nuevoAbono = Math.max(0, abonoActual - montoADescontar);
                            const nuevoEstado = nuevoAbono >= totalVenta ? 'Pagado' : 'Pendiente';

                            const { error: errorUpdate } = await supabaseClient
                                .from('ventas')
                                .update({
                                    abono: nuevoAbono,
                                    estado_pago: nuevoEstado
                                })
                                .eq('id', ventaId);

                            if (!errorUpdate) {
                                console.log(`âœ… Abono actualizado en venta ${ventaId}: $${abonoActual} -> $${nuevoAbono}`);
                            } else {
                                console.error('Error al actualizar venta:', errorUpdate);
                            }
                        }
                    } else {
                        console.log('âš ï¸ No se encontrÃ³ ID de venta asociada a este ingreso');
                    }
                }

                // Eliminar el ingreso
                const { error } = await supabaseClient.from('ingresos').delete().eq('id', id);

                if (error) {
                    console.error('ERROR DELETE INGRESO:', error);
                    pushToast('Error al eliminar', 'error');
                } else {
                    pushToast('âœ… Eliminado correctamente', 'success');
                    await loadData();
                }
            };


            const deleteEgreso = async (id) => {
                if (!confirm('Â¿Eliminar?')) return;
                const { error } = await supabaseClient.from('egresos').delete().eq('id', id);
                if (error) {
                    console.error('ERROR DELETE EGRESO:', error);
                    pushToast('Error', 'error');
                } else {
                    pushToast('Eliminado', 'error');
                    loadData();
                }
            };
            const addPedido = async (e) => {
                e.preventDefault();
                const payload = {
                    fecha: new Date(pedidoForm.fecha).toISOString(),
                    cliente_id: parseInt(pedidoForm.cliente_id),
                    cantidad: parseInt(pedidoForm.cantidad),
                    tipo_cantidad: pedidoForm.tipo_cantidad,
                    notas: pedidoForm.notas || null,
                    procesado: false
                };
                const { error } = await supabaseClient.from('pedidos_programados').insert(payload).select();
                if (error) {
                    console.error('ERROR PEDIDO:', error);
                    pushToast('Error: ' + error.message, 'error');
                } else {
                    pushToast('âœ… Pedido agregado');
                    setPedidoForm({ fecha: '', cliente_id: '', cantidad: '', tipo_cantidad: 'Unidades', notas: '' });
                    loadData();
                }
            };

            const deletePedido = async (id) => {
                if (!confirm('Â¿Eliminar pedido?')) return;
                const { error } = await supabaseClient.from('pedidos_programados').delete().eq('id', id);
                if (error) {
                    console.error('ERROR DELETE PEDIDO:', error);
                    pushToast('Error', 'error');
                } else {
                    pushToast('Pedido eliminado', 'error');
                    loadData();
                }
            };

            const procesarPedidosFecha = async (fecha) => {
                if (!confirm(`Â¿Convertir todos los pedidos del ${fecha} en ventas?`)) return;

                const pedidosFecha = pedidosProgramados.filter(p =>
                    p.fecha && p.fecha.slice(0, 10) === fecha && !p.procesado
                );

                if (pedidosFecha.length === 0) {
                    pushToast('No hay pedidos para procesar', 'warning');
                    return;
                }

                try {
                    for (const pedido of pedidosFecha) {
                        const precioUnitario = pedido.tipo_cantidad === 'Unidades' ? 600 : 6000;
                        const total = pedido.cantidad * precioUnitario;

                        // Crear venta
                        const ventaPayload = {
                            cliente_id: pedido.cliente_id,
                            cantidad: pedido.cantidad,
                            tipo_cantidad: pedido.tipo_cantidad,
                            precio_unitario: precioUnitario,
                            total: total,
                            estado_pago: 'Pendiente',
                            fecha: new Date(pedido.fecha).toISOString(),
                            abono: 0,
                            notas: pedido.notas ? `[Pedido programado] ${pedido.notas}` : '[Pedido programado]',
                            usuario_id: user?.id
                        };

                        await supabaseClient.from('ventas').insert(ventaPayload).select();

                        // Marcar pedido como procesado
                        await supabaseClient.from('pedidos_programados').update({ procesado: true }).eq('id', pedido.id);
                    }

                    pushToast(`âœ… ${pedidosFecha.length} pedido(s) convertidos en ventas`);
                    loadData();
                } catch (err) {
                    console.error('Error procesando pedidos:', err);
                    pushToast('Error al procesar pedidos', 'error');
                }
            };

            const limpiarListaFecha = async (fecha) => {
                if (!confirm(`Â¿Eliminar TODOS los pedidos del ${fecha}?`)) return;

                const pedidosFecha = pedidosProgramados.filter(p =>
                    p.fecha && p.fecha.slice(0, 10) === fecha
                );

                try {
                    for (const pedido of pedidosFecha) {
                        await supabaseClient.from('pedidos_programados').delete().eq('id', pedido.id);
                    }
                    pushToast(`âœ… Lista del ${fecha} eliminada`);
                    setFechaSeleccionadaPedidos('');
                    loadData();
                } catch (err) {
                    console.error('Error:', err);
                    pushToast('Error al limpiar lista', 'error');
                }
            };
            const abrirPerfilCliente = (cliente) => {
                setClienteSeleccionado(cliente);
                setMostrarPerfilCliente(true);
            };

            const clienteDisplay = (id) => { const c = clientes.find(x => x.id === parseInt(id)); return c?.nombre || 'Cliente'; };
            const ventasFiltradas = ventas.filter(v => {
                if (filterDate) {
                    if (!v.fecha) return false;
                    if (v.fecha.slice(0, 10) !== filterDate) return false;
                }
                if (filterEstado === 'Pagadas') return v.estado_pago === 'Pagado';
                if (filterEstado === 'Pendientes') return v.estado_pago === 'Pendiente';
                return true;
            }).sort((a, b) => {
                if (ordenAlfabetico) {
                    return (a.clientes?.nombre || '').localeCompare(b.clientes?.nombre || '', 'es', { sensitivity: 'base' });
                }
                return 0;
            });
            const calcularResumen = () => {
                try {
                    const desde = resDesde ? new Date(resDesde) : (fechaUltimoReinicio ? new Date(fechaUltimoReinicio) : new Date('2000-01-01'));
                    const hasta = resHasta ? new Date(resHasta) : new Date();
                    hasta.setHours(23, 59, 59, 999); // Incluir todo el dÃ­a

                    const filtrarFecha = (f) => {
                        if (!f) return false;
                        try {
                            const fecha = new Date(f);
                            return fecha >= desde && fecha <= hasta;
                        } catch (err) {
                            console.error('Error procesando fecha:', f, err);
                            return false;
                        }
                    };

                    const ventasFil = ventas.filter(v => v.fecha && filtrarFecha(v.fecha));
                    const ingFil = ingresos.filter(i => i.fecha && filtrarFecha(i.fecha));
                    const egrFil = egresos.filter(e => e.fecha && filtrarFecha(e.fecha));

                    const totalVentas = ventasFil.reduce((s, v) => (s + (parseFloat(v.total) || 0)), 0);
                    const totalAbonos = ventasFil.reduce((s, v) => (s + (parseFloat(v.abono) || 0)), 0);
                    const totalSaldo = totalVentas - totalAbonos;
                    const totalIngresos = ingFil.reduce((s, i) => (s + (parseFloat(i.monto) || 0)), 0);
                    const totalEgresos = egrFil.reduce((s, e) => (s + (parseFloat(e.monto) || 0)), 0);

                    return { totalVentas, totalAbonos, totalSaldo, totalIngresos, totalEgresos };
                } catch (error) {
                    console.error('Error en calcularResumen:', error);
                    return { totalVentas: 0, totalAbonos: 0, totalSaldo: 0, totalIngresos: 0, totalEgresos: 0 };
                }
            };

            const resumen = calcularResumen();
            const totalIngresosGlobal = ingresos.reduce((s, i) => s + (parseFloat(i.monto) || 0), 0);
            const totalEgresosGlobal = egresos.reduce((s, e) => s + (parseFloat(e.monto) || 0), 0);
            const balanceGlobal = totalIngresosGlobal - totalEgresosGlobal;
            const ventasPendientes = ventas.filter(v => v.estado_pago === 'Pendiente').reduce((s, v) => s + (parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0), 0);

            if (showLanding) return <LandingPage onEnter={() => setShowLanding(false)} />;
            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-amber-100 to-orange-100"><div className="text-center"><div className="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-orange-600"></div><p className="mt-4 text-xl font-semibold text-gray-700">Cargando...</p></div></div>;
            if (!user) return <LoginPage onLogin={setUser} />;

            return (
                <div className={`min-h-screen transition-colors duration-300 ${darkMode ? 'bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900' : 'bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50'}`}>
                    <div className="bg-gradient-to-r from-amber-700 via-orange-600 to-yellow-600 text-white p-3 md:p-4 shadow-2xl sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
                            <div className="flex items-center gap-4">
                                <div className="bg-white/20 backdrop-blur-sm p-3 rounded-full shadow-lg pulse-hover">
                                    <span className="text-4xl">ğŸ«“</span>
                                </div>
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold">Arepas al Carbon ğŸŒ½ğŸ«“</h1>
                                    <p className="text-amber-100 text-sm">Aqui to`cuadra... menos la dieta  ğŸ˜‚   Facturamos en brasa, compae </p>
                                </div>
                            </div>
                            <div className="flex gap-1 md:gap-2 flex-wrap justify-end w-full md:w-auto">
                                <button
                                    onClick={() => setMostrarModalExcel(true)}
                                    className="hidden md:block bg-white/20 hover:bg-white/30 px-3 md:px-4 py-2 rounded-lg font-medium transition backdrop-blur-sm text-sm"
                                    title="Generar reporte Excel (Alt + E)">
                                    ğŸ“Š Excel
                                </button>
                                <button
                                    onClick={() => setShowCalculadora(true)}
                                    className="bg-white/20 hover:bg-white/30 px-3 md:px-4 py-2 rounded-lg font-medium transition backdrop-blur-sm text-sm"
                                    title="Calculadora rÃ¡pida (Alt + K)">
                                    <span className="hidden md:inline">ğŸ§® Calculadora</span>
                                    <span className="md:hidden">ğŸ§®</span>
                                </button>
                                <button
                                    onClick={() => setShowKeyboardShortcuts(true)}
                                    className="hidden md:block bg-white/20 hover:bg-white/30 px-3 md:px-4 py-2 rounded-lg font-medium transition backdrop-blur-sm text-sm"
                                    title="Ver atajos de teclado (Shift + ?)">
                                    âŒ¨ï¸ Atajos
                                </button>
                                <button
                                    onClick={() => setDarkMode(!darkMode)}
                                    className="bg-white/20 hover:bg-white/30 px-3 md:px-4 py-2 rounded-lg font-medium transition backdrop-blur-sm text-sm">
                                    <span className="hidden md:inline">{darkMode ? 'ğŸ”¥ CalentÃ¡ la arepa, ve' : 'â˜ ï¸ Ya, que huele a quemao'}</span>
                                    <span className="md:hidden">{darkMode ? 'ğŸ”¥' : 'â˜ ï¸'}</span>
                                </button>
                                {/* MenÃº de 3 puntos en mÃ³vil */}
                                <div className="relative md:hidden">
                                    <button
                                        onClick={() => setShowMenu(!showMenu)}
                                        className="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg font-medium transition backdrop-blur-sm text-xl">
                                        â‹®
                                    </button>

                                    {showMenu && (
                                        <>
                                            <div
                                                className="fixed inset-0 z-40"
                                                onClick={() => setShowMenu(false)}
                                            />
                                            <div className={`absolute right-0 top-12 z-50 ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-200'} border-2 rounded-xl shadow-2xl w-56 py-2 max-h-[80vh] overflow-y-auto`}>
                                                {/* Secciones principales */}
                                                <button
                                                    onClick={() => {
                                                        setActiveTab('dashboard');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'dashboard' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ“Š</span> Inicio
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setActiveTab('clientes');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'clientes' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ‘¥</span> Clientes
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setActiveTab('ventas');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'ventas' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ›’</span> Ventas
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setActiveTab('historial');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'historial' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ“‹</span> Historial Compras
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setActiveTab('calendario');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'calendario' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ“…</span> Calendario
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setActiveTab('contabilidad');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'contabilidad' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ’°</span> Contabilidad
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setActiveTab('compras');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'compras' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ›ï¸</span> Compras
                                                </button>

                                                <button
                                                    onClick={() => {
                                                        setActiveTab('resumen');
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${activeTab === 'resumen' ? 'bg-orange-500 text-white' : darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ“ˆ</span> Resumen
                                                </button>

                                                {/* Separador */}
                                                <div className={`my-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}></div>

                                                {/* Opciones adicionales */}
                                                <button
                                                    onClick={() => {
                                                        setMostrarModalExcel(true);
                                                        setShowMenu(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${darkMode ? 'hover:bg-gray-700 text-white' : 'hover:bg-gray-100 text-gray-800'}`}>
                                                    <span>ğŸ“Š</span> Generar Excel
                                                </button>

                                                {/* Separador */}
                                                <div className={`my-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}></div>

                                                {/* Salir */}
                                                <button
                                                    onClick={() => {
                                                        setShowMenu(false);
                                                        handleLogout();
                                                    }}
                                                    className={`w-full text-left px-4 py-3 font-medium transition flex items-center gap-2 ${darkMode ? 'hover:bg-red-700 text-red-300' : 'hover:bg-red-100 text-red-700'}`}>
                                                    <span>ğŸšª</span> Salir
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                            <button
                                onClick={handleLogout}
                                className="hidden md:block bg-white/20 hover:bg-white/30 px-3 md:px-4 py-2 rounded-lg font-medium transition backdrop-blur-sm text-sm">
                                ğŸšª Salir
                            </button>
                        </div>
                    </div>
                    <div className={`hidden md:flex border-b shadow-lg sticky top-16 z-10 overflow-x-auto scrollbar-hide ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                        {[
                            { id: 'dashboard', label: 'Inicio', icon: 'ğŸ“Š' },
                            { id: 'clientes', label: 'Clientes', icon: 'ğŸ‘¥' },
                            { id: 'ventas', label: 'Ventas', icon: 'ğŸ›’' },
                            { id: 'historial', label: 'Historial Compras', icon: 'ğŸ“‹' },
                            { id: 'calendario', label: 'Calendario', icon: 'ğŸ“…' },
                            { id: 'contabilidad', label: 'Contabilidad', icon: 'ğŸ’°' },
                            { id: 'compras', label: 'Compras', icon: 'ğŸ›’' },
                            { id: 'resumen', label: 'Resumen', icon: 'ğŸ“ˆ' }
                        ].map(tab => (
                            <button key={tab.id} onClick={() => { setActiveTab(tab.id); setFilterDate(''); setFilterEstado('Todos'); }} className={`flex items-center gap-2 px-6 py-4 font-semibold transition-all whitespace-nowrap ${activeTab === tab.id ? 'border-b-4 border-orange-600 text-orange-600 bg-orange-50' : darkMode ? 'text-gray-300 hover:text-orange-400 hover:bg-gray-700' : 'text-gray-600 hover:text-orange-600 hover:bg-amber-50'}`}>
                                <span className="text-xl">{tab.icon}</span>{tab.label}
                            </button>
                        ))}
                    </div>

                    <div className={`max-w-7xl mx-auto p-4 md:p-6 ${darkMode ? 'text-white' : ''}`}>
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition pulse-hover">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <p className="text-blue-100 text-sm font-medium">Clientes Activos</p>
                                                <p className="text-4xl font-bold mt-2">{clientes.filter(c => c.activo !== false).length}</p>
                                            </div>
                                            <span className="text-5xl opacity-80">ğŸ‘¥</span>
                                        </div>
                                        <div className="text-xs text-blue-100">{clientes.filter(c => c.tipo_cliente === 'Contrato').length} contratos</div>
                                    </div>

                                    <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition pulse-hover">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <p className="text-green-100 text-sm font-medium">Ingresos</p>
                                                <p className="text-2xl font-bold mt-2">{formatCOP(totalIngresosGlobal)}</p>
                                            </div>
                                            <span className="text-5xl opacity-80">ğŸ’µ</span>
                                        </div>
                                        <div className="text-xs text-green-100">{ingresos.length} registros</div>
                                    </div>

                                    <div className="bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition pulse-hover">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <p className="text-amber-100 text-sm font-medium">Balance</p>
                                                <p className="text-2xl font-bold mt-2">{formatCOP(balanceGlobal)}</p>
                                            </div>
                                            <span className="text-5xl opacity-80">ğŸ’°</span>
                                        </div>
                                        <div className="text-xs text-amber-100">Total neto</div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-6 rounded-2xl shadow-xl border-l-8 border-orange-500`}>
                                        <h3 className={`text-xl font-bold mb-4 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}><span>ğŸ“Š</span> Resumen de Ventas</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between p-4 bg-orange-50 rounded-xl">
                                                <span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-900'}`}>Total Ventas</span>
                                                <span className="font-bold text-orange-600">{formatCOP(ventas.reduce((s, v) => s + (parseFloat(v.total) || 0), 0))}</span>
                                            </div>
                                            <div className="flex justify-between p-4 bg-green-50 rounded-xl">
                                                <span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-900'}`}>Pagadas</span>
                                                <span className="font-bold text-green-600">{formatCOP(ventas.filter(v => v.estado_pago === 'Pagado').reduce((s, v) => s + (parseFloat(v.total) || 0), 0))}</span>
                                            </div>
                                            <div className="flex justify-between p-4 bg-red-50 rounded-xl">
                                                <span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-900'}`}>Pendientes</span>
                                                <span className="font-bold text-red-600">{formatCOP(ventasPendientes)}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-6 rounded-2xl shadow-xl border-l-8 border-blue-500`}>
                                        <h3 className={`text-xl font-bold mb-4 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}><span>â³</span> Pagos Pendientes</h3>
                                        <div className="space-y-2 max-h-64 overflow-y-auto">
                                            {ventas.filter(v => v.estado_pago === 'Pendiente').slice(0, 6).map(v => (
                                                <div key={v.id} className="flex justify-between items-center p-3 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition">
                                                    <div>
                                                        <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{v.clientes?.nombre}</p>
                                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{v.cantidad} {v.tipo_cantidad}</p>
                                                    </div>
                                                    <span className="font-bold text-red-600">{formatCOP((parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0))}</span>
                                                </div>
                                            ))}
                                            {ventas.filter(v => v.estado_pago === 'Pendiente').length === 0 && <p className="text-center py-8 text-gray-400">âœ… Todo al dÃ­a</p>}
                                        </div>
                                    </div>
                                </div>

                                {/* Top 5 Clientes y Cliente del Mes */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    {/* Top 5 Clientes */}
                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-6 rounded-2xl shadow-xl border-l-8 border-purple-500`}>
                                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                            <span>ğŸ†</span> Top 5 Mejores Clientes
                                        </h3>
                                        <div className="space-y-2">
                                            {calcularTopClientes().slice(0, 5).map((cliente, idx) => (
                                                <div key={cliente.id} className={`flex justify-between items-center p-4 ${darkMode ? 'bg-gray-700' : idx === 0 ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 border-2 border-yellow-400' : 'bg-purple-50'} rounded-xl hover:shadow-md transition`}>
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-2xl font-bold text-purple-600">#{idx + 1}</span>
                                                        <div>
                                                            <p className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                                {idx === 0 && 'ğŸ‘‘ '}{cliente.nombre}
                                                            </p>
                                                            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                {cliente.cantidadCompras} compra{cliente.cantidadCompras !== 1 ? 's' : ''}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="font-bold text-green-600 text-lg">{formatCOP(cliente.totalCompras)}</p>
                                                        <button
                                                            onClick={() => abrirPerfilCliente(cliente)}
                                                            className="text-xs text-blue-600 hover:underline mt-1">
                                                            Ver perfil â†’
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                            {calcularTopClientes().length === 0 && (
                                                <p className="text-center py-8 text-gray-400">Sin clientes aÃºn</p>
                                            )}
                                        </div>
                                    </div>

                                    {/* Cliente del Mes */}
                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-6 rounded-2xl shadow-xl border-l-8 border-orange-500`}>
                                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                            <span>â­</span> Cliente del Mes
                                        </h3>
                                        {(() => {
                                            const clienteMes = calcularClienteDelMes();
                                            return clienteMes ? (
                                                <div className="bg-gradient-to-r from-orange-100 to-yellow-100 p-6 rounded-2xl border-2 border-orange-300 text-center">
                                                    <div className="text-6xl mb-4">ğŸ‰</div>
                                                    <h4 className="text-2xl font-bold text-orange-800 mb-2">{clienteMes.cliente?.nombre}</h4>
                                                    <p className="text-lg font-bold text-green-600 mb-2">{formatCOP(clienteMes.total)}</p>
                                                    <p className="text-sm text-gray-700">{clienteMes.cantidad} compra{clienteMes.cantidad !== 1 ? 's' : ''} este mes</p>
                                                    <button
                                                        onClick={() => abrirPerfilCliente(clienteMes.cliente)}
                                                        className="mt-4 px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition font-bold">
                                                        Ver Perfil
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-center py-12">
                                                    <span className="text-6xl mb-4 block">ğŸ“…</span>
                                                    <p className="text-lg text-gray-600">Sin ventas este mes</p>
                                                </div>
                                            );
                                            // FunciÃ³n para reiniciar resumen
                                            const reiniciarResumen = async () => {
                                                if (!confirm('âš ï¸ Â¿EstÃ¡s seguro de reiniciar el resumen?\n\nEsto guardarÃ¡ el resumen actual en el historial y empezarÃ¡ uno nuevo desde hoy.\n\nLos datos NO se eliminarÃ¡n, solo se guardarÃ¡ un punto de control.')) {
                                                    return;
                                                }

                                                setIsLoading(true);

                                                try {
                                                    const fechaInicio = fechaUltimoReinicio || '2000-01-01';
                                                    const fechaFin = new Date().toISOString().split('T')[0];

                                                    // Calcular totales del perÃ­odo
                                                    const filtrarFecha = (fecha) => {
                                                        const f = new Date(fecha);
                                                        const inicio = new Date(fechaInicio);
                                                        const fin = new Date(fechaFin);
                                                        return f >= inicio && f <= fin;
                                                    };

                                                    const ventasPeriodo = ventas.filter(v => v.fecha && filtrarFecha(v.fecha));
                                                    const ingresosPeriodo = ingresos.filter(i => i.fecha && filtrarFecha(i.fecha));
                                                    const egresosPeriodo = egresos.filter(e => e.fecha && filtrarFecha(e.fecha));

                                                    const totalVentas = ventasPeriodo.reduce((s, v) => s + (parseFloat(v.total) || 0), 0);
                                                    const totalAbonos = ventasPeriodo.reduce((s, v) => s + (parseFloat(v.abono) || 0), 0);
                                                    const totalIngresos = ingresosPeriodo.reduce((s, i) => s + (parseFloat(i.monto) || 0), 0);
                                                    const totalEgresos = egresosPeriodo.reduce((s, e) => s + (parseFloat(e.monto) || 0), 0);
                                                    const balance = totalIngresos - totalEgresos;

                                                    // Guardar en historial
                                                    const { error: errorHistorial } = await supabaseClient.from('historial_resumenes').insert({
                                                        fecha_inicio: fechaInicio,
                                                        fecha_fin: fechaFin,
                                                        total_ventas: totalVentas,
                                                        total_abonos: totalAbonos,
                                                        total_ingresos: totalIngresos,
                                                        total_egresos: totalEgresos,
                                                        balance: balance,
                                                        notas: `Resumen del ${new Date(fechaInicio).toLocaleDateString('es-CO')} al ${new Date(fechaFin).toLocaleDateString('es-CO')}`,
                                                        usuario_id: user?.id
                                                    });

                                                    if (errorHistorial) {
                                                        pushToast('Error al guardar historial', 'error');
                                                        return;
                                                    }

                                                    // Actualizar fecha de Ãºltimo reinicio
                                                    const { error: errorConfig } = await supabaseClient
                                                        .from('configuracion_sistema')
                                                        .upsert({
                                                            clave: 'fecha_ultimo_reinicio',
                                                            valor: fechaFin,
                                                            usuario_id: user?.id
                                                        }, { onConflict: 'clave,usuario_id' });

                                                    if (errorConfig) {
                                                        pushToast('Error al actualizar configuraciÃ³n', 'error');
                                                        return;
                                                    }

                                                    pushToast('âœ… Resumen guardado en el historial');
                                                    setFechaUltimoReinicio(fechaFin);
                                                    await loadData();

                                                } catch (error) {
                                                    console.error('Error:', error);
                                                    pushToast('Error al reiniciar resumen', 'error');
                                                } finally {
                                                    setIsLoading(false);
                                                }
                                            };
                                        })()}


                                        {/* Clientes Inactivos */}
                                        <div className="mt-6">
                                            <h4 className="font-bold text-red-600 mb-3 flex items-center gap-2">
                                                <span>âš ï¸</span> Clientes Inactivos (+30 dÃ­as)
                                            </h4>
                                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                                {calcularClientesInactivos().slice(0, 5).map(cliente => (
                                                    <div key={cliente.id} className={`${darkMode ? 'bg-gray-700' : 'bg-red-50'} p-3 rounded-lg flex justify-between items-center border-l-4 border-red-400`}>
                                                        <div>
                                                            <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{cliente.nombre}</p>
                                                            <p className="text-xs text-red-600">{cliente.diasSinComprar} dÃ­as sin comprar</p>
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                const mensaje = `Hola ${cliente.nombre}! ğŸ«“ğŸŒ½ Te extraÃ±amos en Arepas al CarbÃ³n. Â¿QuÃ© tal si hacemos un nuevo pedido? Tenemos arepas frescas y deliciosas esperÃ¡ndote! ğŸ˜Š`;
                                                                enviarWhatsApp(cliente, mensaje);
                                                            }}
                                                            className="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-bold">
                                                            ğŸ“± WhatsApp
                                                        </button>
                                                    </div>
                                                ))}
                                                {calcularClientesInactivos().length === 0 && (
                                                    <p className="text-center py-4 text-green-600 font-semibold">âœ… Todos los clientes activos</p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'clientes' && (
                            <div className="space-y-6 fade-in">
                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-green-500`}>
                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>â•</span> Agregar Cliente</h2>
                                    <form onSubmit={addCliente} className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <input value={clienteForm.nombre} onChange={(e) => setClienteForm({ ...clienteForm, nombre: e.target.value })} placeholder="Nombre completo *" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
                                        <input value={clienteForm.direccion} onChange={(e) => setClienteForm({ ...clienteForm, direccion: e.target.value })} placeholder="DirecciÃ³n" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                        <select value={clienteForm.tipo_cliente} onChange={(e) => setClienteForm({ ...clienteForm, tipo_cliente: e.target.value })} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                            <option value="Individual">Individual</option>
                                            <option value="Contrato">Contrato</option>
                                        </select>
                                        <select value={clienteForm.dia_entrega} onChange={(e) => setClienteForm({ ...clienteForm, dia_entrega: e.target.value })} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                            <option value="">DÃ­a de entrega</option>
                                            <option value="Lunes">Lunes</option>
                                            <option value="Martes">Martes</option>
                                            <option value="MiÃ©rcoles">MiÃ©rcoles</option>
                                            <option value="Jueves">Jueves</option>
                                            <option value="Viernes">Viernes</option>
                                            <option value="SÃ¡bado">SÃ¡bado</option>
                                            <option value="Domingo">Domingo</option>
                                        </select>
                                        <input value={clienteForm.precio_especial} onChange={(e) => setClienteForm({ ...clienteForm, precio_especial: e.target.value })} placeholder="Precio especial" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                        <input value={clienteForm.notas} onChange={(e) => setClienteForm({ ...clienteForm, notas: e.target.value })} placeholder="Notas adicionales" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                        <input value={clienteForm.telefono || ''} onChange={(e) => setClienteForm({ ...clienteForm, telefono: e.target.value })} placeholder="TelÃ©fono (573001234567)" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                        <button type="submit" className="md:col-span-3 bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl font-bold text-lg hover:from-green-600 hover:to-green-700 transition shadow-lg pulse-hover">âœ… Agregar Cliente</button>
                                    </form>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                        <h2 className="text-2xl font-bold">Lista de Clientes ({clientes.filter(c => c.activo !== false && (!searchCliente || c.nombre.toLowerCase().includes(searchCliente.toLowerCase()))).length})</h2>

                                        <div className="flex gap-2 w-full md:w-auto">
                                            <input
                                                type="text"
                                                value={searchCliente}
                                                onChange={(e) => setSearchCliente(e.target.value)}
                                                placeholder="ğŸ” Buscar cliente..."
                                                data-search-clientes
                                                className={`flex-1 md:w-64 p-3 border-2 rounded-xl focus:ring-2 focus:ring-green-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white border-gray-200'}`}
                                            />
                                            <button
                                                onClick={() => setOrdenAlfabeticoClientes(!ordenAlfabeticoClientes)}
                                                className={`px-4 py-2 rounded-lg transition font-medium whitespace-nowrap ${ordenAlfabeticoClientes ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}>
                                                ğŸ”¤ {ordenAlfabeticoClientes ? 'Original' : 'A-Z'}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full min-w-[800px]">
                                            <thead><tr className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Nombre</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Tipo</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>DÃ­a</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Acciones</th></tr></thead>
                                            <tbody>
                                                {clientes.filter(c => c.activo !== false && (!searchCliente || c.nombre.toLowerCase().includes(searchCliente.toLowerCase()))).sort((a, b) => {
                                                    if (ordenAlfabeticoClientes) {
                                                        return a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' });
                                                    }
                                                    return 0;
                                                }).map(c => (
                                                    <tr key={c.id} className={`border-t ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition`}>
                                                        <td className={`p-4 font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{c.nombre}</td>
                                                        <td className="p-4">
                                                            <select value={c.tipo_cliente || 'Individual'} onChange={(e) => updateTipoCliente(c.id, e.target.value)} className={`px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900'}`}>
                                                                <option value="Individual">Individual</option>
                                                                <option value="Contrato">Contrato</option>
                                                            </select>
                                                        </td>
                                                        <td className={`p-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{c.dia_entrega || '-'}</td>
                                                        <td className="p-4">
                                                            <div className="flex gap-2 flex-wrap">
                                                                <button onClick={() => abrirPerfilCliente(c)} className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium text-sm">ğŸ‘¤ Perfil</button>
                                                                <button
                                                                    onClick={() => {
                                                                        const ventasCliente = ventas.filter(v => v.cliente_id === c.id);
                                                                        const deudaPendiente = ventasCliente
                                                                            .filter(v => v.estado_pago === 'Pendiente')
                                                                            .reduce((sum, v) => sum + ((parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0)), 0);

                                                                        let mensaje = `Hola ${c.nombre}! ğŸ«“ğŸŒ½\n\n`;

                                                                        if (deudaPendiente > 0) {
                                                                            // Agrupar deudas por fecha
                                                                            const deudasPorFecha = {};
                                                                            ventasCliente.filter(v => v.estado_pago === 'Pendiente').forEach(v => {
                                                                                const fecha = v.fecha ? new Date(v.fecha).toLocaleDateString('es-CO') : 'Sin fecha';
                                                                                if (!deudasPorFecha[fecha]) {
                                                                                    deudasPorFecha[fecha] = [];
                                                                                }
                                                                                deudasPorFecha[fecha].push(v);
                                                                            });

                                                                            mensaje += `Te enviamos el detalle de tu saldo pendiente: \n\n`;

                                                                            Object.keys(deudasPorFecha).forEach(fecha => {
                                                                                mensaje += `ğŸ“† *${fecha}* \n`;
                                                                                deudasPorFecha[fecha].forEach(v => {
                                                                                    const deuda = (parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0);
                                                                                    mensaje += `  â€¢ ${v.cantidad} ${v.tipo_cantidad}`;
                                                                                    if (v.abono > 0) {
                                                                                        mensaje += ` - Abonado: ${formatCOP(v.abono)}`;
                                                                                    }
                                                                                    mensaje += ` - Debe: ${formatCOP(deuda)}\n`;
                                                                                });
                                                                                mensaje += `\n`;
                                                                            });

                                                                            mensaje += ` ğŸ’° *TOTAL ADEUDADO: ${formatCOP(deudaPendiente)}*\n\n`;
                                                                            mensaje += `Â¿CuÃ¡ndo podrÃ­amos coordinar el pago? Estamos a tu disposiciÃ³n. Â¡Gracias! ğŸ˜Š`;
                                                                        } else {
                                                                            mensaje += `Â¡Gracias por tu confianza! âœ… \n\n`;
                                                                            mensaje += `No tienes saldo pendiente. Â¿Listo para tu prÃ³ximo pedido de deliciosas arepas al carbÃ³n? ğŸ”¥ \n\n`;
                                                                            mensaje += `EscrÃ­benos cuando quieras! ğŸ˜Š`;
                                                                        }

                                                                        enviarWhatsApp(c, mensaje);
                                                                    }}
                                                                    className="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition font-medium text-sm">
                                                                    ğŸ“± WhatsApp
                                                                </button>
                                                                <button onClick={() => deleteCliente(c.id)} className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium text-sm">ğŸ—‘ï¸</button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'historial' && (
                            <HistorialCompras
                                clientes={clientes}
                                ventas={ventas}
                                pushToast={pushToast}
                                loadData={loadData}
                                supabaseClient={supabaseClient}
                                formatCOP={formatCOP}
                                darkMode={darkMode}
                                enviarWhatsApp={enviarWhatsApp}
                            />
                        )}


                        {activeTab === 'calendario' && (
                            <div className="space-y-6 fade-in">
                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-purple-500`}>
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold flex items-center gap-2">
                                            <span>ğŸ“…</span> Calendario de Notas
                                        </h2>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    const nuevaFecha = new Date(mesActual);
                                                    nuevaFecha.setMonth(nuevaFecha.getMonth() - 1);
                                                    setMesActual(nuevaFecha);
                                                }}
                                                className={`px-2 md:px-4 py-2 rounded-lg font-bold transition text-xs md:text-base ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>
                                                <span className="hidden md:inline">â† Anterior</span>
                                                <span className="md:hidden">â†</span>
                                            </button>
                                            <button
                                                onClick={() => setMesActual(new Date())}
                                                className={`px-2 md:px-4 py-2 rounded-lg font-bold transition text-xs md:text-base ${darkMode ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}>
                                                Hoy
                                            </button>
                                            <button
                                                onClick={() => {
                                                    const nuevaFecha = new Date(mesActual);
                                                    nuevaFecha.setMonth(nuevaFecha.getMonth() + 1);
                                                    setMesActual(nuevaFecha);
                                                }}
                                                className={`px-2 md:px-4 py-2 rounded-lg font-bold transition text-xs md:text-base ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>
                                                <span className="hidden md:inline">Siguiente â†’</span>
                                                <span className="md:hidden">â†’</span>
                                            </button>
                                        </div>
                                    </div>

                                    <h3 className="text-xl md:text-3xl font-bold text-center mb-4 md:mb-6">
                                        {mesActual.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' }).toUpperCase()}
                                    </h3>

                                    {/* Encabezados dÃ­as de la semana */}
                                    <div className="grid grid-cols-7 gap-2 mb-2">
                                        {['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'].map(dia => (
                                            <div key={dia} className="font-bold text-center p-2 bg-orange-500 text-white rounded-lg">
                                                {dia}
                                            </div>
                                        ))}
                                    </div>

                                    {/* Calendario */}
                                    <div className="grid grid-cols-7 gap-2 mb-6">
                                        {(() => {
                                            const primerDia = new Date(mesActual.getFullYear(), mesActual.getMonth(), 1);
                                            const ultimoDia = new Date(mesActual.getFullYear(), mesActual.getMonth() + 1, 0);
                                            const diasMes = ultimoDia.getDate();
                                            const diaSemanaInicio = primerDia.getDay();

                                            const dias = [];

                                            // Espacios vacÃ­os
                                            for (let i = 0; i < diaSemanaInicio; i++) {
                                                dias.push(
                                                    <div key={`empty-${i}`} className={`p-2 min-h-[100px] ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg`}></div>
                                                );
                                            }

                                            // DÃ­as del mes
                                            const hoy = new Date();
                                            for (let dia = 1; dia <= diasMes; dia++) {
                                                const fechaStr = `${mesActual.getFullYear()}-${String(mesActual.getMonth() + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                                                const notasDelDia = (notasCalendario || []).filter(n => n && n.fecha === fechaStr);
                                                if (dia === 1) console.log('ğŸ” Notas del dÃ­a 1:', fechaStr, notasDelDia); // TEMPORAL
                                                const esHoy = hoy.getDate() === dia && hoy.getMonth() === mesActual.getMonth() && hoy.getFullYear() === mesActual.getFullYear();

                                                dias.push(
                                                    <div
                                                        key={dia}
                                                        onClick={() => {
                                                            setFormularioNota({
                                                                fecha: fechaStr,
                                                                titulo: '',
                                                                descripcion: '',
                                                                color: 'blue'
                                                            });
                                                            setNotaSeleccionada(null);
                                                        }}
                                                        className={`p-2 md:p-3 rounded-lg border-2 cursor-pointer transition min-h-[70px] md:min-h-[100px] ${esHoy
                                                            ? darkMode
                                                                ? 'border-orange-400 bg-orange-900 text-white'
                                                                : 'border-orange-500 bg-orange-100'
                                                            : darkMode
                                                                ? 'bg-gray-700 hover:bg-gray-600 border-gray-600'
                                                                : 'bg-white hover:bg-gray-50 border-gray-200'
                                                            }`}>
                                                        <div className={`font-bold text-sm md:text-lg mb-1 md:mb-2 ${esHoy ? (darkMode ? 'text-orange-200' : 'text-orange-800') : (darkMode ? 'text-white' : 'text-gray-800')}`}>
                                                            {dia}
                                                        </div>
                                                        <div className="space-y-1">
                                                            {notasDelDia.map(nota => {
                                                                // Colores fijos que funcionan con Tailwind
                                                                const getColorClasses = (color) => {
                                                                    if (darkMode) {
                                                                        switch (color) {
                                                                            case 'blue': return 'bg-blue-800 text-blue-100 hover:bg-blue-700 border-blue-600';
                                                                            case 'green': return 'bg-green-800 text-green-100 hover:bg-green-700 border-green-600';
                                                                            case 'red': return 'bg-red-800 text-red-100 hover:bg-red-700 border-red-600';
                                                                            case 'yellow': return 'bg-yellow-800 text-yellow-100 hover:bg-yellow-700 border-yellow-600';
                                                                            case 'purple': return 'bg-purple-800 text-purple-100 hover:bg-purple-700 border-purple-600';
                                                                            case 'orange': return 'bg-orange-800 text-orange-100 hover:bg-orange-700 border-orange-600';
                                                                            default: return 'bg-gray-600 text-gray-100 hover:bg-gray-500 border-gray-500';
                                                                        }
                                                                    } else {
                                                                        switch (color) {
                                                                            case 'blue': return 'bg-blue-100 text-blue-800 hover:bg-blue-200 border-blue-300';
                                                                            case 'green': return 'bg-green-100 text-green-800 hover:bg-green-200 border-green-300';
                                                                            case 'red': return 'bg-red-100 text-red-800 hover:bg-red-200 border-red-300';
                                                                            case 'yellow': return 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200 border-yellow-300';
                                                                            case 'purple': return 'bg-purple-100 text-purple-800 hover:bg-purple-200 border-purple-300';
                                                                            case 'orange': return 'bg-orange-100 text-orange-800 hover:bg-orange-200 border-orange-300';
                                                                            default: return 'bg-gray-100 text-gray-800 hover:bg-gray-200 border-gray-300';
                                                                        }
                                                                    }
                                                                };

                                                                return (
                                                                    <div
                                                                        key={nota.id}
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            setNotaSeleccionada(nota);
                                                                            setFormularioNota({ fecha: '', titulo: '', descripcion: '', color: 'blue' });
                                                                        }}
                                                                        className={`text-xs p-1 md:p-2 rounded border-l-2 ${getColorClasses(nota.color)} transition cursor-pointer font-medium shadow-sm truncate`}>
                                                                        ğŸ“Œ {nota.titulo}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                );
                                            }

                                            return dias;
                                        })()}
                                    </div>

                                    {/* Formulario agregar nota */}
                                    {formularioNota.fecha && !notaSeleccionada && (
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-blue-50'} p-6 rounded-xl border-2 border-blue-300 mt-6`}>
                                            <h4 className="font-bold text-blue-700 mb-4">
                                                â• Nueva Nota - {new Date(formularioNota.fecha + 'T00:00:00').toLocaleDateString('es-CO')}
                                            </h4>
                                            <div className="space-y-3">
                                                <input
                                                    type="text"
                                                    value={formularioNota.titulo}
                                                    onChange={(e) => setFormularioNota({ ...formularioNota, titulo: e.target.value })}
                                                    placeholder="TÃ­tulo de la nota *"
                                                    className={`w-full p-3 border-2 rounded-xl focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-blue-200'}`}
                                                />
                                                <textarea
                                                    value={formularioNota.descripcion}
                                                    onChange={(e) => setFormularioNota({ ...formularioNota, descripcion: e.target.value })}
                                                    placeholder="DescripciÃ³n (opcional)"
                                                    rows="3"
                                                    className={`w-full p-3 border-2 rounded-xl focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-blue-200'}`}
                                                />
                                                <select
                                                    value={formularioNota.color}
                                                    onChange={(e) => setFormularioNota({ ...formularioNota, color: e.target.value })}
                                                    className={`w-full p-3 border-2 rounded-xl focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-blue-200'}`}>
                                                    <option value="blue">ğŸ”µ Azul</option>
                                                    <option value="green">ğŸŸ¢ Verde</option>
                                                    <option value="red">ğŸ”´ Rojo</option>
                                                    <option value="yellow">ğŸŸ¡ Amarillo</option>
                                                    <option value="purple">ğŸŸ£ Morado</option>
                                                    <option value="orange">ğŸŸ  Naranja</option>
                                                </select>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={async () => {
                                                            if (!formularioNota.titulo) {
                                                                pushToast('Escribe un tÃ­tulo', 'error');
                                                                return;
                                                            }
                                                            const { error } = await supabaseClient.from('notas_calendario').insert({
                                                                fecha: formularioNota.fecha,
                                                                titulo: formularioNota.titulo,
                                                                descripcion: formularioNota.descripcion,
                                                                color: formularioNota.color,
                                                                usuario_id: user?.id
                                                            });
                                                            if (error) {
                                                                pushToast('Error: ' + error.message, 'error');
                                                            } else {
                                                                pushToast('âœ… Nota agregada');
                                                                setFormularioNota({ fecha: '', titulo: '', descripcion: '', color: 'blue' });
                                                                loadData();
                                                            }
                                                        }}
                                                        className="flex-1 bg-green-600 text-white p-3 rounded-xl font-bold hover:bg-green-700 transition">
                                                        âœ… Guardar Nota
                                                    </button>
                                                    <button
                                                        onClick={() => setFormularioNota({ fecha: '', titulo: '', descripcion: '', color: 'blue' })}
                                                        className="px-6 bg-gray-400 text-white p-3 rounded-xl font-bold hover:bg-gray-500 transition">
                                                        âŒ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Ver/Editar nota */}
                                    {notaSeleccionada && (
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-purple-50'} p-6 rounded-xl border-2 border-purple-300 mt-6`}>
                                            <div className="flex justify-between items-start mb-4">
                                                <h4 className="font-bold text-purple-700 text-xl">âœï¸ Editar Nota</h4>
                                                <button
                                                    onClick={() => {
                                                        setNotaSeleccionada(null);
                                                        setFormularioNota({ fecha: '', titulo: '', descripcion: '', color: 'blue' });
                                                    }}
                                                    className="text-2xl hover:text-red-500 transition">
                                                    Ã—
                                                </button>
                                            </div>

                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-semibold mb-2">TÃ­tulo</label>
                                                    <input
                                                        type="text"
                                                        defaultValue={notaSeleccionada.titulo}
                                                        id={`edit-titulo-${notaSeleccionada.id}`}
                                                        className={`w-full p-3 border-2 rounded-xl focus:ring-2 focus:ring-purple-500 ${darkMode ? 'bg-gray-800 text-white border-gray-600' : 'bg-white text-gray-900 border-purple-200'}`}
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-semibold mb-2">DescripciÃ³n</label>
                                                    <textarea
                                                        defaultValue={notaSeleccionada.descripcion || ''}
                                                        id={`edit-desc-${notaSeleccionada.id}`}
                                                        rows="4"
                                                        className={`w-full p-3 border-2 rounded-xl focus:ring-2 focus:ring-purple-500 ${darkMode ? 'bg-gray-800 text-white border-gray-600' : 'bg-white text-gray-900 border-purple-200'}`}
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-semibold mb-2">Color</label>
                                                    <select
                                                        defaultValue={notaSeleccionada.color}
                                                        id={`edit-color-${notaSeleccionada.id}`}
                                                        className={`w-full p-3 border-2 rounded-xl focus:ring-2 focus:ring-purple-500 ${darkMode ? 'bg-gray-800 text-white border-gray-600' : 'bg-white text-gray-900 border-purple-200'}`}>
                                                        <option value="blue">ğŸ”µ Azul</option>
                                                        <option value="green">ğŸŸ¢ Verde</option>
                                                        <option value="red">ğŸ”´ Rojo</option>
                                                        <option value="yellow">ğŸŸ¡ Amarillo</option>
                                                        <option value="purple">ğŸŸ£ Morado</option>
                                                        <option value="orange">ğŸŸ  Naranja</option>
                                                    </select>
                                                </div>

                                                <p className="text-sm text-gray-500">
                                                    ğŸ“… {new Date(notaSeleccionada.fecha + 'T00:00:00').toLocaleDateString('es-CO')}
                                                </p>

                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={async () => {
                                                            const titulo = document.getElementById(`edit-titulo-${notaSeleccionada.id}`).value.trim();
                                                            const descripcion = document.getElementById(`edit-desc-${notaSeleccionada.id}`).value.trim();
                                                            const color = document.getElementById(`edit-color-${notaSeleccionada.id}`).value;

                                                            if (!titulo) {
                                                                pushToast('El tÃ­tulo es obligatorio', 'error');
                                                                return;
                                                            }

                                                            const { error } = await supabaseClient
                                                                .from('notas_calendario')
                                                                .update({ titulo, descripcion, color })
                                                                .eq('id', notaSeleccionada.id);

                                                            if (error) {
                                                                pushToast('Error al actualizar', 'error');
                                                            } else {
                                                                pushToast('âœ… Nota actualizada');
                                                                setNotaSeleccionada(null);
                                                                loadData();
                                                            }
                                                        }}
                                                        className="flex-1 bg-green-600 text-white p-3 rounded-xl font-bold hover:bg-green-700 transition">
                                                        ğŸ’¾ Guardar Cambios
                                                    </button>

                                                    <button
                                                        onClick={async () => {
                                                            if (confirm('Â¿Eliminar esta nota?')) {
                                                                const { error } = await supabaseClient.from('notas_calendario').delete().eq('id', notaSeleccionada.id);
                                                                if (error) {
                                                                    pushToast('Error al eliminar', 'error');
                                                                } else {
                                                                    pushToast('ğŸ—‘ï¸ Nota eliminada');
                                                                    setNotaSeleccionada(null);
                                                                    loadData();
                                                                }
                                                            }
                                                        }}
                                                        className="px-6 bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 transition">
                                                        ğŸ—‘ï¸
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'ventas' && (
                            <div className="space-y-6 fade-in">
                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-orange-500`}>
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold flex items-center gap-2"><span>ğŸ›’</span> Registrar Venta</h2>
                                        <button
                                            type="button"
                                            onClick={() => setMostrarConfigPrecios(true)}
                                            className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition font-semibold flex items-center gap-2">
                                            âš™ï¸ Configurar Precios
                                        </button>
                                    </div>
                                    <form onSubmit={addVenta} className="space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <select value={ventaForm.cliente_id} onChange={(e) => setVentaForm({ ...ventaForm, cliente_id: e.target.value })} required className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                                <option value="" className={darkMode ? 'bg-gray-700 text-white' : ''}>Seleccionar Cliente *</option>
                                                {clientes.filter(c => c.activo !== false).sort((a, b) =>
                                                    a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' })
                                                ).map(c => (<option key={c.id} value={c.id} className={darkMode ? 'bg-gray-700 text-white' : ''}>{c.nombre} ({c.tipo_cliente})</option>))}
                                            </select>
                                            <select value={ventaForm.tipo_cantidad} onChange={(e) => setVentaForm({ ...ventaForm, tipo_cantidad: e.target.value, cantidad: '', total: '' })} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                                <option value="Unidades">ğŸŒ½ Unidades ({formatCOP(precioUnidad)} c/u)</option>
                                                <option value="Paquetes">ğŸ“¦ Paquetes ({formatCOP(precioPaquete)} c/u)</option>
                                            </select>
                                            <input type="number" min="1" value={ventaForm.cantidad} onChange={(e) => setVentaForm({ ...ventaForm, cantidad: e.target.value })} placeholder="Cantidad *" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" required />
                                        </div>

                                        {ventaForm.precio_sugerido > 0 && (
                                            <div className="p-6 bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <p className="text-sm text-blue-700 font-medium mb-1">ğŸ’¡ Precio Sugerido</p>
                                                        <p className="text-3xl font-bold text-blue-600">{formatCOP(ventaForm.precio_sugerido)}</p>
                                                    </div>
                                                    <button type="button" onClick={() => setVentaForm({ ...ventaForm, total: ventaForm.precio_sugerido })} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg pulse-hover">âœ¨ Usar</button>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input type="number" placeholder="Total *" value={ventaForm.total} onChange={(e) => setVentaForm({ ...ventaForm, total: e.target.value })} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" required />
                                            <input type="number" placeholder="Abono (opcional)" value={ventaForm.abono} onChange={(e) => setVentaForm({ ...ventaForm, abono: e.target.value })} className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                            <select value={ventaForm.estado_pago} onChange={(e) => setVentaForm({ ...ventaForm, estado_pago: e.target.value })} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                                <option value="Pendiente">â³ Pendiente</option>
                                                <option value="Pagado">âœ… Pagado</option>
                                            </select>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input value={ventaForm.semana} onChange={(e) => setVentaForm({ ...ventaForm, semana: e.target.value })} placeholder="Semana (ej: Semana 42)" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                            <input type="date" value={ventaForm.fecha} onChange={(e) => setVentaForm({ ...ventaForm, fecha: e.target.value })} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                            <input value={ventaForm.notas} onChange={(e) => setVentaForm({ ...ventaForm, notas: e.target.value })} placeholder="Notas" className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                        </div>

                                        <button type="submit" className="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white p-5 rounded-xl font-bold text-lg hover:from-orange-600 hover:to-orange-700 transition shadow-lg pulse-hover">ğŸš€ Registrar Venta</button>
                                    </form>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-indigo-500`}>
                                    <h2 className="text-2xl font-bold mb-6">Filtros y BÃºsqueda</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                        <select value={filterEstado} onChange={(e) => setFilterEstado(e.target.value)} className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-orange-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}>
                                            <option value="Todos">Todas</option>
                                            <option value="Pagadas">âœ… Pagadas</option>
                                            <option value="Pendientes">â³ Pendientes</option>
                                        </select>
                                        <button onClick={() => { setFilterDate(''); setFilterEstado('Todos'); }} className="px-6 py-4 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition">ğŸ”„ Limpiar</button>
                                    </div>

                                    {filterDate && (
                                        <div className="mb-6 p-6 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border-2 border-orange-300">
                                            {(() => {
                                                const ventasPorFecha = ventas.filter(v => v.fecha && v.fecha.slice(0, 10) === filterDate);
                                                const total = ventasPorFecha.reduce((s, v) => s + (parseFloat(v.total) || 0), 0);
                                                const unidades = ventasPorFecha.reduce((s, v) => { if (v.tipo_cantidad === 'Paquetes') return s + ((parseInt(v.cantidad) || 0) * 10); return s + (parseInt(v.cantidad) || 0); }, 0);
                                                return (<div>
                                                    <p className="text-lg font-bold text-orange-700 mb-3">ğŸ“… Ventas del {filterDate}</p>
                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                                        <div className="bg-white p-4 rounded-xl shadow">
                                                            <p className="text-sm text-gray-600">Unidades</p>
                                                            <p className="text-2xl font-bold text-blue-600">{unidades}</p>
                                                        </div>
                                                        <div className="bg-white p-4 rounded-xl shadow">
                                                            <p className="text-sm text-gray-600">Paquetes</p>
                                                            <p className="text-2xl font-bold text-purple-600">{Math.floor(unidades / 10)}+{unidades % 10}</p>
                                                        </div>
                                                    </div>
                                                </div>);
                                            })()}
                                        </div>
                                    )}

                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Historial ({ventasFiltradas.length})</h3>
                                            <button
                                                onClick={() => setOrdenAlfabetico(!ordenAlfabetico)}
                                                className={`px-4 py-2 rounded-lg transition font-medium ${ordenAlfabetico ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}>
                                                ğŸ”¤ {ordenAlfabetico ? 'Orden por fecha' : 'Ordenar A-Z'}
                                            </button>
                                        </div>
                                        <button
                                            onClick={() => {
                                                const sorted = [...ventasFiltradas].sort((a, b) =>
                                                    (a.clientes?.nombre || '').localeCompare(b.clientes?.nombre || '', 'es', { sensitivity: 'base' })
                                                );
                                                setVentas(sorted);
                                            }}
                                            className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium">
                                            ğŸ”¤ Ordenar A-Z
                                        </button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead><tr className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Cliente</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Cantidad</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Total</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Abono</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Saldo</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Estado</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Fecha</th><th className={`p-4 text-left font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Acciones</th></tr></thead>
                                            <tbody>
                                                {ventasFiltradas.map(v => {
                                                    const total = parseFloat(v.total) || 0;
                                                    const abono = parseFloat(v.abono) || 0;
                                                    const saldo = total - abono;
                                                    return (<tr key={v.id} className={`border-t ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition`}>
                                                        <td className={`p-4 font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{v.clientes?.nombre || 'N/A'}</td>
                                                        <td className="p-4">
                                                            <input
                                                                type="number"
                                                                defaultValue={v.cantidad}
                                                                onBlur={async (e) => {
                                                                    const nuevaCantidad = parseInt(e.target.value);
                                                                    if (nuevaCantidad && nuevaCantidad > 0) {
                                                                        const precioUnitario = parseFloat(v.precio_unitario) || (v.tipo_cantidad === 'Unidades' ? 600 : 6000);
                                                                        const nuevoTotal = nuevaCantidad * precioUnitario;
                                                                        const abonoActual = parseFloat(v.abono) || 0;
                                                                        const nuevoEstado = abonoActual >= nuevoTotal ? 'Pagado' : 'Pendiente';

                                                                        const { error } = await supabaseClient.from('ventas').update({
                                                                            cantidad: nuevaCantidad,
                                                                            total: nuevoTotal,
                                                                            estado_pago: nuevoEstado
                                                                        }).eq('id', v.id);

                                                                        if (error) {
                                                                            pushToast('Error al actualizar', 'error');
                                                                        } else {
                                                                            pushToast('âœ… Cantidad y total actualizados');
                                                                            loadData();
                                                                        }
                                                                    }
                                                                }}
                                                                className={`w-20 p-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`}
                                                            />
                                                            <span className={`ml-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{v.tipo_cantidad}</span>
                                                        </td>
                                                        <td className="p-4 font-bold text-green-600">{formatCOP(total)}</td>
                                                        <td className="p-4"><span className={`font-bold ${abono > 0 ? 'text-blue-600' : 'text-gray-400'}`}>{formatCOP(abono)}</span></td>
                                                        <td className="p-4"><span className={`font-bold ${saldo > 0 ? 'text-red-600' : 'text-green-600'}`}>{formatCOP(saldo)}</span></td>
                                                        <td className="p-4">
                                                            <button onClick={() => {
                                                                if (v.estado_pago === 'Pagado') {
                                                                    showConfirm(
                                                                        'â³ Marcar como Pendiente',
                                                                        'Â¿Cambiar esta venta a pendiente?',
                                                                        () => setPagoVenta(v, 'Pendiente')
                                                                    );
                                                                } else {
                                                                    showConfirm(
                                                                        'âœ… Marcar como Pagado',
                                                                        'Â¿Marcar esta venta como pagada completamente?',
                                                                        () => setPagoVenta(v, 'Pagado')
                                                                    );
                                                                }
                                                            }} className={`px-4 py-2 rounded-xl font-medium transition ${v.estado_pago === 'Pagado' ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'}`}>
                                                                {v.estado_pago === 'Pagado' ? 'âœ… Pagado' : 'â³ Pendiente'}
                                                            </button>
                                                        </td>
                                                        <td className="p-4"></td>
                                                        <td className="p-4"><input type="date" defaultValue={v.fecha ? v.fecha.slice(0, 10) : ''} onBlur={(e) => updateFechaVenta(v.id, e.target.value)} className={`p-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                                            <div className="flex gap-2 flex-wrap">
                                                                <button onClick={() => {
                                                                    showPrompt(
                                                                        'ğŸ’° Agregar Abono',
                                                                        `Saldo pendiente: ${formatCOP(saldo)}\n\nIngresa el monto a abonar:`,
                                                                        '0',
                                                                        (ab) => {
                                                                            if (!ab || ab === '') return;
                                                                            const monto = parseFloat(ab);
                                                                            if (isNaN(monto) || monto <= 0) {
                                                                                pushToast('Ingresa un monto vÃ¡lido', 'error');
                                                                                return;
                                                                            }
                                                                            if (monto > saldo) {
                                                                                pushToast('El abono no puede ser mayor al saldo', 'error');
                                                                                return;
                                                                            }
                                                                            setPagoVenta(v, 'Abono', monto);
                                                                        }
                                                                    );
                                                                }} className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium text-sm">ğŸ’° Abonar</button>
                                                                <button onClick={() => deleteVenta(v.id)} className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium text-sm">ğŸ—‘ï¸</button>
                                                                {v.notas && <button onClick={() => setNotaModal(v.notas)} className="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs hover:bg-amber-200 transition">ğŸ“ Ver</button>}
                                                            </div>
                                                        </td>
                                                    </tr>);
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'contabilidad' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-green-500`}>
                                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>ğŸ“ˆ</span> Agregar Ingreso</h2>
                                        <form onSubmit={addIngreso} className="space-y-4">
                                            <input value={ingresoForm.concepto} onChange={(e) => setIngresoForm({ ...ingresoForm, concepto: e.target.value })} placeholder="Concepto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
                                            <input type="number" step="100" value={ingresoForm.monto} onChange={(e) => setIngresoForm({ ...ingresoForm, monto: e.target.value })} placeholder="Monto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" required />
                                            <input type="date" value={ingresoForm.fecha} onChange={(e) => setIngresoForm({ ...ingresoForm, fecha: e.target.value })} className={`w-full p-4 border-2 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                            <button type="submit" className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition shadow-lg pulse-hover">âœ… Agregar</button>
                                        </form>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-red-500`}>
                                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><span>ğŸ“‰</span> Agregar Egreso</h2>
                                        <form onSubmit={addEgreso} className="space-y-4">
                                            <input value={egresoForm.concepto} onChange={(e) => setEgresoForm({ ...egresoForm, concepto: e.target.value })} placeholder="Concepto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent" required />
                                            <input type="number" step="100" value={egresoForm.monto} onChange={(e) => setEgresoForm({ ...egresoForm, monto: e.target.value })} placeholder="Monto" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent" required />
                                            <input type="date" value={egresoForm.fecha} onChange={(e) => setEgresoForm({ ...egresoForm, fecha: e.target.value })} className={`w-full p-4 border-2 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-200'}`} />
                                            <button type="submit" className="w-full bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-xl font-bold hover:from-red-600 hover:to-red-700 transition shadow-lg pulse-hover">âœ… Agregar</button>
                                        </form>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                        <h3 className="text-xl font-bold mb-6 text-green-600 flex items-center gap-2"><span>ğŸ’µ</span> Ingresos ({ingresos.length})</h3>
                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {ingresos.map(ing => (<div key={ing.id} className="flex justify-between items-center p-4 bg-green-50 rounded-xl hover:bg-green-100 transition border-l-4 border-green-500">
                                                <div className="flex-1">
                                                    <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{ing.concepto}</p>
                                                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{ing.fecha ? new Date(ing.fecha).toLocaleDateString('es-CO') : ''}</p>
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <span className="font-bold text-green-600 text-lg">{formatCOP(ing.monto)}</span>
                                                    <button onClick={() => deleteIngreso(ing.id)} className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium">ğŸ—‘ï¸</button>
                                                </div>
                                            </div>))}
                                            {ingresos.length === 0 && <p className="text-center py-8 text-gray-400">Sin registros</p>}
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                        <h3 className="text-xl font-bold mb-6 text-red-600 flex items-center gap-2"><span>ğŸ’¸</span> Egresos ({egresos.length})</h3>
                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {egresos.map(egr => (<div key={egr.id} className="flex justify-between items-center p-4 bg-red-50 rounded-xl hover:bg-red-100 transition border-l-4 border-red-500">
                                                <div className="flex-1">
                                                    <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{egr.concepto}</p>
                                                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{egr.fecha ? new Date(egr.fecha).toLocaleDateString('es-CO') : ''}</p>
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <span className="font-bold text-red-600 text-lg">{formatCOP(egr.monto)}</span>
                                                    <button onClick={() => deleteEgreso(egr.id)} className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium">ğŸ—‘ï¸</button>
                                                </div>
                                            </div>))}
                                            {egresos.length === 0 && <p className="text-center py-8 text-gray-400">Sin registros</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'compras' && (
                            <div className="space-y-6 fade-in">
                                {/* Formulario agregar compra */}
                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-indigo-500`}>
                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                                        <span>ğŸ›’</span> Registrar Compra de Materia Prima
                                    </h2>
                                    <form onSubmit={async (e) => {
                                        e.preventDefault();
                                        const fechaISO = compraForm.fecha ? new Date(compraForm.fecha).toISOString() : new Date().toISOString();
                                        const total = parseFloat(compraForm.total) || 0;

                                        const payload = {
                                            concepto: compraForm.concepto,
                                            cantidad: parseFloat(compraForm.cantidad) || null,
                                            unidad: compraForm.unidad,
                                            precio_unitario: parseFloat(compraForm.precio_unitario) || null,
                                            total: total,
                                            proveedor: compraForm.proveedor || null,
                                            fecha: fechaISO,
                                            notas: compraForm.notas || null,
                                            usuario_id: user?.id
                                        };

                                        const { error: errorCompra } = await supabaseClient.from('compras_materia_prima').insert(payload).select();

                                        if (errorCompra) {
                                            pushToast('Error: ' + errorCompra.message, 'error');
                                            return;
                                        }

                                        // Registrar tambiÃ©n como egreso
                                        await supabaseClient.from('egresos').insert({
                                            concepto: `Compra - ${compraForm.concepto}`,
                                            monto: total,
                                            categoria: 'Materia Prima',
                                            fecha: fechaISO
                                        }).select();

                                        pushToast('âœ… Compra registrada');
                                        setCompraForm({ concepto: '', cantidad: '', unidad: 'Kg', precio_unitario: '', total: '', proveedor: '', fecha: '', notas: '' });
                                        loadData();
                                    }} className="space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input
                                                value={compraForm.concepto}
                                                onChange={(e) => setCompraForm({ ...compraForm, concepto: e.target.value })}
                                                placeholder="Concepto (ej: MaÃ­z) *"
                                                className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                                                required
                                            />
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={compraForm.cantidad}
                                                onChange={(e) => setCompraForm({ ...compraForm, cantidad: e.target.value })}
                                                placeholder="Cantidad"
                                                className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                                            />
                                            <select
                                                value={compraForm.unidad}
                                                onChange={(e) => setCompraForm({ ...compraForm, unidad: e.target.value })}
                                                className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
                                                <option value="Kg">Kilogramos (Kg)</option>
                                                <option value="Bulto">Bultos</option>
                                                <option value="Libra">Libras</option>
                                                <option value="Unidad">Unidades</option>
                                                <option value="Litro">Litros</option>
                                                <option value="Otro">Otro</option>
                                            </select>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input
                                                type="number"
                                                step="100"
                                                value={compraForm.precio_unitario}
                                                onChange={(e) => {
                                                    const precio = e.target.value;
                                                    const cantidad = parseFloat(compraForm.cantidad) || 0;
                                                    const total = cantidad * parseFloat(precio || 0);
                                                    setCompraForm({ ...compraForm, precio_unitario: precio, total: total.toString() });
                                                }}
                                                placeholder="Precio unitario"
                                                className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                                            />
                                            <input
                                                type="number"
                                                step="100"
                                                value={compraForm.total}
                                                onChange={(e) => setCompraForm({ ...compraForm, total: e.target.value })}
                                                placeholder="Total *"
                                                className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                                                required
                                            />
                                            <input
                                                value={compraForm.proveedor}
                                                onChange={(e) => setCompraForm({ ...compraForm, proveedor: e.target.value })}
                                                placeholder="Proveedor"
                                                className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                                            />
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <input
                                                type="date"
                                                value={compraForm.fecha}
                                                onChange={(e) => setCompraForm({ ...compraForm, fecha: e.target.value })}
                                                className={`p-4 border-2 rounded-xl focus:ring-2 focus:ring-indigo-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white border-gray-200'}`}
                                            />
                                            <input
                                                value={compraForm.notas}
                                                onChange={(e) => setCompraForm({ ...compraForm, notas: e.target.value })}
                                                placeholder="Notas"
                                                className="p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500"
                                            />
                                        </div>

                                        <button
                                            type="submit"
                                            className="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white p-5 rounded-xl font-bold text-lg hover:from-indigo-600 hover:to-indigo-700 transition shadow-lg pulse-hover">
                                            âœ… Registrar Compra
                                        </button>
                                    </form>
                                </div>

                                {/* Lista de compras */}
                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                    <h3 className="text-xl font-bold mb-6 text-indigo-600 flex items-center gap-2">
                                        <span>ğŸ“‹</span> Historial de Compras ({compras.length})
                                    </h3>
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {compras.map(compra => (
                                            <div key={compra.id} className="flex justify-between items-center p-4 bg-indigo-50 rounded-xl hover:bg-indigo-100 transition border-l-4 border-indigo-500">
                                                <div className="flex-1">
                                                    <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                        {compra.concepto}
                                                        {compra.cantidad && ` - ${compra.cantidad} ${compra.unidad}`}
                                                    </p>
                                                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                                        {compra.fecha ? new Date(compra.fecha).toLocaleDateString('es-CO') : ''}
                                                        {compra.proveedor && ` â€¢ ${compra.proveedor}`}
                                                    </p>
                                                    {compra.notas && (
                                                        <p className="text-xs text-gray-500 mt-1">{compra.notas}</p>
                                                    )}
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <span className="font-bold text-indigo-600 text-lg">{formatCOP(compra.total)}</span>
                                                    <button
                                                        onClick={async () => {
                                                            if (!confirm('Â¿Eliminar esta compra?')) return;
                                                            const { error } = await supabaseClient.from('compras_materia_prima').delete().eq('id', compra.id);
                                                            if (error) {
                                                                pushToast('Error', 'error');
                                                            } else {
                                                                pushToast('Compra eliminada');
                                                                loadData();
                                                            }
                                                        }}
                                                        className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium">
                                                        ğŸ—‘ï¸
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                        {compras.length === 0 && <p className="text-center py-8 text-gray-400">Sin compras registradas</p>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'resumen' && (
                            <div className="space-y-6 fade-in">
                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl border-t-8 border-purple-500`}>
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold flex items-center gap-2">
                                            <span>ğŸ“Š</span> Resumen General
                                            {fechaUltimoReinicio && (
                                                <span className="text-sm font-normal text-gray-500">
                                                    (desde {new Date(fechaUltimoReinicio).toLocaleDateString('es-CO')})
                                                </span>
                                            )}
                                        </h2>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setMostrarHistorial(!mostrarHistorial)}
                                                className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-semibold">
                                                ğŸ“š Ver Historial
                                            </button>
                                            <button
                                                onClick={async () => {
                                                    if (!confirm('âš ï¸ Â¿EstÃ¡s seguro de reiniciar el resumen?\n\nEsto guardarÃ¡ el resumen actual en el historial y empezarÃ¡ uno nuevo desde hoy.\n\nLos datos NO se eliminarÃ¡n, solo se guardarÃ¡ un punto de control.')) {
                                                        return;
                                                    }

                                                    setIsLoading(true);

                                                    try {
                                                        const fechaInicio = fechaUltimoReinicio || '2000-01-01';
                                                        const fechaFin = new Date().toISOString().split('T')[0];

                                                        // Calcular totales del perÃ­odo
                                                        const filtrarFecha = (fecha) => {
                                                            if (!fecha) return false;
                                                            const f = new Date(fecha);
                                                            const inicio = new Date(fechaInicio);
                                                            const fin = new Date(fechaFin);
                                                            return f >= inicio && f <= fin;
                                                        };

                                                        const ventasPeriodo = ventas.filter(v => v.fecha && filtrarFecha(v.fecha));
                                                        const ingresosPeriodo = ingresos.filter(i => i.fecha && filtrarFecha(i.fecha));
                                                        const egresosPeriodo = egresos.filter(e => e.fecha && filtrarFecha(e.fecha));

                                                        const totalVentas = ventasPeriodo.reduce((s, v) => s + (parseFloat(v.total) || 0), 0);
                                                        const totalAbonos = ventasPeriodo.reduce((s, v) => s + (parseFloat(v.abono) || 0), 0);
                                                        const totalIngresos = ingresosPeriodo.reduce((s, i) => s + (parseFloat(i.monto) || 0), 0);
                                                        const totalEgresos = egresosPeriodo.reduce((s, e) => s + (parseFloat(e.monto) || 0), 0);
                                                        const balance = totalIngresos - totalEgresos;

                                                        // Guardar en historial
                                                        const { error: errorHistorial } = await supabaseClient.from('historial_resumenes').insert({
                                                            fecha_inicio: fechaInicio,
                                                            fecha_fin: fechaFin,
                                                            total_ventas: totalVentas,
                                                            total_abonos: totalAbonos,
                                                            total_ingresos: totalIngresos,
                                                            total_egresos: totalEgresos,
                                                            balance: balance,
                                                            notas: `Resumen del ${new Date(fechaInicio).toLocaleDateString('es-CO')} al ${new Date(fechaFin).toLocaleDateString('es-CO')}`,
                                                            usuario_id: user?.id
                                                        });

                                                        if (errorHistorial) {
                                                            pushToast('Error al guardar historial', 'error');
                                                            console.error('Error:', errorHistorial);
                                                            return;
                                                        }

                                                        // Actualizar fecha de Ãºltimo reinicio
                                                        const { error: errorConfig } = await supabaseClient
                                                            .from('configuracion_sistema')
                                                            .upsert({
                                                                clave: 'fecha_ultimo_reinicio',
                                                                valor: fechaFin,
                                                                usuario_id: user?.id
                                                            }, { onConflict: 'clave,usuario_id' });

                                                        if (errorConfig) {
                                                            pushToast('Error al actualizar configuraciÃ³n', 'error');
                                                            console.error('Error:', errorConfig);
                                                            return;
                                                        }

                                                        pushToast('âœ… Resumen guardado en el historial');
                                                        setFechaUltimoReinicio(fechaFin);
                                                        await loadData();

                                                    } catch (error) {
                                                        console.error('Error:', error);
                                                        pushToast('Error al reiniciar resumen', 'error');
                                                    } finally {
                                                        setIsLoading(false);
                                                    }
                                                }}
                                                className="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition font-semibold shadow-lg">
                                                ğŸ”„ Reiniciar Resumen
                                            </button>
                                        </div>
                                        {/* Modal Historial de ResÃºmenes */}
                                        {mostrarHistorial && (
                                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setMostrarHistorial(false)}>
                                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto scale-in`} onClick={(e) => e.stopPropagation()}>
                                                    <div className="flex justify-between items-center mb-6">
                                                        <h3 className="text-2xl font-bold flex items-center gap-2">
                                                            <span>ğŸ“š</span> Historial de ResÃºmenes
                                                        </h3>
                                                        <button onClick={() => setMostrarHistorial(false)} className="text-3xl hover:text-red-500 transition">Ã—</button>
                                                    </div>

                                                    {historialResumenes.length === 0 ? (
                                                        <div className="text-center py-12">
                                                            <span className="text-6xl mb-4 block">ğŸ“‹</span>
                                                            <p className="text-xl text-gray-600">No hay historiales guardados</p>
                                                            <p className="text-sm text-gray-500 mt-2">Usa el botÃ³n "Reiniciar Resumen" para crear un punto de control</p>
                                                        </div>
                                                    ) : (
                                                        <div className="space-y-4">
                                                            {historialResumenes.map((hist, idx) => (
                                                                <div key={hist.id} className={`${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-purple-50 to-blue-50'} p-6 rounded-xl border-2 border-purple-300`}>
                                                                    <div className="flex justify-between items-start mb-4">
                                                                        <div>
                                                                            <h4 className="text-lg font-bold text-purple-700 mb-1">
                                                                                PerÃ­odo #{historialResumenes.length - idx}
                                                                            </h4>
                                                                            <p className="text-sm text-gray-600">
                                                                                ğŸ“… {new Date(hist.fecha_inicio).toLocaleDateString('es-CO')} â†’ {new Date(hist.fecha_fin).toLocaleDateString('es-CO')}
                                                                            </p>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <p className="text-sm text-gray-600">Balance</p>
                                                                            <p className={`text-2xl font-bold ${hist.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                                {formatCOP(hist.balance)}
                                                                            </p>
                                                                        </div>
                                                                    </div>

                                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                                        <div className="bg-white p-3 rounded-lg">
                                                                            <p className="text-xs text-gray-600">Ventas</p>
                                                                            <p className="text-lg font-bold text-orange-600">{formatCOP(hist.total_ventas)}</p>
                                                                        </div>
                                                                        <div className="bg-white p-3 rounded-lg">
                                                                            <p className="text-xs text-gray-600">Abonado</p>
                                                                            <p className="text-lg font-bold text-blue-600">{formatCOP(hist.total_abonos)}</p>
                                                                        </div>
                                                                        <div className="bg-white p-3 rounded-lg">
                                                                            <p className="text-xs text-gray-600">Ingresos</p>
                                                                            <p className="text-lg font-bold text-green-600">{formatCOP(hist.total_ingresos)}</p>
                                                                        </div>
                                                                        <div className="bg-white p-3 rounded-lg">
                                                                            <p className="text-xs text-gray-600">Egresos</p>
                                                                            <p className="text-lg font-bold text-red-600">{formatCOP(hist.total_egresos)}</p>
                                                                        </div>
                                                                    </div>

                                                                    {hist.notas && (
                                                                        <p className="text-sm text-gray-600 mt-3 italic">{hist.notas}</p>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}

                                                    <button
                                                        onClick={() => setMostrarHistorial(false)}
                                                        className="w-full mt-6 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:from-purple-600 hover:to-purple-700 transition">
                                                        Cerrar
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-amber-100 text-sm font-medium mb-2">Total Ventas</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalVentas)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-green-100 text-sm font-medium mb-2">Total Abonos</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalAbonos)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-red-100 text-sm font-medium mb-2">Saldo Pendiente</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalSaldo)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-blue-100 text-sm font-medium mb-2">Ingresos</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalIngresos)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-purple-100 text-sm font-medium mb-2">Egresos</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalEgresos)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-gray-700 to-gray-800 text-white p-6 rounded-2xl shadow-xl pulse-hover">
                                            <p className="text-gray-300 text-sm font-medium mb-2">Balance Final</p>
                                            <p className="text-3xl font-bold">{formatCOP(resumen.totalIngresos - resumen.totalEgresos)}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-xl`}>
                                    <h3 className="text-xl font-bold mb-6 flex items-center gap-2"><span>ğŸ“‹</span> Detalles del PerÃ­odo</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border-2 border-blue-300">
                                            <p className="text-sm text-blue-700 font-semibold mb-2">Ventas Totales</p>
                                            <p className="text-4xl font-bold text-blue-600 mb-4">{formatCOP(resumen.totalVentas)}</p>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-blue-700">Abonado:</span>
                                                    <span className="font-bold text-green-600">{formatCOP(resumen.totalAbonos)}</span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-blue-700">Por cobrar:</span>
                                                    <span className="font-bold text-red-600">{formatCOP(resumen.totalSaldo)}</span>
                                                </div>
                                                <div className="pt-2 border-t-2 border-blue-300">
                                                    <div className="flex justify-between">
                                                        <span className="font-bold text-blue-800">Efectivo real:</span>
                                                        <span className="font-bold text-blue-800 text-lg">{formatCOP(resumen.totalAbonos)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border-2 border-purple-300">
                                            <p className="text-sm text-purple-700 font-semibold mb-2">Balance Neto</p>
                                            <p className="text-4xl font-bold text-purple-600 mb-4">{formatCOP(resumen.totalIngresos - resumen.totalEgresos)}</p>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-purple-700">Total ingresos:</span>
                                                    <span className="font-bold text-green-600">{formatCOP(resumen.totalIngresos)}</span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-purple-700">Total egresos:</span>
                                                    <span className="font-bold text-red-600">{formatCOP(resumen.totalEgresos)}</span>
                                                </div>
                                                <div className="pt-2 border-t-2 border-purple-300">
                                                    <div className="flex justify-between">
                                                        <span className="font-bold text-purple-800">Utilidad:</span>
                                                        <span className={`font-bold text-lg ${(resumen.totalIngresos - resumen.totalEgresos) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {formatCOP(resumen.totalIngresos - resumen.totalEgresos)}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-r from-amber-100 to-orange-100 p-8 rounded-2xl shadow-xl border-2 border-orange-300">
                                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-orange-800">
                                        <span>ğŸ’¡</span> AnÃ¡lisis RÃ¡pido
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-white p-4 rounded-xl shadow">
                                            <p className="text-sm text-gray-600 mb-1">Tasa de cobro</p>
                                            <p className="text-2xl font-bold text-blue-600">
                                                {resumen.totalVentas > 0 ? Math.round((resumen.totalAbonos / resumen.totalVentas) * 100) : 0}%
                                            </p>
                                        </div>
                                        <div className="bg-white p-4 rounded-xl shadow">
                                            <p className="text-sm text-gray-600 mb-1">Clientes activos</p>
                                            <p className="text-2xl font-bold text-green-600">{clientes.filter(c => c.activo !== false).length}</p>
                                        </div>
                                        <div className="bg-white p-4 rounded-xl shadow">
                                            <p className="text-sm text-gray-600 mb-1">Ventas registradas</p>
                                            <p className="text-2xl font-bold text-orange-600">{ventas.length}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    {notaModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setNotaModal(null)}>
                            <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span>ğŸ“</span> Notas de la venta
                                </h3>
                                <p className="text-gray-700 whitespace-pre-wrap mb-6">{notaModal}</p>
                                <button onClick={() => setNotaModal(null)} className="w-full bg-amber-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-amber-600 transition">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    )}
                    {mostrarPerfilCliente && clienteSeleccionado && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setMostrarPerfilCliente(false)}>
                            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
                                {(() => {
                                    const ventasCliente = ventas.filter(v => v.cliente_id === clienteSeleccionado.id);
                                    const totalVentas = ventasCliente.reduce((s, v) => s + (parseFloat(v.total) || 0), 0);
                                    const totalAbonado = ventasCliente.reduce((s, v) => s + (parseFloat(v.abono) || 0), 0);
                                    const saldoPendiente = totalVentas - totalAbonado;
                                    const ventasPendientes = ventasCliente.filter(v => v.estado_pago === 'Pendiente');
                                    const promedioMensual = ventasCliente.length > 0 ? totalVentas / ventasCliente.length : 0;

                                    return (
                                        <>
                                            <div className="flex justify-between items-start mb-6">
                                                <div>
                                                    <h2 className="text-3xl font-bold mb-2">ğŸ‘¤ {clienteSeleccionado.nombre}</h2>
                                                    <div className="flex gap-2">
                                                        <span className={`px-3 py-1 rounded-full text-sm font-medium ${clienteSeleccionado.tipo_cliente === 'Contrato' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                            {clienteSeleccionado.tipo_cliente}
                                                        </span>
                                                        {clienteSeleccionado.dia_entrega && (
                                                            <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">
                                                                ğŸ“… {clienteSeleccionado.dia_entrega}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <button onClick={() => setMostrarPerfilCliente(false)} className="text-3xl hover:text-red-500 transition">Ã—</button>
                                            </div>

                                            {/* InformaciÃ³n bÃ¡sica */}
                                            <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-6 rounded-xl mb-6`}>
                                                <h3 className="text-lg font-bold mb-3">ğŸ“‹ InformaciÃ³n</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {clienteSeleccionado.direccion && (
                                                        <div>
                                                            <p className="text-sm text-gray-500">DirecciÃ³n</p>
                                                            <p className="font-semibold">{clienteSeleccionado.direccion}</p>
                                                        </div>
                                                    )}
                                                    {clienteSeleccionado.precio_especial && (
                                                        <div>
                                                            <p className="text-sm text-gray-500">Precio Especial</p>
                                                            <p className="font-semibold text-green-600">{formatCOP(clienteSeleccionado.precio_especial)}</p>
                                                        </div>
                                                    )}
                                                    {/* TelÃ©fono con ediciÃ³n */}
                                                    <div className="md:col-span-2">
                                                        <p className="text-sm text-gray-500 mb-2">ğŸ“± TelÃ©fono de Contacto</p>
                                                        <div className="flex gap-2">
                                                            <input
                                                                type="text"
                                                                defaultValue={clienteSeleccionado.telefono || ''}
                                                                placeholder="573001234567"
                                                                id={`telefono-perfil-${clienteSeleccionado.id}`}
                                                                className={`flex-1 p-3 border-2 rounded-xl focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-200'}`}
                                                            />
                                                            <button
                                                                onClick={async () => {
                                                                    const input = document.getElementById(`telefono-perfil-${clienteSeleccionado.id}`);
                                                                    const nuevoTelefono = input.value.trim();

                                                                    const { error } = await supabaseClient
                                                                        .from('clientes')
                                                                        .update({ telefono: nuevoTelefono || null })
                                                                        .eq('id', clienteSeleccionado.id);

                                                                    if (error) {
                                                                        pushToast('Error al guardar', 'error');
                                                                    } else {
                                                                        pushToast('âœ… TelÃ©fono actualizado');
                                                                        setClienteSeleccionado({ ...clienteSeleccionado, telefono: nuevoTelefono });
                                                                        loadData();
                                                                    }
                                                                }}
                                                                className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">
                                                                ğŸ’¾
                                                            </button>
                                                        </div>
                                                    </div>
                                                    {clienteSeleccionado.notas && (
                                                        <div className="md:col-span-2">
                                                            <p className="text-sm text-gray-500">Notas</p>
                                                            <p className="font-semibold">{clienteSeleccionado.notas}</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* EstadÃ­sticas */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                                <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-xl">
                                                    <p className="text-sm opacity-80">Total Ventas</p>
                                                    <p className="text-2xl font-bold">{ventasCliente.length}</p>
                                                </div>
                                                <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-xl">
                                                    <p className="text-sm opacity-80">Total Facturado</p>
                                                    <p className="text-lg font-bold">{formatCOP(totalVentas)}</p>
                                                </div>
                                                <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-xl">
                                                    <p className="text-sm opacity-80">Abonado</p>
                                                    <p className="text-lg font-bold">{formatCOP(totalAbonado)}</p>
                                                </div>
                                                <div className="bg-gradient-to-br from-red-500 to-red-600 text-white p-4 rounded-xl">
                                                    <p className="text-sm opacity-80">Saldo</p>
                                                    <p className="text-lg font-bold">{formatCOP(saldoPendiente)}</p>
                                                </div>
                                            </div>
                                            {/* Editar TelÃ©fono */}
                                            <div className={`${darkMode ? 'bg-gray-700' : 'bg-blue-50'} p-6 rounded-xl mb-6 border-2 border-blue-300`}>
                                                <h3 className="text-lg font-bold mb-3 text-blue-700">ğŸ“± TelÃ©fono de Contacto</h3>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        defaultValue={clienteSeleccionado.telefono || ''}
                                                        placeholder="573001234567"
                                                        id={`telefono-${clienteSeleccionado.id}`}
                                                        className="flex-1 p-3 border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <button
                                                        onClick={async () => {
                                                            const input = document.getElementById(`telefono-${clienteSeleccionado.id}`);
                                                            const nuevoTelefono = input.value.trim();

                                                            if (!nuevoTelefono) {
                                                                pushToast('Ingresa un telÃ©fono vÃ¡lido', 'error');
                                                                return;
                                                            }

                                                            const { error } = await supabaseClient
                                                                .from('clientes')
                                                                .update({ telefono: nuevoTelefono })
                                                                .eq('id', clienteSeleccionado.id);

                                                            if (error) {
                                                                pushToast('Error al guardar', 'error');
                                                            } else {
                                                                pushToast('âœ… TelÃ©fono actualizado');
                                                                setClienteSeleccionado({ ...clienteSeleccionado, telefono: nuevoTelefono });
                                                                loadData();
                                                            }
                                                        }}
                                                        className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">
                                                        ğŸ’¾ Guardar
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Ventas pendientes */}
                                            {ventasPendientes.length > 0 && (
                                                <div className={`${darkMode ? 'bg-red-900/30' : 'bg-red-50'} p-6 rounded-xl mb-6 border-2 border-red-300`}>
                                                    <h3 className="text-lg font-bold mb-3 text-red-700">âš ï¸ Pagos Pendientes ({ventasPendientes.length})</h3>
                                                    <div className="space-y-2">
                                                        {ventasPendientes.slice(0, 5).map(v => (
                                                            <div key={v.id} className={`${darkMode ? 'bg-gray-700' : 'bg-white'} p-3 rounded-lg flex justify-between items-center`}>
                                                                <div>
                                                                    <p className="font-semibold">{v.cantidad} {v.tipo_cantidad}</p>
                                                                    <p className="text-sm text-gray-500">{v.fecha ? new Date(v.fecha).toLocaleDateString('es-CO') : 'Sin fecha'}</p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <p className="text-sm text-gray-500">Total: {formatCOP(v.total)}</p>
                                                                    <p className="font-bold text-red-600">Debe: {formatCOP((parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0))}</p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Historial completo */}
                                            <div>
                                                <h3 className="text-lg font-bold mb-3">ğŸ“œ Historial de Compras</h3>
                                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                                    {ventasCliente.length === 0 ? (
                                                        <p className="text-center py-8 text-gray-400">Sin ventas registradas</p>
                                                    ) : (
                                                        ventasCliente.map(v => (
                                                            <div key={v.id} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg hover:shadow-md transition`}>
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <p className="font-semibold">{v.cantidad} {v.tipo_cantidad}</p>
                                                                        <p className="text-sm text-gray-500">
                                                                            {v.fecha ? new Date(v.fecha).toLocaleDateString('es-CO') : 'Sin fecha'}
                                                                            {v.semana && ` â€¢ ${v.semana}`}
                                                                        </p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <p className="font-bold text-lg">{formatCOP(v.total)}</p>
                                                                        <span className={`px-2 py-1 rounded text-xs font-medium ${v.estado_pago === 'Pagado' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                                            {v.estado_pago}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6">
                                                <button
                                                    onClick={() => {
                                                        const deuda = ventasCliente.filter(v => v.estado_pago === 'Pendiente').reduce((s, v) => s + ((parseFloat(v.total) || 0) - (parseFloat(v.abono) || 0)), 0);
                                                        const mensaje = deuda > 0
                                                            ? `Hola ${clienteSeleccionado.nombre}! ğŸŒ½ Te recordamos que tienes un saldo pendiente de ${formatCOP(deuda)}. Â¿CuÃ¡ndo podemos coordinar el pago? Â¡Gracias! ğŸ˜Š`
                                                            : `Hola ${clienteSeleccionado.nombre}! ğŸŒ½ Â¿Listo para tu prÃ³ximo pedido de arepas al carbÃ³n? Â¡EscrÃ­benos! ğŸ˜Š`;
                                                        enviarWhatsApp(clienteSeleccionado, mensaje);
                                                    }}
                                                    className="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition">
                                                    ğŸ“± Enviar WhatsApp
                                                </button>
                                                <button
                                                    onClick={() => setMostrarPerfilCliente(false)}
                                                    className="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-xl font-bold hover:from-orange-600 hover:to-orange-700 transition">
                                                    Cerrar Perfil
                                                </button>
                                            </div>

                                        </>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                    {/* Modal de atajos de teclado */}
                    {showKeyboardShortcuts && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowKeyboardShortcuts(false)}>
                            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-2xl max-w-2xl w-full scale-in`} onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold flex items-center gap-2">
                                        <span>âŒ¨ï¸</span> Atajos de Teclado
                                    </h3>
                                    <button onClick={() => setShowKeyboardShortcuts(false)} className="text-3xl hover:text-red-500 transition">Ã—</button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Ir a Ventas</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Alt + V</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Ir a Clientes</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Alt + C</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Ir a Dashboard</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Alt + D</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Ir a Resumen</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Alt + R</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Calculadora</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Alt + K</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Generar ECXEL</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Alt + E</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Buscar Cliente</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">/</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Cerrar Modales</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Esc</kbd>
                                        </div>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-xl md:col-span-2`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-semibold">Ver Atajos</span>
                                            <kbd className="px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm font-mono">Shift + ?</kbd>
                                        </div>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setShowKeyboardShortcuts(false)}
                                    className="w-full mt-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-xl font-bold hover:from-orange-600 hover:to-orange-700 transition">
                                    Entendido
                                </button>
                            </div>
                        </div>
                    )}
                    {/* Loading Overlay */}
                    {isLoading && (
                        <div className="loading-overlay">
                            <div className="text-center">
                                <div className="spinner inline-block w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full"></div>
                                <p className="text-white text-xl font-bold mt-4">Calentando el carbÃ³n...</p>
                            </div>
                        </div>
                    )}
                    {/* Calculadora RÃ¡pida */}
                    {showCalculadora && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowCalculadora(false)}>
                            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-4 md:p-8 rounded-2xl shadow-2xl max-w-xs md:max-w-md w-full scale-in max-h-[85vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl md:text-2xl font-bold flex items-center gap-2">
                                        <span>ğŸ§®</span> Calculadora
                                    </h3>
                                    <div className="flex gap-2 items-center">
                                        <button
                                            onClick={() => {
                                                setShowCalculadora(false);
                                                setMostrarConfigPrecios(true);
                                            }}
                                            className="p-2 bg-purple-100 hover:bg-purple-200 rounded-lg transition text-sm"
                                            title="Configurar precios">
                                            âš™ï¸
                                        </button>
                                        <button onClick={() => setShowCalculadora(false)} className="text-3xl hover:text-red-500 transition">Ã—</button>
                                    </div>
                                </div>

                                {/* Selector de modo */}
                                <div className="grid grid-cols-3 gap-2 mb-4">
                                    <button
                                        onClick={() => {
                                            setModoCalculadora('conversion');
                                            setCalcUnidades('');
                                            setCalcResultado(null);
                                        }}
                                        className={`p-2 md:p-3 rounded-lg font-bold transition text-xs md:text-sm ${modoCalculadora === 'conversion'
                                            ? 'bg-blue-600 text-white'
                                            : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                                            }`}>
                                        ğŸŒ½â†’ğŸ“¦
                                    </button>
                                    <button
                                        onClick={() => {
                                            setModoCalculadora('inversa');
                                            setCalcUnidades('');
                                            setCalcResultado(null);
                                        }}
                                        className={`p-2 md:p-3 rounded-lg font-bold transition text-xs md:text-sm ${modoCalculadora === 'inversa'
                                            ? 'bg-purple-600 text-white'
                                            : 'bg-purple-100 text-purple-700 hover:bg-purple-200'
                                            }`}>
                                        ğŸ“¦â†’ğŸŒ½
                                    </button>
                                    <button
                                        onClick={() => {
                                            setModoCalculadora('normal');
                                            setCalcInput1('');
                                            setCalcInput2('');
                                            setCalcResultado(null);
                                        }}
                                        className={`p-2 md:p-3 rounded-lg font-bold transition text-xs md:text-sm ${modoCalculadora === 'normal'
                                            ? 'bg-green-600 text-white'
                                            : 'bg-green-100 text-green-700 hover:bg-green-200'
                                            }`}>
                                        â•â–âœ–ï¸â—
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    {/* MODO: Unidades â†’ Paquetes */}
                                    {modoCalculadora === 'conversion' && (
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-blue-50 to-blue-100'} p-3 md:p-6 rounded-xl border-2 border-blue-300`}>
                                            <h4 className="font-bold text-blue-700 mb-2 text-sm md:text-base">ğŸŒ½ Unidades â†’ Paquetes</h4>
                                            <input
                                                type="number"
                                                value={calcUnidades}
                                                onChange={(e) => setCalcUnidades(e.target.value)}
                                                placeholder="Ingresa unidades"
                                                className="w-full p-3 md:p-4 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-base md:text-lg font-bold text-center mb-3"
                                            />
                                            {calcUnidades && (
                                                <div className="space-y-2 fade-in">
                                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 md:p-4 rounded-lg`}>
                                                        <p className="text-xs md:text-sm text-gray-600">Paquetes completos</p>
                                                        <p className="text-2xl md:text-3xl font-bold text-purple-600">{Math.floor(parseInt(calcUnidades) / 10)}</p>
                                                    </div>
                                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 md:p-4 rounded-lg`}>
                                                        <p className="text-xs md:text-sm text-gray-600">Unidades sueltas</p>
                                                        <p className="text-2xl md:text-3xl font-bold text-orange-600">{parseInt(calcUnidades) % 10}</p>
                                                    </div>
                                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 md:p-4 rounded-lg`}>
                                                        <p className="text-xs md:text-sm text-gray-600">Total a cobrar</p>
                                                        <p className="text-xl md:text-2xl font-bold text-green-600">{formatCOP(parseInt(calcUnidades) * precioUnidad)}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* MODO: Paquetes â†’ Unidades */}
                                    {/* MODO: Paquetes â†’ Unidades */}
                                    {modoCalculadora === 'inversa' && (
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-purple-50 to-purple-100'} p-3 md:p-6 rounded-xl border-2 border-purple-300`}>
                                            <h4 className="font-bold text-purple-700 mb-2 text-sm md:text-base">ğŸ“¦ Paquetes â†’ Unidades</h4>
                                            <input
                                                type="number"
                                                value={calcUnidades}
                                                onChange={(e) => setCalcUnidades(e.target.value)}
                                                placeholder="Ingresa paquetes"
                                                className="w-full p-3 md:p-4 border-2 border-purple-300 rounded-xl focus:ring-2 focus:ring-purple-500 text-base md:text-lg font-bold text-center mb-3"
                                            />
                                            {calcUnidades && (
                                                <div className="fade-in space-y-2">
                                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 md:p-4 rounded-lg`}>
                                                        <p className="text-xs md:text-sm text-gray-600">Total unidades</p>
                                                        <p className="text-2xl md:text-3xl font-bold text-blue-600">{parseInt(calcUnidades) * 10}</p>
                                                    </div>
                                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 md:p-4 rounded-lg`}>
                                                        <p className="text-xs md:text-sm text-gray-600">Total a cobrar</p>
                                                        <p className="text-xl md:text-2xl font-bold text-green-600">{formatCOP(parseInt(calcUnidades) * precioPaquete)}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* MODO: Calculadora Normal */}
                                    {modoCalculadora === 'normal' && (
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-green-50 to-green-100'} p-3 md:p-6 rounded-xl border-2 border-green-300`}>
                                            <h4 className="font-bold text-green-700 mb-3 text-sm md:text-base">ğŸ”¢ Calculadora</h4>
                                            <div className="space-y-3">
                                                <input
                                                    type="number"
                                                    value={calcInput1}
                                                    onChange={(e) => setCalcInput1(e.target.value)}
                                                    placeholder="Primer nÃºmero"
                                                    className="w-full p-3 border-2 border-green-300 rounded-xl focus:ring-2 focus:ring-green-500 text-center font-bold"
                                                />

                                                <div className="grid grid-cols-4 gap-2">
                                                    {['+', '-', 'Ã—', 'Ã·'].map(op => (
                                                        <button
                                                            key={op}
                                                            onClick={() => setCalcOperacion(op)}
                                                            className={`p-3 rounded-lg font-bold text-xl transition ${calcOperacion === op
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white hover:bg-green-100'
                                                                }`}>
                                                            {op}
                                                        </button>
                                                    ))}
                                                </div>

                                                <input
                                                    type="number"
                                                    value={calcInput2}
                                                    onChange={(e) => setCalcInput2(e.target.value)}
                                                    placeholder="Segundo nÃºmero"
                                                    className="w-full p-3 border-2 border-green-300 rounded-xl focus:ring-2 focus:ring-green-500 text-center font-bold"
                                                />

                                                <button
                                                    onClick={() => {
                                                        const n1 = parseFloat(calcInput1) || 0;
                                                        const n2 = parseFloat(calcInput2) || 0;
                                                        let resultado = 0;

                                                        switch (calcOperacion) {
                                                            case '+': resultado = n1 + n2; break;
                                                            case '-': resultado = n1 - n2; break;
                                                            case 'Ã—': resultado = n1 * n2; break;
                                                            case 'Ã·': resultado = n2 !== 0 ? n1 / n2 : 'Error'; break;
                                                        }

                                                        setCalcResultado(resultado);
                                                    }}
                                                    className="w-full bg-green-600 text-white p-4 rounded-xl font-bold hover:bg-green-700 transition">
                                                    = Calcular
                                                </button>

                                                {calcResultado !== null && (
                                                    <div className="bg-white p-4 rounded-xl border-2 border-green-400 fade-in">
                                                        <p className="text-sm text-gray-600 text-center">Resultado</p>
                                                        <p className="text-3xl font-bold text-green-600 text-center">{calcResultado}</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    <button
                                        onClick={() => {
                                            setCalcUnidades('');
                                            setCalcInput1('');
                                            setCalcInput2('');
                                            setCalcResultado(null);
                                            setShowCalculadora(false);
                                        }}
                                        className="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-xl font-bold hover:from-orange-600 hover:to-orange-700 transition">
                                        Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Modal ConfiguraciÃ³n de Precios */}
                    {mostrarConfigPrecios && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setMostrarConfigPrecios(false)}>
                            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-2xl max-w-md w-full scale-in`} onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold flex items-center gap-2">
                                        <span>ğŸ’°</span> Configurar Precios
                                    </h3>
                                    <button onClick={() => setMostrarConfigPrecios(false)} className="text-3xl hover:text-red-500 transition">Ã—</button>
                                </div>

                                <div className="space-y-6">
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-blue-50'} p-6 rounded-xl border-2 border-blue-300`}>
                                        <label className="block font-bold text-blue-700 mb-3">ğŸŒ½ Precio por Unidad</label>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-2xl">$</span>
                                            <input
                                                type="number"
                                                value={precioUnidad}
                                                onChange={(e) => setPrecioUnidad(parseFloat(e.target.value) || 0)}
                                                className="flex-1 p-4 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-2xl font-bold text-center"
                                            />
                                        </div>
                                        <p className="text-sm text-gray-600 mt-2">Este serÃ¡ el precio sugerido para ventas individuales</p>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-purple-50'} p-6 rounded-xl border-2 border-purple-300`}>
                                        <label className="block font-bold text-purple-700 mb-3">ğŸ“¦ Precio por Paquete (10 unidades)</label>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-2xl">$</span>
                                            <input
                                                type="number"
                                                value={precioPaquete}
                                                onChange={(e) => setPrecioPaquete(parseFloat(e.target.value) || 0)}
                                                className="flex-1 p-4 border-2 border-purple-300 rounded-xl focus:ring-2 focus:ring-purple-500 text-2xl font-bold text-center"
                                            />
                                        </div>
                                        <p className="text-sm text-gray-600 mt-2">Este serÃ¡ el precio sugerido para paquetes de 10</p>
                                        <p className="text-xs text-purple-600 mt-1 font-semibold">
                                            Precio por unidad en paquete: {formatCOP(precioPaquete / 10)}
                                        </p>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-green-50'} p-4 rounded-xl border-2 border-green-300`}>
                                        <p className="text-sm text-green-700 font-semibold">ğŸ’¡ Ejemplo de uso:</p>
                                        <ul className="text-sm text-gray-700 mt-2 space-y-1">
                                            <li>â€¢ 5 unidades = {formatCOP(precioUnidad * 5)}</li>
                                            <li>â€¢ 3 paquetes = {formatCOP(precioPaquete * 3)}</li>
                                            <li>â€¢ 1 paquete + 5 unidades = {formatCOP(precioPaquete + (precioUnidad * 5))}</li>
                                        </ul>
                                    </div>

                                    <button
                                        onClick={() => setMostrarConfigPrecios(false)}
                                        className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition shadow-lg">
                                        âœ… Guardar ConfiguraciÃ³n
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Modal Generar Excel */}
                    {mostrarModalExcel && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setMostrarModalExcel(false)}>
                            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-8 rounded-2xl shadow-2xl max-w-md w-full scale-in`} onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold flex items-center gap-2">
                                        <span>ğŸ“Š</span> Generar Reporte Excel
                                    </h3>
                                    <button onClick={() => setMostrarModalExcel(false)} className="text-3xl hover:text-red-500 transition">Ã—</button>
                                </div>

                                <div className="space-y-4">
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-blue-50'} p-6 rounded-xl border-2 border-blue-300`}>
                                        <p className="text-sm text-blue-700 mb-4 font-semibold">
                                            ğŸ“… Selecciona el rango de fechas para el reporte
                                        </p>
                                        <p className="text-xs text-gray-600 mb-4">
                                            Se generarÃ¡ una comparaciÃ³n automÃ¡tica con el mes anterior
                                        </p>

                                        <div className="space-y-3">
                                            <div>
                                                <label className="block text-sm font-semibold mb-2">Desde:</label>
                                                <input
                                                    type="date"
                                                    value={fechaDesdeExcel}
                                                    onChange={(e) => setFechaDesdeExcel(e.target.value)}
                                                    className="w-full p-3 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-semibold mb-2">Hasta:</label>
                                                <input
                                                    type="date"
                                                    value={fechaHastaExcel}
                                                    onChange={(e) => setFechaHastaExcel(e.target.value)}
                                                    className="w-full p-3 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500"
                                                />
                                            </div>
                                        </div>

                                        {fechaDesdeExcel && fechaHastaExcel && (
                                            <div className="mt-4 p-3 bg-green-100 rounded-lg">
                                                <p className="text-xs text-green-700 font-semibold">
                                                    âœ… Se compararÃ¡ con el perÃ­odo anterior:
                                                </p>
                                                <p className="text-xs text-green-600 mt-1">
                                                    {(() => {
                                                        const desde = new Date(fechaDesdeExcel);
                                                        const hasta = new Date(fechaHastaExcel);
                                                        const anteriorDesde = new Date(desde);
                                                        anteriorDesde.setMonth(anteriorDesde.getMonth() - 1);
                                                        const anteriorHasta = new Date(hasta);
                                                        anteriorHasta.setMonth(anteriorHasta.getMonth() - 1);
                                                        return `${anteriorDesde.toLocaleDateString('es-CO')} - ${anteriorHasta.toLocaleDateString('es-CO')}`;
                                                    })()}
                                                </p>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex gap-2">
                                        <button
                                            onClick={generarReporteExcel}
                                            disabled={!fechaDesdeExcel || !fechaHastaExcel}
                                            className="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                            ğŸ“¥ Descargar Excel
                                        </button>
                                        <button
                                            onClick={() => setMostrarModalExcel(false)}
                                            className="px-6 bg-gray-400 text-white py-4 rounded-xl font-bold hover:bg-gray-500 transition">
                                            âŒ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* BotÃ³n Volver Arriba */}
                    <button
                        onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                        className="fixed bottom-6 right-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-full shadow-2xl hover:from-orange-600 hover:to-orange-700 transition z-40 pulse-hover"
                        title="Volver arriba">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </button>
                    {/* Modal personalizado para confirmaciones y prompts */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowModal(false)}>
                            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} p-6 rounded-2xl shadow-2xl max-w-md w-full scale-in`} onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    {modalConfig.type === 'confirm' && <span>âš ï¸</span>}
                                    {modalConfig.type === 'prompt' && <span>âœï¸</span>}
                                    {modalConfig.type === 'success' && <span>âœ…</span>}
                                    {modalConfig.type === 'info' && <span>â„¹ï¸</span>}
                                    {modalConfig.title}
                                </h3>

                                <p className={`mb-6 ${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-line`}>
                                    {modalConfig.message}
                                </p>

                                {modalConfig.type === 'prompt' && (
                                    <input
                                        type="text"
                                        value={modalConfig.inputValue}
                                        onChange={(e) => setModalConfig({ ...modalConfig, inputValue: e.target.value })}
                                        placeholder={modalConfig.placeholder || ''}
                                        className={`w-full p-3 border-2 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-300'}`}
                                        autoFocus
                                    />
                                )}

                                <div className="flex gap-3">
                                    {modalConfig.type !== 'info' && (
                                        <>
                                            <button
                                                onClick={() => {
                                                    if (modalConfig.onConfirm) {
                                                        modalConfig.onConfirm(modalConfig.type === 'prompt' ? modalConfig.inputValue : true);
                                                    }
                                                    setShowModal(false);
                                                }}
                                                className="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition shadow-lg">
                                                {modalConfig.type === 'confirm' ? 'âœ… Confirmar' : 'ğŸ’¾ Guardar'}
                                            </button>
                                            <button
                                                onClick={() => {
                                                    if (modalConfig.onCancel) modalConfig.onCancel();
                                                    setShowModal(false);
                                                }}
                                                className={`flex-1 px-6 py-3 rounded-xl font-bold transition ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>
                                                âŒ Cancelar
                                            </button>
                                        </>
                                    )}
                                    {modalConfig.type === 'info' && (
                                        <button
                                            onClick={() => setShowModal(false)}
                                            className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:from-blue-600 hover:to-blue-700 transition">
                                            ğŸ‘ Entendido
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    <Toast toasts={toasts} remove={removeToast} />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>